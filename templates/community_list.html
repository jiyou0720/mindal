{% extends "base.html" %}

{% block title %}커뮤니티 - Mind AI{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_list.css') }}">
{% endblock %}

{% block page_title %}
    커뮤니티
{% endblock %}

{% block content %}
    <div class="community-container">
        <div class="community-header">
            <h1 class="community-title">커뮤니티</h1>
            <div class="header-actions">
                <select id="postTypeFilter" class="filter-select">
                    <option value="">전체 게시글</option>
                    <option value="자유 게시판">자유 게시판</option>
                    <option value="질문 게시판">질문 게시판</option>
                    <option value="정보 공유">정보 공유</option>
                    <option value="건의 사항">건의 사항</option>
                </select>
                <input type="text" id="searchInput" class="search-input" placeholder="제목 검색...">
                <button id="searchButton" class="button secondary small"><i class="fas fa-search"></i> 검색</button>
                <a href="{{ url_for('community_create') }}" class="button primary small">
                    <i class="fas fa-plus-circle"></i> 새 게시글
                </a>
            </div>
        </div>

        <p class="community-subtitle">다양한 주제에 대해 이야기하고, 서로의 경험을 공유하며 소통해 보세요.</p>

        <div class="community-table-container">
            <table class="community-table">
                <thead>
                    <tr>
                        <th class="col-category">카테고리</th>
                        <th class="col-title">제목</th>
                        <th class="col-author">작성자</th>
                        <th class="col-views">조회수</th>
                        <th class="col-likes">좋아요</th>
                        <th class="col-comments">댓글</th>
                        <th class="col-date">작성일</th>
                    </tr>
                </thead>
                <tbody id="postList">
                    {# 게시글 목록이 여기에 동적으로 로드됩니다 #}
                </tbody>
            </table>
            <p id="noPostsMessage" style="text-align: center; color: #777; padding: 20px; display: none;">게시글이 없습니다.</p>
        </div>

        <div class="pagination" id="pagination">
            {# 페이지네이션 버튼이 여기에 동적으로 로드됩니다 #}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postList = document.getElementById('postList');
            const paginationContainer = document.getElementById('pagination');
            const postTypeFilter = document.getElementById('postTypeFilter');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const noPostsMessage = document.getElementById('noPostsMessage');

            let currentPage = 1;

            async function fetchPosts(page = 1, categoryFilter = '', searchQuery = '') {
                try {
                    const url = `/api/community/posts?page=${page}&per_page=25&category_filter=${encodeURIComponent(categoryFilter)}&search_query=${encodeURIComponent(searchQuery)}`;
                    const response = await fetchWithAuth(url);

                    if (response === undefined || response === null) {
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        postList.innerHTML = '';
                        noPostsMessage.style.display = 'block';
                        paginationContainer.innerHTML = '';
                        return;
                    }

                    const data = await response.json();
                    const posts = data.posts;
                    const totalPages = data.total_pages;
                    currentPage = data.current_page;

                    postList.innerHTML = '';

                    if (posts.length === 0) {
                        noPostsMessage.style.display = 'block';
                    } else {
                        noPostsMessage.style.display = 'none';
                        posts.forEach(post => {
                            const row = document.createElement('tr');
                            row.classList.add('post-row');
                            const detailUrl = `/community/${post.id}`;
                            row.onclick = () => {
                                window.location.href = detailUrl;
                            };
                            
                            const displayCategory = post.category || '카테고리 없음';
                            const displayTitle = post.title || '제목 없음';
                            const displayViews = post.views !== undefined ? post.views : 0;
                            const displayLikes = post.likes !== undefined ? post.likes : 0;
                            const displayCommentCount = post.comment_count !== undefined ? post.comment_count : 0;
                            const displayCreatedAt = post.created_at ? new Date(post.created_at).toLocaleDateString() : '날짜 없음';

                            let authorDisplay = '';
                            if (post.is_anonymous) {
                                authorDisplay = '익명';
                            } else {
                                const authorNickname = post.author_nickname || '알 수 없음';
                                const authorUid = post.author_uid || '';
                                authorDisplay = `${authorNickname} (${authorUid})`;
                            }

                            row.innerHTML = `
                                <td class="col-category">${displayCategory}</td>
                                <td class="col-title"><a href="${detailUrl}" class="post-link">${displayTitle}</a></td>
                                <td class="col-author">${authorDisplay}</td>
                                <td class="col-views">${displayViews}</td>
                                <td class="col-likes">${displayLikes}</td>
                                <td class="col-comments">${displayCommentCount}</td>
                                <td class="col-date">${displayCreatedAt}</td>
                            `;
                            postList.appendChild(row);
                        });
                    }
                    renderPagination(totalPages);

                } catch (error) {
                    console.error('Error fetching posts:', error);
                    postList.innerHTML = '';
                    noPostsMessage.style.display = 'block';
                    paginationContainer.innerHTML = '';
                }
            }

            function renderPagination(totalPages) {
                paginationContainer.innerHTML = '';

                if (totalPages > 1) {
                    const prevButton = document.createElement('button');
                    prevButton.classList.add('page-button');
                    prevButton.textContent = '이전';
                    prevButton.disabled = currentPage === 1;
                    prevButton.addEventListener('click', () => {
                        if (currentPage > 1) {
                            fetchPosts(currentPage - 1, postTypeFilter.value, searchInput.value);
                        }
                    });
                    paginationContainer.appendChild(prevButton);

                    const maxPageButtons = 5;
                    let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                    let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

                    if (endPage - startPage + 1 < maxPageButtons) {
                        startPage = Math.max(1, endPage - maxPageButtons + 1);
                    }
                    
                    if (startPage > 1) {
                        const firstPageButton = document.createElement('button');
                        firstPageButton.classList.add('page-button');
                        firstPageButton.textContent = '1';
                        firstPageButton.addEventListener('click', () => {
                            fetchPosts(1, postTypeFilter.value, searchInput.value);
                        });
                        paginationContainer.appendChild(firstPageButton);
                        if (startPage > 2) {
                            const ellipsis = document.createElement('span');
                            ellipsis.textContent = '...';
                            ellipsis.classList.add('ellipsis');
                            paginationContainer.appendChild(ellipsis);
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        const pageButton = document.createElement('button');
                        pageButton.classList.add('page-button');
                        if (i === currentPage) {
                            pageButton.classList.add('active');
                        }
                        pageButton.textContent = i;
                        pageButton.addEventListener('click', () => {
                            fetchPosts(i, postTypeFilter.value, searchInput.value);
                        });
                        paginationContainer.appendChild(pageButton);
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            const ellipsis = document.createElement('span');
                            ellipsis.textContent = '...';
                            ellipsis.classList.add('ellipsis');
                            paginationContainer.appendChild(ellipsis);
                        }
                        const lastPageButton = document.createElement('button');
                        lastPageButton.classList.add('page-button');
                        lastPageButton.textContent = totalPages;
                        lastPageButton.addEventListener('click', () => {
                            fetchPosts(totalPages, postTypeFilter.value, searchInput.value);
                        });
                        paginationContainer.appendChild(lastPageButton);
                    }

                    const nextButton = document.createElement('button');
                    nextButton.classList.add('page-button');
                    nextButton.textContent = '다음';
                    nextButton.disabled = currentPage === totalPages;
                    nextButton.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            fetchPosts(currentPage + 1, postTypeFilter.value, searchInput.value);
                        }
                    });
                    paginationContainer.appendChild(nextButton);
                }
            }

            postTypeFilter.addEventListener('change', () => fetchPosts(1, postTypeFilter.value, searchInput.value));
            searchButton.addEventListener('click', () => fetchPosts(1, postTypeFilter.value, searchInput.value));
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    fetchPosts(1, postTypeFilter.value, searchInput.value);
                }
            });

            fetchPosts();
        });
    </script>
{% endblock %}
