<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Mindbridge{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Alert/Confirm Modal Styles (Moved to head for proper loading) -->
    <style>
        /* Modal Basic Styles */
        .modal {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: #FFFFFF;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            position: relative;
            text-align: center;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .close-button {
            color: #AAB7C4;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #34495E;
        }

        #modalMessage {
            font-size: 1.1em;
            color: #4D4D4D;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Reusing .button styles from base.css or defining here if not available */
        .button {
            padding: 10px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .button.primary {
            background-color: #007bff;
            color: white;
            border: none;
        }

        .button.primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .button.secondary {
            background-color: #F0F4F8;
            color: #5A6B7F;
            border: 1px solid #DCE4EC;
        }

        .button.secondary:hover {
            background-color: #E0E6ED;
            color: #2C3E50;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Custom Alert/Confirm Modal -->
    <div id="customModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeModalButton">&times;</span>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmButton" class="button primary hidden">í™•ì¸</button>
                <button id="modalCancelButton" class="button secondary hidden">ì·¨ì†Œ</button>
                <button id="modalAlertButton" class="button primary hidden">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <a href="{{ url_for('index') }}" class="header-logo-link">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mindbridge Logo" class="header-logo">
                </a>
            </div>
            <div class="header-right" id="authArea">
                <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤ -->
                <!-- ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ í…ìŠ¤íŠ¸ê°€ ë³´ì´ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€ -->
                <a href="{{ url_for('login') }}" class="header-auth-button secondary" id="loginButton">ë¡œê·¸ì¸</a>
                <a href="{{ url_for('signup') }}" class="header-auth-button primary" id="signupButton">íšŒì›ê°€ì…</a>
                <!-- ë¡œê·¸ì¸ ì‹œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ìš”ì†Œë“¤ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
                <span class="user-display-name" id="userDisplayName" style="display: none;"></span>
                <button class="header-auth-button secondary" id="logoutButton" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div class="main-layout-wrapper">
            <aside class="sidebar" id="sidebar">
                <nav class="sidebar-nav">
                    <ul class="sidebar-menu" id="sidebarMenu">
                        <!-- ë©”ë‰´ ì•„ì´í…œì€ JavaScriptë¥¼ í†µí•´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                    </ul>
                </nav>
            </aside>

            <main class="main-content-area">
                {% block content %}{% endblock %}
            </main>
        </div>

        <footer class="footer">
            <div class="footer-section footer-info">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mindbridge Logo" class="footer-logo">
                <h3>Mindbridge</h3>
                <p>ë§ˆìŒê³¼ ë§ˆìŒì„ ì‡ëŠ” ë‹¤ë¦¬, Mindbridgeì…ë‹ˆë‹¤.</p>
                <p>ë¬¸ì˜: support@mindbridge.com</p>
            </div>
            <div class="footer-section footer-social">
                <h4>Connect With Us</h4>
                <div class="social-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ URL ì •ì˜ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥)
        const loginUrl = "{{ url_for('login') }}";
        const signupUrl = "{{ url_for('signup') }}";
        const indexUrl = "{{ url_for('index') }}";
        const homeUrl = "{{ url_for('index') }}"; // homeUrlë„ indexUrlê³¼ ë™ì¼í•˜ê²Œ ì •ì˜

        // Custom Modal Elements (DOMì´ ë¡œë“œë˜ê¸° ì „ì—ëŠ” nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, í•¨ìˆ˜ ë‚´ì—ì„œ ì°¸ì¡°)
        let customModal, closeModalButton, modalMessage, modalConfirmButton, modalCancelButton, modalAlertButton;

        let confirmResolve = null; // Promise resolve function for confirm

        // Function to show custom alert
        function showAlert(message) {
            return new Promise(resolve => {
                // DOM ìš”ì†Œê°€ ë¡œë“œëœ í›„ì—ë§Œ ì ‘ê·¼
                if (!customModal) {
                    customModal = document.getElementById('customModal');
                    closeModalButton = document.getElementById('closeModalButton');
                    modalMessage = document.getElementById('modalMessage');
                    modalConfirmButton = document.getElementById('modalConfirmButton');
                    modalCancelButton = document.getElementById('modalCancelButton');
                    modalAlertButton = document.getElementById('modalAlertButton');
                }

                modalMessage.textContent = message;
                modalConfirmButton.classList.add('hidden');
                modalCancelButton.classList.add('hidden');
                modalAlertButton.classList.remove('hidden');
                customModal.classList.remove('hidden');

                const handler = () => {
                    customModal.classList.add('hidden');
                    modalAlertButton.removeEventListener('click', handler);
                    closeModalButton.removeEventListener('click', handler);
                    resolve(true); // Always resolve true for alert
                };

                modalAlertButton.addEventListener('click', handler);
                closeModalButton.addEventListener('click', handler);
            });
        }

        // Function to show custom confirm
        function showConfirm(message) {
            return new Promise(resolve => {
                // DOM ìš”ì†Œê°€ ë¡œë“œëœ í›„ì—ì•¼ ì ‘ê·¼
                if (!customModal) {
                    customModal = document.getElementById('customModal');
                    closeModalButton = document.getElementById('closeModalButton');
                    modalMessage = document.getElementById('modalMessage');
                    modalConfirmButton = document.getElementById('modalConfirmButton');
                    modalCancelButton = document.getElementById('modalCancelButton');
                    modalAlertButton = document.getElementById('modalAlertButton');
                }

                modalMessage.textContent = message;
                modalConfirmButton.classList.remove('hidden');
                modalCancelButton.classList.remove('hidden');
                modalAlertButton.classList.add('hidden');
                customModal.classList.remove('hidden');

                confirmResolve = resolve; // Store resolve function

                const confirmHandler = () => {
                    customModal.classList.add('hidden');
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    modalCancelButton.removeEventListener('click', cancelHandler);
                    closeModalButton.removeEventListener('click', cancelHandler); // Close button acts as cancel
                    confirmResolve(true);
                };

                const cancelHandler = () => {
                    customModal.classList.add('hidden');
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    modalCancelButton.removeEventListener('click', cancelHandler);
                    closeModalButton.removeEventListener('click', cancelHandler);
                    confirmResolve(false);
                };

                modalConfirmButton.addEventListener('click', confirmHandler);
                modalCancelButton.addEventListener('click', cancelHandler);
                closeModalButton.addEventListener('click', cancelHandler); // Close button also cancels
            });
        }


        // JWT í† í°ì´ í•„ìš”í•œ API ìš”ì²­ì„ ìœ„í•œ ë˜í¼ í•¨ìˆ˜
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('jwt_token');
            const headers = {
                ...options.headers,
            };

            // FormData ì¸ìŠ¤í„´ìŠ¤ì¸ì§€ í™•ì¸
            const isFormData = options.body instanceof FormData;

            // FormDataê°€ ì•„ë‹ ê²½ìš°ì—ë§Œ Content-Typeì„ 'application/json'ìœ¼ë¡œ ì„¤ì •
            if (!isFormData && !headers['Content-Type']) { // ì´ë¯¸ Content-Typeì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ
                headers['Content-Type'] = 'application/json';
            }

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            } else {
                console.warn("fetchWithAuth: Token is missing for URL:", url);
            }

            // GET ìš”ì²­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ bodyë¥¼ JSON.stringify
            // FormDataëŠ” stringifyí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            if (options.body && !isFormData && typeof options.body !== 'string') {
                options.body = JSON.stringify(options.body);
            }

            try {
                const response = await fetch(url, { ...options, headers: headers });

                // 401 Unauthorized ì‘ë‹µ ì²˜ë¦¬
                if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('user_uid');
                    localStorage.removeItem('nickname');
                    localStorage.removeItem('username');
                    localStorage.removeItem('user_roles');
                    localStorage.removeItem('cached_menu_items');
                    await showAlert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = loginUrl;
                    throw new Error('Unauthorized'); 
                }

                return response;
            } catch (error) {
                console.error("Network or fetch error:", error);
                await showAlert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                throw error;
            }
        }

        let menuRendered = false; // ë©”ë‰´ ì¤‘ë³µ ë Œë”ë§ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸

        document.addEventListener('DOMContentLoaded', function() {
            const authArea = document.getElementById('authArea');
            const sidebarMenu = document.getElementById('sidebarMenu');
            
            // í—¤ë”ì˜ ì´ˆê¸° ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const loginButtonElement = document.getElementById('loginButton');
            const signupButtonElement = document.getElementById('signupButton');
            // ë¡œê·¸ì¸ ì‹œ ë™ì ìœ¼ë¡œ í‘œì‹œë  ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸° (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
            const userDisplayNameElement = document.getElementById('userDisplayName');
            const logoutButtonElement = document.getElementById('logoutButton');


            // í—¤ë” UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateHeaderUI() {
                const token = localStorage.getItem('jwt_token');
                const nickname = localStorage.getItem('nickname'); // ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
                const username = localStorage.getItem('username'); // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë‹‰ë„¤ì„ ì—†ì„ ë•Œ ëŒ€ë¹„)

                if (token && (nickname || username)) { // í† í°ì´ ìˆê³  ë‹‰ë„¤ì„ ë˜ëŠ” ì‚¬ìš©ì ì´ë¦„ì´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ ìƒíƒœ
                    const displayName = nickname || username; 
                    
                    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    if (loginButtonElement) loginButtonElement.style.display = 'none';
                    if (signupButtonElement) signupButtonElement.style.display = 'none';

                    // ì‚¬ìš©ì ì´ë¦„ ë° ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
                    if (userDisplayNameElement) {
                        userDisplayNameElement.textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${displayName}ë‹˜!`;
                        userDisplayNameElement.style.display = 'inline-block'; // spanì€ inline-blockìœ¼ë¡œ í‘œì‹œ
                    }
                    if (logoutButtonElement) {
                        logoutButtonElement.style.display = 'inline-block'; // buttonì€ inline-blockìœ¼ë¡œ í‘œì‹œ
                    }

                    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆë‹¤ë©´ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€)
                    if (logoutButtonElement && !logoutButtonElement.dataset.listenerAdded) {
                        logoutButtonElement.addEventListener('click', async function() { // async ì¶”ê°€
                            localStorage.removeItem('jwt_token');
                            localStorage.removeItem('user_id');
                            localStorage.removeItem('user_uid');
                            localStorage.removeItem('nickname');
                            localStorage.removeItem('username');
                            localStorage.removeItem('user_roles');
                            localStorage.removeItem('cached_menu_items');
                            updateHeaderUI(); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                            renderSidebarMenu(); // ë©”ë‰´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                            // await showAlert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.'); // ë¡œê·¸ì•„ì›ƒ ì‹œì—ë„ ëª¨ë‹¬ ì‚¬ìš©
                            window.location.href = indexUrl; // ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        });
                        logoutButtonElement.dataset.listenerAdded = 'true'; // ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ í”Œë˜ê·¸
                    }

                } else { // ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ í‘œì‹œ
                    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ í‘œì‹œ
                    if (loginButtonElement) loginButtonElement.style.display = 'inline-block';
                    if (signupButtonElement) signupButtonElement.style.display = 'inline-block';

                    // ì‚¬ìš©ì ì´ë¦„ ë° ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    if (userDisplayNameElement) userDisplayNameElement.style.display = 'none';
                    if (logoutButtonElement) logoutButtonElement.style.display = 'none';
                }
            }

            async function renderSidebarMenu() {
    if (menuRendered) {
        console.log("ë©”ë‰´ê°€ ì´ë¯¸ ë Œë”ë§ë˜ì—ˆìŠµë‹ˆë‹¤. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€.");
        return;
    }
    menuRendered = true;

    const token = localStorage.getItem('jwt_token'); // ì¤‘ìš”: ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸
    const userRolesString = localStorage.getItem('user_roles');
    let userRoles = [];

    if (userRolesString) {
        try {
            userRoles = JSON.parse(userRolesString);
        } catch (e) {
            console.error("user_roles JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        }
    }

    const sidebarMenu = document.getElementById('sidebarMenu');
    sidebarMenu.innerHTML = ''; // ê¸°ì¡´ ë©”ë‰´ ì´ˆê¸°í™”

    let menuItems = [];
    const cachedMenuItems = localStorage.getItem('cached_menu_items');

    if (cachedMenuItems) {
        try {
            menuItems = JSON.parse(cachedMenuItems);
            console.log("âœ… ë©”ë‰´ ìºì‹œì—ì„œ ë¡œë“œ ì™„ë£Œ.");
        } catch (e) {
            console.error("âŒ ë©”ë‰´ ìºì‹œ íŒŒì‹± ì˜¤ë¥˜:", e);
            localStorage.removeItem('cached_menu_items');
        }
    }

    // ì„œë²„ APIì—ì„œ ë©”ë‰´ ê°€ì ¸ì˜¤ê¸° (ìºì‹œ ì—†ì„ ê²½ìš°)
    if (menuItems.length === 0) {
        try {
            const response = await fetchWithAuth('/api/admin/menu_configs');
            const result = await response.json();

            if (response.ok) {
                menuItems = result.menu_items;
                localStorage.setItem('cached_menu_items', JSON.stringify(menuItems));
                console.log("âœ… APIë¡œë¶€í„° ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ.");
            } else {
                console.warn("â— ë©”ë‰´ API ì˜¤ë¥˜:", result.message);
            }
        } catch (error) {
            console.error("âŒ ë©”ë‰´ API í˜¸ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
        }
    }

    // Flask ê²½ë¡œ ë§¤í•‘
    const flaskUrlMap = {
        'index': '{{ url_for("index") }}',
        'diary': '{{ url_for("diary") }}',
        'community_list': '{{ url_for("community_list") }}',
        'ai_chat': '{{ url_for("ai_chat") }}',
        'mypage': '{{ url_for("mypage") }}',
        'my_changes': '{{ url_for("my_changes") }}',
        'admin_dashboard': '{{ url_for("admin_dashboard") }}',
        'user_management': '{{ url_for("user_management") }}',
        'menu_management': '{{ url_for("menu_management") }}',
        'role_menu_assignment': '{{ url_for("role_menu_assignment") }}',
        'counseling': '{{ url_for("counseling") }}'
    };

    console.log("ğŸ” ë Œë”ë§í•  ë©”ë‰´ ê°œìˆ˜:", menuItems.length);
    console.log("ğŸ” ì‚¬ìš©ì ì—­í• :", userRoles);
    console.log("ğŸ” í† í° ì¡´ì¬ ì—¬ë¶€:", !!token);

    // ë©”ë‰´ ì •ë ¬ í›„ ë Œë”ë§
    menuItems.sort((a, b) => a.order - b.order);

    menuItems.forEach(item => {
        const isPublicMenu = item.required_roles.includes('ëª¨ë“  ì‚¬ìš©ì');
        const hasAccess = item.required_roles.some(role => userRoles.includes(role));
        const isAllowed = isPublicMenu || (token && hasAccess);

        console.log(`ğŸ§© ë©”ë‰´ '${item.name}' â†’ isPublic: ${isPublicMenu}, hasAccess: ${hasAccess}, ìµœì¢… isAllowed: ${isAllowed}`);

        if (isAllowed) {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = flaskUrlMap[item.path] || '#';
            link.className = 'sidebar-link';
            link.innerHTML = `<i class="${item.icon_class}"></i> <span>${item.name}</span>`;

            // í˜„ì¬ í˜ì´ì§€ ê²½ë¡œì™€ ë§¤ì¹­í•´ì„œ 'active' í´ë˜ìŠ¤ ë¶€ì—¬
            const currentPath = window.location.pathname;
            const linkPath = new URL(link.href, window.location.origin).pathname;

            if (
                currentPath === linkPath ||
                (currentPath.startsWith('/community/posts') && item.path === 'community_list') ||
                (currentPath.startsWith('/diary') && item.path === 'diary') ||
                (currentPath.startsWith('/ai-chat') && item.path === 'ai_chat') ||
                (currentPath.startsWith('/mypage') && item.path === 'mypage') ||
                (currentPath.startsWith('/my-changes') && item.path === 'my_changes') ||
                (currentPath.startsWith('/admin-dashboard') && item.path === 'admin_dashboard') ||
                (currentPath.startsWith('/user-management') && item.path === 'user_management') ||
                (currentPath.startsWith('/menu-management') && item.path === 'menu_management') ||
                (currentPath.startsWith('/role-menu-assignment') && item.path === 'role_menu_assignment') ||
                (currentPath.startsWith('/counseling') && item.path === 'counseling')
            ) {
                link.classList.add('active');
            }

            listItem.appendChild(link);
            sidebarMenu.appendChild(listItem);
        }
    });
}


            // ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ê¸°ë³¸ ë©”ë‰´ ë°˜í™˜
            function getDefaultMenuItems(isLoggedIn) {
                if (isLoggedIn) {
                    // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ê¸°ë³¸ ë©”ë‰´ (ì„œë²„ì—ì„œ ë©”ë‰´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì„ ë•Œ)
                    return [
                        { name: 'í™ˆ', path: 'index', icon_class: 'fas fa-home', required_roles: ['ëª¨ë“  ì‚¬ìš©ì'], order: 1 },
                        { name: 'ì˜¤ëŠ˜, ì¼ê¸°', path: 'diary', icon_class: 'fas fa-book', required_roles: ['ì¼ë°˜ ì‚¬ìš©ì', 'ê´€ë¦¬ì', 'ìš´ì˜ì', 'ì—ë””í„°', 'ê°œë°œì', 'ì—°êµ¬ì'], order: 2 },
                        { name: 'ì»¤ë®¤ë‹ˆí‹°', path: 'community_list', icon_class: 'fas fa-users', required_roles: ['ëª¨ë“  ì‚¬ìš©ì'], order: 3 },
                        { name: 'AI ì±—ë´‡', path: 'ai_chat', icon_class: 'fas fa-robot', required_roles: ['ì¼ë°˜ ì‚¬ìš©ì', 'ê´€ë¦¬ì', 'ìš´ì˜ì', 'ì—ë””í„°', 'ê°œë°œì', 'ì—°êµ¬ì'], order: 4 },
                        { name: 'ë§ˆì´í˜ì´ì§€', path: 'mypage', icon_class: 'fas fa-user', required_roles: ['ì¼ë°˜ ì‚¬ìš©ì', 'ê´€ë¦¬ì', 'ìš´ì˜ì', 'ì—ë””í„°', 'ê°œë°œì', 'ì—°êµ¬ì'], order: 5 },
                        { name: 'ë‚˜ì˜ ë³€í™”', path: 'my_changes', icon_class: 'fas fa-chart-line', required_roles: ['ì¼ë°˜ ì‚¬ìš©ì', 'ê´€ë¦¬ì', 'ìš´ì˜ì', 'ì—ë””í„°', 'ê°œë°œì', 'ì—°êµ¬ì'], order: 6 },
                        { name: 'ì˜¨ë¼ì¸ ìƒë‹´', path: 'counseling', icon_class: 'fas fa-comments', required_roles: ['ì¼ë°˜ ì‚¬ìš©ì', 'ê´€ë¦¬ì', 'ìš´ì˜ì', 'ì—ë””í„°', 'ê°œë°œì', 'ì—°êµ¬ì'], order: 7 },
                        { name: 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ', path: 'admin_dashboard', icon_class: 'fas fa-tachometer-alt', required_roles: ['ê´€ë¦¬ì'], order: 8 },
                        { name: 'ì‚¬ìš©ì ê´€ë¦¬', path: 'user_management', icon_class: 'fas fa-users-cog', required_roles: ['ê´€ë¦¬ì'], order: 9 },
                        { name: 'ë©”ë‰´ ê´€ë¦¬', path: 'menu_management', icon_class: 'fas fa-bars', required_roles: ['ê´€ë¦¬ì'], order: 10 },
                        { name: 'ê¶Œí•œë³„ ë©”ë‰´ ì„¤ì •', path: 'role_menu_assignment', icon_class: "fas fa-user-shield", required_roles: ['ê´€ë¦¬ì'], order: 11 }
                    ];
                } else {
                    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ê¸°ë³¸ ë©”ë‰´
                    return [
                        { name: 'í™ˆ', path: 'index', icon_class: 'fas fa-home', required_roles: ['ëª¨ë“  ì‚¬ìš©ì'], order: 1 },
                        { name: 'ì»¤ë®¤ë‹ˆí‹°', path: 'community_list', icon_class: 'fas fa-users', required_roles: ['ëª¨ë“  ì‚¬ìš©ì'], order: 2 }
                    ];
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ UI ì—…ë°ì´íŠ¸ ë° ë©”ë‰´ ë Œë”ë§
            updateHeaderUI();
            renderSidebarMenu(); // ì‚¬ì´ë“œë°” ë©”ë‰´ ë™ì  ë Œë”ë§ ì‹œì‘
        });
    </script>
</body>
</html>
