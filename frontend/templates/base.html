<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Mind AI{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    {% block head %}{% endblock %}
</head>
<body>
    <div class="container">
        {# PC/Laptop (768px 초과)에서만 보이는 사이드바 #}
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('index') }}">
                    <img src="{{ url_for('static', filename='images/main_logo.png') }}" alt="Mind AI 로고" class="logo">
                </a>
            </div>
            <nav class="sidebar-nav">
                <ul id="menu-items-container"></ul>
            </nav>
            <div class="sidebar-footer">
                <div id="auth-links"></div>
                <button id="darkModeToggle" class="dark-mode-toggle">
                    <i class="fas fa-moon"></i> <span>다크 모드</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            {# PC/Laptop (768px 초과)에서만 보이는 메인 헤더 #}
            <header class="main-header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-title-container">
                    <h1 class="header-title">{% block page_title %}대시보드{% endblock %}</h1>
                </div>
            </header>

            {# 모바일 (768px 이하)에서만 보이는 모바일 헤더 #}
            <header class="mobile-header">
                <button class="sidebar-toggle" id="mobileSidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="{{ url_for('index') }}" class="mobile-logo-link">
                    <img src="{{ url_for('static', filename='images/main_logo.png') }}" alt="Mind AI 로고" class="mobile-logo">
                </a>
                <div class="mobile-header-placeholder"></div>
            </header>

            {% block content %}{% endblock %}
        </main>

        <div class="mobile-sidebar-overlay"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('access_token');
            const menuContainer = document.getElementById('menu-items-container');
            const authLinksContainer = document.getElementById('auth-links');

            // UI 업데이트 함수
            function updateAuthUI() {
                const token = localStorage.getItem('access_token');
                if (token) {
                    // 로그인 상태
                    authLinksContainer.innerHTML = `
                        <a href="{{ url_for('my_page') }}" class="sidebar-link"><i class="fas fa-user-circle"></i> <span>마이페이지</span></a>
                        <a href="#" id="logout-button" class="sidebar-link"><i class="fas fa-sign-out-alt"></i> <span>로그아웃</span></a>
                    `;
                    document.getElementById('logout-button').addEventListener('click', handleLogout);
                } else {
                    // 로그아웃 상태
                    authLinksContainer.innerHTML = `
                        <a href="{{ url_for('login_page') }}" class="sidebar-link"><i class="fas fa-sign-in-alt"></i> <span>로그인</span></a>
                        <a href="{{ url_for('signup_page') }}" class="sidebar-link"><i class="fas fa-user-plus"></i> <span>회원가입</span></a>
                    `;
                }
            }

            // 로그아웃 처리 함수
            function handleLogout(e) {
                if(e) e.preventDefault();
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('nickname');
                localStorage.removeItem('role');
                updateAuthUI();
                // 메뉴도 다시 로드
                loadMenus();
                window.location.href = "{{ url_for('login_page') }}";
            }

            // 메뉴 로드 함수
            async function loadMenus() {
                try {
                    const response = await fetch('/api/menus');
                    if (!response.ok) throw new Error('메뉴 로딩 실패');
                    const menus = await response.json();

                    menuContainer.innerHTML = ''; // 기존 메뉴 초기화
                    menus.forEach(menu => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${menu.url}" class="sidebar-link"><i class="${menu.icon}"></i> <span>${menu.name}</span></a>`;
                        menuContainer.appendChild(li);
                    });
                } catch (error) {
                    console.error('메뉴 로딩 중 오류:', error);
                    menuContainer.innerHTML = '<li>메뉴를 불러올 수 없습니다.</li>';
                }
            }
            
            // 초기화
            updateAuthUI();
            loadMenus();

            // 다크 모드 토글
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                // 나중에 로컬 스토리지에 저장하는 로직 추가
            });

            // 사이드바 토글 로직
            const container = document.querySelector('.container');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            const mobileSidebarOverlay = document.querySelector('.mobile-sidebar-overlay');
            const sidebar = document.querySelector('.sidebar');

            const isMobile = () => window.innerWidth <= 768;

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    if (isMobile()) {
                        // 모바일: 사이드바 나타남/사라짐
                        container.classList.toggle('mobile-sidebar-open');
                        mobileSidebarOverlay.classList.toggle('visible');
                    } else {
                        // PC: 사이드바 접힘/펼침
                        container.classList.toggle('sidebar-collapsed');
                    }
                });
            }
            
            if (mobileSidebarToggle) {
                 mobileSidebarToggle.addEventListener('click', () => {
                    if (isMobile()) {
                        // 모바일: 사이드바 나타남/사라짐
                        container.classList.toggle('mobile-sidebar-open');
                        mobileSidebarOverlay.classList.toggle('visible');
                    } else {
                        // PC: 사이드바 접힘/펼침
                        container.classList.toggle('sidebar-collapsed');
                    }
                });
            }

            // 모바일 오버레이 클릭 시 사이드바 닫기
            if (mobileSidebarOverlay) {
                mobileSidebarOverlay.addEventListener('click', () => {
                    container.classList.remove('mobile-sidebar-open');
                    mobileSidebarOverlay.classList.remove('visible');
                });
            }

            // 모바일에서 사이드바 링크 클릭 시 사이드바 닫기
            if (sidebar) {
                sidebar.addEventListener('click', (e) => {
                    if (isMobile() && e.target.tagName === 'A') {
                        // 링크 클릭 시 사이드바 닫기 (약간의 지연을 두어 자연스럽게)
                        setTimeout(() => {
                            container.classList.remove('mobile-sidebar-open');
                            mobileSidebarOverlay.classList.remove('visible');
                        }, 150);
                    }
                });
            }

            // 화면 크기 변경 시 처리
            window.addEventListener('resize', () => {
                if (!isMobile()) {
                    // PC 화면으로 전환 시 모바일 사이드바 상태 초기화
                    container.classList.remove('mobile-sidebar-open');
                    if (mobileSidebarOverlay) mobileSidebarOverlay.classList.remove('visible');
                }
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>

