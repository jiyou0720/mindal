<!--frontend/templates/menu_management.html-->
{% extends "base.html" %}

{% block title %}메뉴 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}"> {# 관리자 대시보드 CSS 재사용 #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container"> {# admin-dashboard-container 클래스 재사용 #}
        <h1>메뉴 관리</h1>
        <p>웹사이트의 사이드바 메뉴 항목을 추가, 수정, 삭제할 수 있습니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay">로딩 중...</span></p>

        <div class="admin-section"> {# admin-section 클래스 재사용 #}
            <h2>메뉴 목록</h2>
            <button id="addMenuButton" class="button primary">새 메뉴 추가</button>
            <div class="menu-list-table-container">
                <table class="menu-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>메뉴 이름</th>
                            <th>경로</th>
                            <th>아이콘 클래스</th>
                            <th>필요 역할</th>
                            <th>순서</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="menuTableBody">
                        <!-- 메뉴 데이터가 여기에 동적으로 로드됩니다 -->
                        <tr><td colspan="7" style="text-align: center;">메뉴 정보를 불러오는 중...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="noMenusMessage" style="text-align: center; color: #777; padding: 20px; display: none;">메뉴가 없습니다.</p>
        </div>
    </div>

    <!-- 메뉴 추가/수정 모달 -->
    <div id="menuModal" class="alert-modal-overlay">
        <div class="alert-modal">
            <h3 id="modalTitle">새 메뉴 추가</h3>
            <form id="menuForm">
                <input type="hidden" id="menuId">
                <div class="form-group">
                    <label for="menuName">메뉴 이름</label>
                    <input type="text" id="menuName" required>
                </div>
                <div class="form-group">
                    <label for="menuUrl">경로 (URL)</label>
                    <input type="text" id="menuUrl" required>
                </div>
                <div class="form-group">
                    <label for="menuIcon">아이콘 클래스 (예: fas fa-home)</label>
                    <input type="text" id="menuIcon">
                </div>
                <div class="form-group">
                    <label for="menuOrder">순서 (숫자)</label>
                    <input type="number" id="menuOrder" value="0" required>
                </div>
                <div class="form-group">
                    <label for="requiredRoles">필요 역할 (다중 선택 가능)</label>
                    <div id="requiredRolesCheckboxes" class="roles-checkboxes">
                        <!-- 역할 체크박스가 여기에 동적으로 로드됩니다 -->
                    </div>
                </div>
                <button type="submit" class="button primary">저장</button>
                <button type="button" id="closeMenuModalButton" class="button secondary" style="margin-left: 10px;">취소</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const menuTableBody = document.getElementById('menuTableBody');
        const addMenuButton = document.getElementById('addMenuButton');
        const menuModal = document.getElementById('menuModal');
        const modalTitle = document.getElementById('modalTitle');
        const menuForm = document.getElementById('menuForm');
        const closeMenuModalButton = document.getElementById('closeMenuModalButton');
        const noMenusMessage = document.getElementById('noMenusMessage');
        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        let allRoles = []; // 모든 역할 데이터를 저장할 배열
        let editingMenuId = null; // 현재 편집 중인 메뉴 ID

        // 관리자 접근 권한 확인 함수 (user_management.html과 동일한 로직)
        async function checkAdminAccess() {
            console.log('checkAdminAccess (menu_management): 함수 시작');
            const token = localStorage.getItem('access_token');
            console.log('checkAdminAccess (menu_management): 로컬 스토리지 access_token:', token ? '존재함' : '없음');

            if (!token) {
                console.log('checkAdminAccess (menu_management): 토큰 없음, 로그인 페이지로 리다이렉트');
                await showAlert('관리자 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                console.log('checkAdminAccess (menu_management): /api/auth/me 호출 시도');
                // debugger; // 디버깅 완료 후 주석 처리 또는 제거
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                console.log('checkAdminAccess (menu_management): /api/auth/me fetchWithAuth 호출 결과:', response);

                if (!response) {
                    console.log('checkAdminAccess (menu_management): fetchWithAuth가 undefined 반환 (401 리다이렉트 발생 예상)');
                    return false; 
                }

                if (!response.ok) {
                    console.log('checkAdminAccess (menu_management): /api/auth/me 응답 실패 (response.ok = false), status:', response.status);
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkAdminAccess (menu_management): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자')) {
                    console.log('checkAdminAccess (menu_management): 관리자 역할 없음, 홈으로 리다이렉트');
                    await showAlert('관리자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                console.log('checkAdminAccess (menu_management): 관리자 접근 권한 확인 완료');
                return true;
            } catch (error) {
                console.error('checkAdminAccess (menu_management): 오류 발생:', error);
                await showAlert('관리자 접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 모든 메뉴 아이템 불러오기
        async function fetchAllMenuItems() {
            menuTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">메뉴 정보를 불러오는 중...</td></tr>';
            noMenusMessage.style.display = 'none';

            try {
                const response = await fetchWithAuth('/api/admin/menu_items');
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '메뉴 목록을 불러오는 데 실패했습니다.');
                    menuTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">메뉴 정보를 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                renderMenuTable(data.menu_items);
            } catch (error) {
                console.error('메뉴 목록 로드 중 오류 발생:', error);
                await showAlert('메뉴 목록을 불러오는 중 네트워크 오류가 발생했습니다.');
                menuTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 메뉴 테이블 렌더링
        function renderMenuTable(menuItems) {
            menuTableBody.innerHTML = '';
            if (menuItems.length === 0) {
                noMenusMessage.style.display = 'block';
                return;
            }
            noMenusMessage.style.display = 'none';

            menuItems.forEach(item => {
                const row = menuTableBody.insertRow();
                const requiredRoles = item.required_roles && item.required_roles.length > 0 ? item.required_roles.join(', ') : '없음';
                row.innerHTML = `
                    <td>${item._id}</td>
                    <td>${item.name}</td>
                    <td>${item.url}</td>
                    <td><i class="${item.icon_class || 'fas fa-circle-notch'}"></i> ${item.icon_class || ''}</td>
                    <td>${requiredRoles}</td>
                    <td>${item.order}</td>
                    <td>
                        <button class="button small secondary edit-menu-button" data-menu-id="${item._id}">수정</button>
                        <button class="button small danger delete-menu-button" data-menu-id="${item._id}">삭제</button>
                    </td>
                `;
            });

            document.querySelectorAll('.edit-menu-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const menuId = e.target.dataset.menuId;
                    openMenuModalForEdit(menuId);
                });
            });

            document.querySelectorAll('.delete-menu-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const menuId = e.target.dataset.menuId;
                    deleteMenuItem(menuId);
                });
            });
        }

        // 모든 역할 정보 불러오기 (모달에서 사용)
        async function fetchAllRolesForModal() {
            try {
                const response = await fetchWithAuth('/api/admin/roles');
                if (response.ok) {
                    allRoles = (await response.json()).roles;
                } else {
                    console.error('Failed to load all roles for modal:', await response.json());
                    await showAlert('역할 정보를 불러오는 데 실패했습니다.');
                }
            } catch (error) {
                console.error('Network error loading all roles for modal:', error);
                await showAlert('역할 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }


        // 메뉴 추가/수정 모달 열기 (추가)
        addMenuButton.addEventListener('click', () => {
            modalTitle.textContent = '새 메뉴 추가';
            menuForm.reset();
            editingMenuId = null;
            renderRoleCheckboxes([]); // 빈 배열로 초기화
            menuModal.classList.add('visible');
        });

        // 메뉴 수정 모달 열기
        async function openMenuModalForEdit(menuId) {
            const menu = (await fetchWithAuth(`/api/admin/menu_items/${menuId}`)).json();
            if (!menu) {
                await showAlert('메뉴 정보를 불러오는 데 실패했습니다.');
                return;
            }

            modalTitle.textContent = '메뉴 수정';
            editingMenuId = menuId;
            document.getElementById('menuId').value = menuId;
            document.getElementById('menuName').value = menu.name;
            document.getElementById('menuUrl').value = menu.url;
            document.getElementById('menuIcon').value = menu.icon_class || '';
            document.getElementById('menuOrder').value = menu.order;
            renderRoleCheckboxes(menu.required_roles || []);
            menuModal.classList.add('visible');
        }

        // 역할 체크박스 렌더링
        function renderRoleCheckboxes(selectedRoles) {
            const requiredRolesCheckboxes = document.getElementById('requiredRolesCheckboxes');
            requiredRolesCheckboxes.innerHTML = '';
            allRoles.forEach(role => {
                const isChecked = selectedRoles.includes(role.name);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'role-checkbox-item';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="modal_role_${role.id}" value="${role.name}" ${isChecked ? 'checked' : ''}>
                    <label for="modal_role_${role.id}">${role.name}</label>
                `;
                requiredRolesCheckboxes.appendChild(checkboxDiv);
            });
        }

        // 메뉴 모달 닫기
        closeMenuModalButton.addEventListener('click', () => {
            menuModal.classList.remove('visible');
        });

        // 메뉴 저장 (추가/수정)
        menuForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const menuData = {
                name: document.getElementById('menuName').value,
                url: document.getElementById('menuUrl').value,
                icon_class: document.getElementById('menuIcon').value,
                order: parseInt(document.getElementById('menuOrder').value),
                required_roles: Array.from(document.querySelectorAll('#requiredRolesCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value)
            };

            let response;
            let result;

            try {
                if (editingMenuId) { // 수정
                    response = await fetchWithAuth(`/api/admin/menu_items/${editingMenuId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(menuData)
                    });
                } else { // 추가
                    response = await fetchWithAuth('/api/admin/menu_items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(menuData)
                    });
                }

                result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '메뉴가 성공적으로 저장되었습니다.');
                    menuModal.classList.remove('visible');
                    fetchAllMenuItems(); // 메뉴 목록 새로고침
                    localStorage.removeItem('cached_menu_items'); // 메뉴 캐시 삭제하여 새로고침 유도
                } else {
                    await showAlert(result.message || '메뉴 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('메뉴 저장 중 오류 발생:', error);
                await showAlert('메뉴 저장 중 오류가 발생했습니다.');
            }
        });

        // 메뉴 삭제
        async function deleteMenuItem(menuId) {
            const confirmed = await showConfirm('정말로 이 메뉴 항목을 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetchWithAuth(`/api/admin/menu_items/${menuId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await showAlert('메뉴 항목이 성공적으로 삭제되었습니다.');
                    fetchAllMenuItems(); // 메뉴 목록 새로고침
                    localStorage.removeItem('cached_menu_items');
                } else {
                    await showAlert('메뉴 항목 삭제 실패.');
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                await showAlert('메뉴 항목 삭제 중 오류가 발생했습니다.');
            }
        }

        // 초기 로드 시 관리자 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                await fetchAllRolesForModal(); // 모든 역할 미리 로드
                fetchAllMenuItems(); // 메뉴 데이터 로드
            }
        });
    </script>
{% endblock %}
