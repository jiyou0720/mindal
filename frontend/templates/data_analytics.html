<<<<<<< HEAD
<!-- frontend/templates/data_analytics.html -->
{% extends "base.html" %}

{% block title %}데이터 분석 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/data_analytics.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>데이터 분석 및 통계</h1>
        <p>사용자 활동, 챗봇 상담 주제, 커뮤니티 인기 게시글 등 서비스 전반의 데이터를 시각적으로 분석합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>주간 감정 분포</h2>
            <div class="chart-container">
                <canvas id="moodDistributionChart"></canvas>
            </div>
            <p class="chart-description">사용자들이 기록한 감정의 주간 분포를 보여줍니다.</p>
        </div>

        <div class="admin-section">
            <h2>월별 일기 작성량</h2>
            <div class="chart-container">
                <canvas id="diaryEntryCountChart"></canvas>
            </div>
            <p class="chart-description">월별 일기 작성 추이를 보여줍니다.</p>
        </div>

        <div class="admin-section">
            <h2>상위 10개 키워드</h2>
            <div class="chart-container">
                <canvas id="topKeywordsChart"></canvas>
            </div>
            <p class="chart-description">사용자 일기에서 가장 자주 등장하는 키워드입니다.</p>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        // 접근 권한 확인 함수 (관리자, 연구자)
        async function checkDataAnalyticsAccess() {
            console.log('checkDataAnalyticsAccess (data_analytics): 함수 시작');
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('데이터 분석 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response) { return false; }
                if (!response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkDataAnalyticsAccess (data_analytics): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자') && !userRoles.includes('연구자')) {
                    await showAlert('관리자 또는 연구자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('checkDataAnalyticsAccess (data_analytics): 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 차트 데이터 불러오기 및 렌더링 함수
        async function fetchDataAndRenderCharts() {
            try {
                // 감정 분포 차트
                const moodResponse = await fetchWithAuth('/api/admin/analytics/mood_distribution'); // API 경로 수정
                if (moodResponse && moodResponse.ok) {
                    const moodData = await moodResponse.json();
                    renderMoodDistributionChart(moodData);
                } else {
                    console.error('Failed to load mood distribution data:', moodResponse ? await moodResponse.json() : 'No response');
                    // 차트 영역에 오류 메시지 표시 또는 차트 숨김
                    document.getElementById('moodDistributionChart').closest('.chart-container').innerHTML = '<p class="error-row">감정 분포 데이터를 불러오는 데 실패했습니다.</p>';
                }

                // 일기 작성량 차트
                const diaryResponse = await fetchWithAuth('/api/admin/analytics/diary_entry_counts'); // API 경로 수정
                if (diaryResponse && diaryResponse.ok) {
                    const diaryData = await diaryResponse.json();
                    renderDiaryEntryCountChart(diaryData);
                } else {
                    console.error('Failed to load diary entry counts data:', diaryResponse ? await diaryResponse.json() : 'No response');
                    document.getElementById('diaryEntryCountChart').closest('.chart-container').innerHTML = '<p class="error-row">일기 작성량 데이터를 불러오는 데 실패했습니다.</p>';
                }

                // 키워드 빈도 차트
                const keywordResponse = await fetchWithAuth('/api/admin/analytics/top_keywords'); // API 경로 수정
                if (keywordResponse && keywordResponse.ok) {
                    const keywordData = await keywordResponse.json();
                    renderTopKeywordsChart(keywordData);
                } else {
                    console.error('Failed to load top keywords data:', keywordResponse ? await keywordResponse.json() : 'No response');
                    document.getElementById('topKeywordsChart').closest('.chart-container').innerHTML = '<p class="error-row">상위 키워드 데이터를 불러오는 데 실패했습니다.</p>';
                }

            } catch (error) {
                console.error('차트 데이터 로드 중 네트워크 오류 발생:', error);
                await showAlert('데이터를 불러오는 중 네트워크 오류가 발생했습니다. 콘솔을 확인해주세요.');
                // 모든 차트 영역에 네트워크 오류 메시지 표시
                document.querySelectorAll('.chart-container').forEach(container => {
                    if (!container.innerHTML.includes('error-row')) { // 이미 오류 메시지가 없으면 추가
                        container.innerHTML = '<p class="error-row">네트워크 오류로 데이터를 불러오지 못했습니다.</p>';
                    }
                });
            }
        }

        // 감정 분포 차트 렌더링
        function renderMoodDistributionChart(data) {
            const ctx = document.getElementById('moodDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie', // 또는 'doughnut'
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.datasets[0].label,
                        data: data.datasets[0].data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)', // 행복
                            'rgba(54, 162, 235, 0.7)', // 슬픔
                            'rgba(255, 206, 86, 0.7)', // 불안
                            'rgba(75, 192, 192, 0.7)', // 분노
                            'rgba(153, 102, 255, 0.7)', // 평온
                            'rgba(255, 159, 64, 0.7)', // 놀람
                            'rgba(199, 199, 199, 0.7)' // 기타
                        ],
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '주간 감정 분포'
                        }
                    }
                }
            });
        }

        // 월별 일기 작성량 차트 렌더링
        function renderDiaryEntryCountChart(data) {
            const ctx = document.getElementById('diaryEntryCountChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.datasets[0].label,
                        data: data.datasets[0].data,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: '월별 일기 작성량'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '작성된 일기 수'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '월'
                            }
                        }
                    }
                }
            });
        }

        // 상위 10개 키워드 차트 렌더링
        function renderTopKeywordsChart(data) {
            const ctx = document.getElementById('topKeywordsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.datasets[0].label,
                        data: data.datasets[0].data,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // 가로 막대 차트
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: '상위 10개 키워드 빈도'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '빈도'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '키워드'
                            }
                        }
                    }
                }
            });
        }


        // 초기 로드 시 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkDataAnalyticsAccess();
            if (hasAccess) {
                fetchDataAndRenderCharts();
            }
        });
    </script>
{% endblock %}
=======
<!-- frontend/templates/data_analytics.html -->
{% extends "base.html" %}

{% block title %}데이터 분석 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/data_analytics.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>데이터 분석 및 통계</h1>
        <p>사용자 활동, 챗봇 상담 주제, 커뮤니티 인기 게시글 등 서비스 전반의 데이터를 시각적으로 분석합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>주간 감정 분포</h2>
            <div class="chart-container">
                <canvas id="moodDistributionChart"></canvas>
            </div>
            <p class="chart-description">사용자들이 기록한 감정의 주간 분포를 보여줍니다.</p>
        </div>

        <div class="admin-section">
            <h2>월별 일기 작성량</h2>
            <div class="chart-container">
                <canvas id="diaryEntryCountChart"></canvas>
            </div>
            <p class="chart-description">월별 일기 작성 추이를 보여줍니다.</p>
        </div>

        <div class="admin-section">
            <h2>상위 10개 키워드</h2>
            <div class="chart-container">
                <canvas id="topKeywordsChart"></canvas>
            </div>
            <p class="chart-description">사용자 일기에서 가장 자주 등장하는 키워드입니다.</p>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        // 접근 권한 확인 함수 (관리자, 연구자)
        async function checkDataAnalyticsAccess() {
            console.log('checkDataAnalyticsAccess (data_analytics): 함수 시작');
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('데이터 분석 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response) { return false; }
                if (!response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkDataAnalyticsAccess (data_analytics): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자') && !userRoles.includes('연구자')) {
                    await showAlert('관리자 또는 연구자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('checkDataAnalyticsAccess (data_analytics): 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 차트 데이터 불러오기 및 렌더링 함수
        async function fetchDataAndRenderCharts() {
            try {
                // 감정 분포 차트
                const moodResponse = await fetchWithAuth('/api/admin/analytics/mood_distribution'); // API 경로 수정
                if (moodResponse && moodResponse.ok) {
                    const moodData = await moodResponse.json();
                    renderMoodDistributionChart(moodData);
                } else {
                    console.error('Failed to load mood distribution data:', moodResponse ? await moodResponse.json() : 'No response');
                    // 차트 영역에 오류 메시지 표시 또는 차트 숨김
                    document.getElementById('moodDistributionChart').closest('.chart-container').innerHTML = '<p class="error-row">감정 분포 데이터를 불러오는 데 실패했습니다.</p>';
                }

                // 일기 작성량 차트
                const diaryResponse = await fetchWithAuth('/api/admin/analytics/diary_entry_counts'); // API 경로 수정
                if (diaryResponse && diaryResponse.ok) {
                    const diaryData = await diaryResponse.json();
                    renderDiaryEntryCountChart(diaryData);
                } else {
                    console.error('Failed to load diary entry counts data:', diaryResponse ? await diaryResponse.json() : 'No response');
                    document.getElementById('diaryEntryCountChart').closest('.chart-container').innerHTML = '<p class="error-row">일기 작성량 데이터를 불러오는 데 실패했습니다.</p>';
                }

                // 키워드 빈도 차트
                const keywordResponse = await fetchWithAuth('/api/admin/analytics/top_keywords'); // API 경로 수정
                if (keywordResponse && keywordResponse.ok) {
                    const keywordData = await keywordResponse.json();
                    renderTopKeywordsChart(keywordData);
                } else {
                    console.error('Failed to load top keywords data:', keywordResponse ? await keywordResponse.json() : 'No response');
                    document.getElementById('topKeywordsChart').closest('.chart-container').innerHTML = '<p class="error-row">상위 키워드 데이터를 불러오는 데 실패했습니다.</p>';
                }

            } catch (error) {
                console.error('차트 데이터 로드 중 네트워크 오류 발생:', error);
                await showAlert('데이터를 불러오는 중 네트워크 오류가 발생했습니다. 콘솔을 확인해주세요.');
                // 모든 차트 영역에 네트워크 오류 메시지 표시
                document.querySelectorAll('.chart-container').forEach(container => {
                    if (!container.innerHTML.includes('error-row')) { // 이미 오류 메시지가 없으면 추가
                        container.innerHTML = '<p class="error-row">네트워크 오류로 데이터를 불러오지 못했습니다.</p>';
                    }
                });
            }
        }

        // 감정 분포 차트 렌더링
        function renderMoodDistributionChart(data) {
            const ctx = document.getElementById('moodDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie', // 또는 'doughnut'
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.datasets[0].label,
                        data: data.datasets[0].data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)', // 행복
                            'rgba(54, 162, 235, 0.7)', // 슬픔
                            'rgba(255, 206, 86, 0.7)', // 불안
                            'rgba(75, 192, 192, 0.7)', // 분노
                            'rgba(153, 102, 255, 0.7)', // 평온
                            'rgba(255, 159, 64, 0.7)', // 놀람
                            'rgba(199, 199, 199, 0.7)' // 기타
                        ],
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '주간 감정 분포'
                        }
                    }
                }
            });
        }

        // 월별 일기 작성량 차트 렌더링
        function renderDiaryEntryCountChart(data) {
            const ctx = document.getElementById('diaryEntryCountChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.datasets[0].label,
                        data: data.datasets[0].data,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: '월별 일기 작성량'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '작성된 일기 수'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '월'
                            }
                        }
                    }
                }
            });
        }

        // 상위 10개 키워드 차트 렌더링
        function renderTopKeywordsChart(data) {
            const ctx = document.getElementById('topKeywordsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.datasets[0].label,
                        data: data.datasets[0].data,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // 가로 막대 차트
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: '상위 10개 키워드 빈도'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '빈도'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '키워드'
                            }
                        }
                    }
                }
            });
        }


        // 초기 로드 시 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkDataAnalyticsAccess();
            if (hasAccess) {
                fetchDataAndRenderCharts();
            }
        });
    </script>
{% endblock %}
>>>>>>> 32e57f7623365b93a09d34dc9cad501cc18c11af
