<!-- frontend/templates/cms_management.html -->
{% extends "base.html" %}

{% block title %}CMS 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cms_management.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>CMS 관리</h1>
        <p>심리 테스트 문항, 챗봇 답변 데이터, 위험 감지 자료 등을 관리합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>콘텐츠 유형 선택</h2>
            <div class="content-type-selection">
                <button class="button primary content-type-button" data-type="psych_test_questions">심리 테스트 문항</button>
                <button class="button secondary content-type-button" data-type="chatbot_responses">챗봇 답변 데이터</button>
                <button class="button secondary content-type-button" data-type="risk_detection_materials">위험 감지 자료</button>
            </div>

            <div id="contentManagementArea" class="content-management-area">
                <!-- 선택된 콘텐츠 유형에 따라 동적으로 내용이 로드됩니다 -->
                <p class="initial-message">위에서 관리할 콘텐츠 유형을 선택해주세요.</p>
            </div>
        </div>
    </div>

    <!-- 콘텐츠 추가/수정 모달 (재사용 가능하도록 일반화) -->
    <div id="contentModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="contentModalTitle">콘텐츠 추가/수정</h3>
            <form id="contentForm">
                <input type="hidden" id="contentId">
                <input type="hidden" id="contentType">
                
                <div class="form-group">
                    <label for="contentTitle">제목/질문</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                    <label for="contentBody">내용/답변</label>
                    <textarea id="contentBody" rows="10" required></textarea>
                </div>
                <div class="form-group" id="optionsGroup" style="display: none;">
                    <label for="contentOptions">옵션 (JSON 배열)</label>
                    <textarea id="contentOptions" rows="5" placeholder='예: ["옵션1", "옵션2"]'></textarea>
                </div>
                
                <button type="submit" class="button primary">저장</button>
                <button type="button" id="closeContentModalButton" class="button secondary" style="margin-left: 10px;">취소</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');
        const contentTypeButtons = document.querySelectorAll('.content-type-button');
        const contentManagementArea = document.getElementById('contentManagementArea');

        const contentModal = document.getElementById('contentModal');
        const closeContentModalButton = contentModal.querySelector('.close-button');
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentForm = document.getElementById('contentForm');
        const contentIdInput = document.getElementById('contentId');
        const contentTypeInput = document.getElementById('contentType');
        const contentTitleInput = document.getElementById('contentTitle');
        const contentBodyInput = document.getElementById('contentBody');
        const optionsGroup = document.getElementById('optionsGroup');
        const contentOptionsInput = document.getElementById('contentOptions');

        let currentContentType = null;
        let allCmsContent = []; // 현재 로드된 CMS 데이터

        // 접근 권한 확인 함수 (관리자)
        async function checkCmsAccess() {
            console.log('checkCmsAccess (cms_management): 함수 시작');
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('CMS 관리 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response) { return false; }
                if (!response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkCmsAccess (cms_management): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자')) {
                    await showAlert('관리자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('checkCmsAccess (cms_management): 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 콘텐츠 유형 선택 핸들러
        contentTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                contentTypeButtons.forEach(btn => btn.classList.remove('primary'));
                button.classList.add('primary');
                currentContentType = button.dataset.type;
                fetchCmsContent(currentContentType);
            });
        });

        // CMS 콘텐츠 불러오기 (임시)
        async function fetchCmsContent(type) {
            contentManagementArea.innerHTML = '<p class="loading-row">콘텐츠를 불러오는 중...</p>';
            optionsGroup.style.display = (type === 'psych_test_questions') ? 'block' : 'none';

            try {
                // TODO: 실제 CMS 콘텐츠를 불러오는 API 엔드포인트 구현 필요
                // 각 유형별로 다른 API를 호출하거나, 단일 API에 type 파라미터 전달
                const response = await fetchWithAuth(`/api/admin/cms/${type}`); // 임시 API 엔드포인트
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '콘텐츠를 불러오는 데 실패했습니다.');
                    contentManagementArea.innerHTML = '<p class="error-row">콘텐츠를 불러오지 못했습니다.</p>';
                    return;
                }
                const data = await response.json();
                allCmsContent = data.content || [];
                renderCmsTable(allCmsContent, type);
            } catch (error) {
                console.error('CMS 콘텐츠 로드 중 오류 발생:', error);
                await showAlert('콘텐츠를 불러오는 중 네트워크 오류가 발생했습니다.');
                contentManagementArea.innerHTML = '<p class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</p>';
            }
        }

        // CMS 테이블 렌더링
        function renderCmsTable(contentToRender, type) {
            let tableHtml = `
                <button class="button primary add-content-button" style="margin-bottom: 20px;">새 ${getKoreanContentType(type)} 추가</button>
                <div class="data-table-container">
                    <table class="data-list-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>제목/질문</th>
                                <th>내용/답변</th>
                                ${type === 'psych_test_questions' ? '<th>옵션</th>' : ''}
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="cmsTableBody">
                            <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
                <p id="noCmsContentMessage" class="no-data-message hidden">콘텐츠가 없습니다.</p>
            `;
            contentManagementArea.innerHTML = tableHtml;

            const cmsTableBody = document.getElementById('cmsTableBody');
            const noCmsContentMessage = document.getElementById('noCmsContentMessage');

            if (contentToRender.length === 0) {
                noCmsContentMessage.classList.remove('hidden');
            } else {
                noCmsContentMessage.classList.add('hidden');
            }

            contentToRender.forEach(item => {
                const row = cmsTableBody.insertRow();
                const optionsDisplay = (type === 'psych_test_questions' && item.options) ? item.options.join(', ') : '-';

                row.innerHTML = `
                    <td>${item.id || item._id || '-'}</td>
                    <td>${item.title || item.question || '-'}</td>
                    <td>${item.content || item.answer || '-'}</td>
                    ${type === 'psych_test_questions' ? `<td>${optionsDisplay}</td>` : ''}
                    <td class="action-cell">
                        <button class="button small secondary edit-content-button" data-content-id="${item.id || item._id}">수정</button>
                        <button class="button small danger delete-content-button" data-content-id="${item.id || item._id}">삭제</button>
                    </td>
                `;
            });

            document.querySelector('.add-content-button').addEventListener('click', () => openContentModalForAdd(type));
            document.querySelectorAll('.edit-content-button').forEach(button => {
                button.addEventListener('click', (e) => openContentModalForEdit(e.target.dataset.contentId, type));
            });
            document.querySelectorAll('.delete-content-button').forEach(button => {
                button.addEventListener('click', (e) => deleteCmsContent(e.target.dataset.contentId, type));
            });
        }

        function getKoreanContentType(type) {
            switch(type) {
                case 'psych_test_questions': return '심리 테스트 문항';
                case 'chatbot_responses': return '챗봇 답변 데이터';
                case 'risk_detection_materials': return '위험 감지 자료';
                default: return '콘텐츠';
            }
        }

        // 콘텐츠 모달 열기 (추가)
        function openContentModalForAdd(type) {
            contentModalTitle.textContent = `${getKoreanContentType(type)} 추가`;
            contentForm.reset();
            contentIdInput.value = '';
            contentTypeInput.value = type;
            optionsGroup.style.display = (type === 'psych_test_questions') ? 'block' : 'none';
            contentModal.classList.add('visible');
        }

        // 콘텐츠 모달 열기 (수정)
        async function openContentModalForEdit(id, type) {
            try {
                // TODO: 특정 콘텐츠 상세 정보 불러오는 API 구현 필요
                const response = await fetchWithAuth(`/api/admin/cms/${type}/${id}`); // 임시 API
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '콘텐츠 정보를 불러오는 데 실패했습니다.');
                    return;
                }
                const item = await response.json();

                contentModalTitle.textContent = `${getKoreanContentType(type)} 수정`;
                contentIdInput.value = id;
                contentTypeInput.value = type;
                contentTitleInput.value = item.title || item.question || '';
                contentBodyInput.value = item.content || item.answer || '';
                optionsGroup.style.display = (type === 'psych_test_questions') ? 'block' : 'none';
                contentOptionsInput.value = (item.options && Array.isArray(item.options)) ? JSON.stringify(item.options) : '';
                
                contentModal.classList.add('visible');
            } catch (error) {
                console.error('콘텐츠 정보 로드 중 오류 발생:', error);
                await showAlert('콘텐츠 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }

        // 콘텐츠 모달 닫기
        closeContentModalButton.addEventListener('click', () => {
            contentModal.classList.remove('visible');
        });

        // 콘텐츠 저장 (추가/수정)
        contentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = contentIdInput.value;
            const type = contentTypeInput.value;
            let payload = {
                title: contentTitleInput.value,
                content: contentBodyInput.value,
            };

            if (type === 'psych_test_questions') {
                try {
                    payload.options = JSON.parse(contentOptionsInput.value || '[]');
                } catch (e) {
                    await showAlert('옵션은 유효한 JSON 배열 형식이어야 합니다. 예: ["옵션1", "옵션2"]');
                    return;
                }
            }

            let response;
            let result;

            try {
                if (id) { // 수정
                    response = await fetchWithAuth(`/api/admin/cms/${type}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else { // 추가
                    response = await fetchWithAuth(`/api/admin/cms/${type}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '콘텐츠가 성공적으로 저장되었습니다.');
                    contentModal.classList.remove('visible');
                    fetchCmsContent(type); // 목록 새로고침
                } else {
                    await showAlert(result.message || '콘텐츠 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('콘텐츠 저장 중 오류 발생:', error);
                await showAlert('콘텐츠 저장 중 오류가 발생했습니다.');
            }
        });

        // 콘텐츠 삭제
        async function deleteCmsContent(id, type) {
            const confirmed = await showConfirm('정말로 이 콘텐츠를 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                // TODO: 콘텐츠 삭제 API 구현 필요
                const response = await fetchWithAuth(`/api/admin/cms/${type}/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await showAlert('콘텐츠가 성공적으로 삭제되었습니다.');
                    fetchCmsContent(type); // 목록 새로고침
                } else {
                    await showAlert('콘텐츠 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('콘텐츠 삭제 중 오류 발생:', error);
                await showAlert('콘텐츠 삭제 중 오류가 발생했습니다.');
            }
        }

        // 초기 로드 시 접근 권한 확인
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkCmsAccess();
            if (hasAccess) {
                // 초기에는 아무 콘텐츠도 로드하지 않고, 버튼 클릭 대기
            }
        });
    </script>
{% endblock %}
