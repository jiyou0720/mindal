<<<<<<< HEAD
<!-- frontend/templates/cms_management.html -->
{% extends "base.html" %}

{% block title %}CMS 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cms_management.css') }}"> {# CMS 관리 전용 CSS #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>CMS 관리</h1>
        <p>심리 테스트 문항, 챗봇 답변 데이터, 위험 감지 자료 등을 관리합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>콘텐츠 유형 선택</h2>
            <div class="content-type-selection">
                <button class="content-type-button" data-content-type="psych_test_questions">심리 테스트 문항</button>
                <button class="content-type-button" data-content-type="chatbot_responses">챗봇 답변 데이터</button>
                <button class="content-type-button" data-content-type="risk_detection_materials">위험 감지 자료</button>
            </div>

            <div class="content-management-area">
                <p id="initialMessage" class="initial-message">콘텐츠 유형을 선택하여 관리할 수 있습니다.</p>
                
                {# 각 콘텐츠 섹션을 동적으로 로드할 것이므로, 여기서는 초기 HTML을 제거합니다. #}
                {# JavaScript에서 이 div들을 직접 생성하고 삽입합니다. #}
            </div>
        </div>
    </div>

    <!-- CMS 콘텐츠 추가/수정 모달 -->
    <div id="cmsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="cmsModalTitle">새 심리 테스트 문항 추가</h3>
            <form id="cmsForm">
                <input type="hidden" id="cmsItemId">
                <input type="hidden" id="cmsContentType">
                <div class="form-group">
                    <label for="cmsTitle">제목/질문</label>
                    <input type="text" id="cmsTitle" required>
                </div>
                <div class="form-group">
                    <label for="cmsContent">내용/설명</label>
                    <textarea id="cmsContent" rows="5" required></textarea>
                </div>
                <div class="form-group" id="cmsOptionsGroup"> {# 옵션 필드 그룹 #}
                    <label for="cmsOptions">옵션 (JSON 배열 형식, 예: [{"text": "예", "score": 1}, {"text": "아니오", "score": 0}])</label>
                    <textarea id="cmsOptions" rows="5" placeholder='[{"text": "선택지1", "score": 1}, {"text": "선택지2", "score": 0}]'></textarea>
                </div>
                <button type="submit" class="button primary">저장</button>
                <button type="button" id="closeCmsModalButton" class="button secondary" style="margin-left: 10px;">취소</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const contentTypeButtons = document.querySelectorAll('.content-type-button');
        const initialMessage = document.getElementById('initialMessage');
        const contentManagementArea = document.querySelector('.content-management-area'); // 부모 컨테이너

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        // CMS 모달 관련 DOM
        const cmsModal = document.getElementById('cmsModal');
        const cmsModalTitle = document.getElementById('cmsModalTitle');
        const cmsForm = document.getElementById('cmsForm');
        const cmsItemId = document.getElementById('cmsItemId');
        const cmsContentType = document.getElementById('cmsContentType');
        const cmsTitleInput = document.getElementById('cmsTitle');
        const cmsContentTextarea = document.getElementById('cmsContent');
        const cmsOptionsGroup = document.getElementById('cmsOptionsGroup');
        const cmsOptionsTextarea = document.getElementById('cmsOptions');
        const closeCmsModalButton = document.getElementById('closeCmsModalButton');

        let currentSelectedContentType = null; // 현재 선택된 콘텐츠 유형
        let editingCmsItemId = null; // 현재 편집 중인 CMS 아이템 ID

        // 접근 권한 확인 함수 (기존과 동일)
        async function checkAdminAccess() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('관리자 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response || !response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];

                if (!userRoles.includes('관리자')) {
                    await showAlert('관리자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('접근 권한 확인 중 오류 발생:', error);
                await showAlert('관리자 접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 콘텐츠 유형 버튼 클릭 이벤트
        contentTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const contentType = button.dataset.contentType;
                selectContentType(contentType);
            });
        });

        // 콘텐츠 유형 선택 처리 함수
        async function selectContentType(type) {
            currentSelectedContentType = type;
            initialMessage.classList.add('hidden');
            
            // contentManagementArea의 모든 자식 요소를 제거하여 섹션 초기화
            contentManagementArea.innerHTML = ''; 

            // 모든 버튼의 활성 상태 초기화
            contentTypeButtons.forEach(btn => btn.classList.remove('primary', 'secondary'));
            contentTypeButtons.forEach(btn => btn.classList.add('secondary')); // 모든 버튼을 secondary로 설정

            // 선택된 버튼 활성화
            const selectedButton = document.querySelector(`.content-type-button[data-content-type="${type}"]`);
            if (selectedButton) {
                selectedButton.classList.remove('secondary');
                selectedButton.classList.add('primary');
            }

            // 선택된 유형에 따라 동적으로 섹션 생성 및 로드
            let sectionHtml = '';
            switch (type) {
                case 'psych_test_questions':
                    sectionHtml = `
                        <div id="psychTestQuestionsSection" class="content-section">
                            <h2 class="section-title">심리 테스트 문항 관리</h2>
                            <button id="addPsychQuestionButton" class="button primary">새 심리 테스트 문항 추가</button>
                            <div class="data-table-container">
                                <table class="data-list-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>제목/질문</th>
                                            <th>내용/설명</th>
                                            <th>옵션</th>
                                            <th>액션</th>
                                        </tr>
                                    </thead>
                                    <tbody id="psychQuestionTableBody">
                                        <tr><td colspan="5" class="loading-row">문항을 불러오는 중...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <p id="noPsychQuestionsMessage" class="no-data-message hidden">심리 테스트 문항이 없습니다.</p>
                        </div>
                    `;
                    contentManagementArea.innerHTML = sectionHtml;
                    
                    // 동적으로 생성된 요소에 이벤트 리스너를 바인딩
                    // DOM 업데이트가 완료된 후 실행되도록 보장
                    // fetchPsychQuestions() 함수 내에서 DOM 요소들을 다시 쿼리하므로,
                    // 이 setTimeout은 addPsychQuestionButton에 대한 이벤트 리스너만 바인딩합니다.
                    setTimeout(() => {
                        const addPsychQuestionButton = document.getElementById('addPsychQuestionButton');
                        if (addPsychQuestionButton) {
                            addPsychQuestionButton.addEventListener('click', () => {
                                openCmsModalForAdd('psych_test_questions');
                            });
                        }
                        fetchPsychQuestions(); // 데이터 로드
                    }, 0); // 0ms 지연으로 DOM 업데이트 후 실행 보장
                    break;
                case 'chatbot_responses':
                    sectionHtml = `
                        <div id="chatbotResponsesSection" class="content-section">
                            <h2 class="section-title">챗봇 답변 데이터 관리</h2>
                            <p>챗봇 답변 데이터 관리 기능은 아직 준비 중입니다.</p>
                        </div>
                    `;
                    contentManagementArea.innerHTML = sectionHtml;
                    break;
                case 'risk_detection_materials':
                    sectionHtml = `
                        <div id="riskDetectionSection" class="content-section">
                            <h2 class="section-title">위험 감지 자료 관리</h2>
                            <p>위험 감지 자료 관리 기능은 아직 준비 중입니다.</p>
                        </div>
                    `;
                    contentManagementArea.innerHTML = sectionHtml;
                    break;
                default:
                    initialMessage.classList.remove('hidden'); // 기본 메시지 다시 표시
                    break;
            }
        }

        // 심리 테스트 문항 불러오기
        async function fetchPsychQuestions() {
            // 동적으로 생성된 요소를 다시 쿼리
            const psychQuestionTableBody = document.getElementById('psychQuestionTableBody');
            const noPsychQuestionsMessage = document.getElementById('noPsychQuestionsMessage');

            // 요소가 존재하지 않으면 오류 로그를 남기고 재시도하지 않음 (무한 루프 방지)
            if (!psychQuestionTableBody || !noPsychQuestionsMessage) {
                console.error("DOM elements for psych questions section not found after dynamic load. Cannot fetch data.");
                return; 
            }

            psychQuestionTableBody.innerHTML = '<tr><td colspan="5" class="loading-row">문항을 불러오는 중...</td></tr>';
            noPsychQuestionsMessage.classList.add('hidden');

            try {
                const response = await fetchWithAuth(`/api/admin/cms/psych_test_questions`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '심리 테스트 문항을 불러오는 데 실패했습니다.');
                    psychQuestionTableBody.innerHTML = '<tr><td colspan="5" class="error-row">문항을 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                renderPsychQuestionsTable(data.content);
            } catch (error) {
                console.error('심리 테스트 문항 로드 중 오류 발생:', error);
                await showAlert('심리 테스트 문항을 불러오는 중 네트워크 오류가 발생했습니다.');
                psychQuestionTableBody.innerHTML = '<tr><td colspan="5" class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 심리 테스트 문항 테이블 렌더링
        function renderPsychQuestionsTable(questions) {
            // 동적으로 생성된 요소를 다시 쿼리
            const psychQuestionTableBody = document.getElementById('psychQuestionTableBody');
            const noPsychQuestionsMessage = document.getElementById('noPsychQuestionsMessage');

            // 요소가 존재하지 않으면 오류 로그를 남기고 재시도하지 않음
            if (!psychQuestionTableBody || !noPsychQuestionsMessage) {
                console.error("DOM elements for psych questions section not found during render. Cannot render table.");
                return; 
            }

            psychQuestionTableBody.innerHTML = '';
            if (questions.length === 0) {
                noPsychQuestionsMessage.classList.remove('hidden');
                return;
            }
            noPsychQuestionsMessage.classList.add('hidden');

            questions.forEach(question => {
                const row = psychQuestionTableBody.insertRow();
                // options가 배열이고 각 요소가 객체인 경우 text 속성만 추출하여 표시
                const optionsDisplay = (question.options && Array.isArray(question.options)) 
                                     ? question.options.map(opt => opt.text).join(', ') 
                                     : '없음';
                
                row.innerHTML = `
                    <td>${String(question._id).substring(0, 8)}...</td>
                    <td>${question.title || question.question_text || '-'}</td>
                    <td>${question.content || '-'}</td>
                    <td class="options-cell">${optionsDisplay}</td>
                    <td class="action-cell">
                        <button class="button small secondary edit-cms-item-button" data-item-id="${String(question._id)}" data-content-type="psych_test_questions">수정</button>
                        <button class="button small danger delete-cms-item-button" data-item-id="${String(question._id)}" data-content-type="psych_test_questions">삭제</button>
                    </td>
                `;
            });

            // 동적으로 생성된 버튼에 이벤트 리스너 다시 바인딩
            document.querySelectorAll('.edit-cms-item-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const contentType = e.target.dataset.contentType;
                    openCmsModalForEdit(itemId, contentType);
                });
            });

            document.querySelectorAll('.delete-cms-item-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const contentType = e.target.dataset.contentType;
                    deleteCmsItem(itemId, contentType);
                });
            });
        }

        // 새 CMS 콘텐츠 추가 버튼 클릭 시 (openCmsModalForAdd 함수로 통합)
        function openCmsModalForAdd(type) {
            cmsModalTitle.textContent = `새 ${getKoreanContentType(type)} 추가`;
            cmsForm.reset();
            editingCmsItemId = null;
            cmsContentType.value = type; // 숨겨진 필드에 콘텐츠 유형 설정
            cmsOptionsGroup.classList.toggle('hidden', type !== 'psych_test_questions'); // 심리 테스트 문항일 때만 옵션 필드 표시

            cmsModal.classList.add('visible');
        }

        // CMS 모달 닫기
        closeCmsModalButton.addEventListener('click', () => {
            cmsModal.classList.remove('visible');
            editingCmsItemId = null;
            // 모달 닫을 때 옵션 필드 숨김 상태로 되돌림 (필요시)
            // cmsOptionsGroup.classList.add('hidden'); 
        });

        // CMS 콘텐츠 수정 모달 열기
        async function openCmsModalForEdit(itemId, contentType) {
            editingCmsItemId = itemId;
            cmsContentType.value = contentType; // 숨겨진 필드에 콘텐츠 유형 설정

            try {
                const response = await fetchWithAuth(`/api/admin/cms/${contentType}/${itemId}`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '콘텐츠 정보를 불러오는 데 실패했습니다.');
                    return;
                }
                const item = await response.json();

                cmsModalTitle.textContent = `${getKoreanContentType(contentType)} 수정`;
                cmsItemId.value = itemId;
                cmsTitleInput.value = item.title || item.question_text || '';
                cmsContentTextarea.value = item.content || '';

                // 심리 테스트 문항일 때만 옵션 필드 표시 및 값 설정
                if (contentType === 'psych_test_questions') {
                    cmsOptionsGroup.classList.remove('hidden');
                    cmsOptionsTextarea.value = item.options ? JSON.stringify(item.options, null, 2) : '[]';
                } else {
                    cmsOptionsGroup.classList.add('hidden');
                    cmsOptionsTextarea.value = '';
                }

                cmsModal.classList.add('visible');
            } catch (error) {
                console.error('CMS 콘텐츠 정보 로드 중 오류 발생:', error);
                await showAlert('콘텐츠 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }

        // CMS 콘텐츠 저장 (추가/수정)
        cmsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const contentType = cmsContentType.value;
            const title = cmsTitleInput.value.trim();
            const content = cmsContentTextarea.value.trim();
            let options = [];

            if (!title || !content) {
                await showAlert('제목/질문과 내용은 필수입니다.');
                return;
            }

            if (contentType === 'psych_test_questions') {
                const optionsString = cmsOptionsTextarea.value.trim();
                if (optionsString) {
                    try {
                        options = JSON.parse(optionsString);
                        // 옵션 배열의 각 항목이 올바른 형식인지 간단히 검증
                        if (!Array.isArray(options) || !options.every(opt => typeof opt === 'object' && 'text' in opt && 'score' in opt)) {
                            await showAlert('옵션 형식이 올바르지 않습니다. JSON 배열 형태로 입력하고 각 항목은 text와 score를 포함해야 합니다.');
                            return;
                        }
                    } catch (jsonError) {
                        await showAlert('옵션 JSON 형식이 올바르지 않습니다. JSON 파싱 오류: ' + jsonError.message);
                        return;
                    }
                }
            }

            const itemData = {
                title: title,
                content: content,
                options: options // 심리 테스트 문항에만 해당
            };

            let response;
            let result;

            try {
                if (editingCmsItemId) { // 수정
                    response = await fetchWithAuth(`/api/admin/cms/${contentType}/${editingCmsItemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                } else { // 추가
                    response = await fetchWithAuth(`/api/admin/cms/${contentType}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                }

                result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '콘텐츠가 성공적으로 저장되었습니다.');
                    cmsModal.classList.remove('visible');
                    // 현재 선택된 콘텐츠 유형에 따라 목록 새로고침
                    if (currentSelectedContentType === 'psych_test_questions') {
                        fetchPsychQuestions();
                    }
                    // 다른 유형의 콘텐츠도 필요하다면 여기에 추가
                } else {
                    await showAlert(result.message || '콘텐츠 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('CMS 콘텐츠 저장 중 오류 발생:', error);
                await showAlert('콘텐츠 저장 중 네트워크 오류가 발생했습니다.');
            }
        });

        // CMS 콘텐츠 삭제
        async function deleteCmsItem(itemId, contentType) {
            const confirmed = await showConfirm('정말로 이 콘텐츠를 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetchWithAuth(`/api/admin/cms/${contentType}/${itemId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await showAlert('콘텐츠가 성공적으로 삭제되었습니다.');
                    // 현재 선택된 콘텐츠 유형에 따라 목록 새로고침
                    if (currentSelectedContentType === 'psych_test_questions') {
                        fetchPsychQuestions();
                    }
                } else {
                    await showAlert('콘텐츠 삭제 실패.');
                }
            } catch (error) {
                console.error('Error deleting CMS item:', error);
                await showAlert('콘텐츠 삭제 중 오류가 발생했습니다.');
            }
        }

        // 콘텐츠 유형 한글명 반환 함수
        function getKoreanContentType(type) {
            switch(type) {
                case 'psych_test_questions': return '심리 테스트 문항';
                case 'chatbot_responses': return '챗봇 답변 데이터';
                case 'risk_detection_materials': return '위험 감지 자료';
                default: return '콘텐츠';
            }
        }

        // 초기 로드 시 관리자 접근 권한 확인
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                // 초기에는 contentManagementArea의 내용을 비우고 initialMessage만 표시
                contentManagementArea.innerHTML = ''; 
                initialMessage.classList.remove('hidden');
                
                // '심리 테스트 문항' 버튼을 기본으로 활성화하고 해당 콘텐츠 로드
                // 이 부분이 페이지 로드 시 바로 심리 테스트 문항 섹션이 보이도록 합니다.
                selectContentType('psych_test_questions'); 
            }
        });
    </script>
{% endblock %}
=======
<!-- frontend/templates/cms_management.html -->
{% extends "base.html" %}

{% block title %}CMS 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cms_management.css') }}"> {# CMS 관리 전용 CSS #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>CMS 관리</h1>
        <p>심리 테스트 문항, 챗봇 답변 데이터, 위험 감지 자료 등을 관리합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>콘텐츠 유형 선택</h2>
            <div class="content-type-selection">
                <button class="content-type-button" data-content-type="psych_test_questions">심리 테스트 문항</button>
                <button class="content-type-button" data-content-type="chatbot_responses">챗봇 답변 데이터</button>
                <button class="content-type-button" data-content-type="risk_detection_materials">위험 감지 자료</button>
            </div>

            <div class="content-management-area">
                <p id="initialMessage" class="initial-message">콘텐츠 유형을 선택하여 관리할 수 있습니다.</p>
                
                {# 각 콘텐츠 섹션을 동적으로 로드할 것이므로, 여기서는 초기 HTML을 제거합니다. #}
                {# JavaScript에서 이 div들을 직접 생성하고 삽입합니다. #}
            </div>
        </div>
    </div>

    <!-- CMS 콘텐츠 추가/수정 모달 -->
    <div id="cmsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="cmsModalTitle">새 심리 테스트 문항 추가</h3>
            <form id="cmsForm">
                <input type="hidden" id="cmsItemId">
                <input type="hidden" id="cmsContentType">
                <div class="form-group">
                    <label for="cmsTitle">제목/질문</label>
                    <input type="text" id="cmsTitle" required>
                </div>
                <div class="form-group">
                    <label for="cmsContent">내용/설명</label>
                    <textarea id="cmsContent" rows="5" required></textarea>
                </div>
                <div class="form-group" id="cmsOptionsGroup"> {# 옵션 필드 그룹 #}
                    <label for="cmsOptions">옵션 (JSON 배열 형식, 예: [{"text": "예", "score": 1}, {"text": "아니오", "score": 0}])</label>
                    <textarea id="cmsOptions" rows="5" placeholder='[{"text": "선택지1", "score": 1}, {"text": "선택지2", "score": 0}]'></textarea>
                </div>
                <button type="submit" class="button primary">저장</button>
                <button type="button" id="closeCmsModalButton" class="button secondary" style="margin-left: 10px;">취소</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const contentTypeButtons = document.querySelectorAll('.content-type-button');
        const initialMessage = document.getElementById('initialMessage');
        const contentManagementArea = document.querySelector('.content-management-area'); // 부모 컨테이너

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        // CMS 모달 관련 DOM
        const cmsModal = document.getElementById('cmsModal');
        const cmsModalTitle = document.getElementById('cmsModalTitle');
        const cmsForm = document.getElementById('cmsForm');
        const cmsItemId = document.getElementById('cmsItemId');
        const cmsContentType = document.getElementById('cmsContentType');
        const cmsTitleInput = document.getElementById('cmsTitle');
        const cmsContentTextarea = document.getElementById('cmsContent');
        const cmsOptionsGroup = document.getElementById('cmsOptionsGroup');
        const cmsOptionsTextarea = document.getElementById('cmsOptions');
        const closeCmsModalButton = document.getElementById('closeCmsModalButton');

        let currentSelectedContentType = null; // 현재 선택된 콘텐츠 유형
        let editingCmsItemId = null; // 현재 편집 중인 CMS 아이템 ID

        // 접근 권한 확인 함수 (기존과 동일)
        async function checkAdminAccess() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('관리자 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response || !response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];

                if (!userRoles.includes('관리자')) {
                    await showAlert('관리자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('접근 권한 확인 중 오류 발생:', error);
                await showAlert('관리자 접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 콘텐츠 유형 버튼 클릭 이벤트
        contentTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const contentType = button.dataset.contentType;
                selectContentType(contentType);
            });
        });

        // 콘텐츠 유형 선택 처리 함수
        async function selectContentType(type) {
            currentSelectedContentType = type;
            initialMessage.classList.add('hidden');
            
            // contentManagementArea의 모든 자식 요소를 제거하여 섹션 초기화
            contentManagementArea.innerHTML = ''; 

            // 모든 버튼의 활성 상태 초기화
            contentTypeButtons.forEach(btn => btn.classList.remove('primary', 'secondary'));
            contentTypeButtons.forEach(btn => btn.classList.add('secondary')); // 모든 버튼을 secondary로 설정

            // 선택된 버튼 활성화
            const selectedButton = document.querySelector(`.content-type-button[data-content-type="${type}"]`);
            if (selectedButton) {
                selectedButton.classList.remove('secondary');
                selectedButton.classList.add('primary');
            }

            // 선택된 유형에 따라 동적으로 섹션 생성 및 로드
            let sectionHtml = '';
            switch (type) {
                case 'psych_test_questions':
                    sectionHtml = `
                        <div id="psychTestQuestionsSection" class="content-section">
                            <h2 class="section-title">심리 테스트 문항 관리</h2>
                            <button id="addPsychQuestionButton" class="button primary">새 심리 테스트 문항 추가</button>
                            <div class="data-table-container">
                                <table class="data-list-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>제목/질문</th>
                                            <th>내용/설명</th>
                                            <th>옵션</th>
                                            <th>액션</th>
                                        </tr>
                                    </thead>
                                    <tbody id="psychQuestionTableBody">
                                        <tr><td colspan="5" class="loading-row">문항을 불러오는 중...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <p id="noPsychQuestionsMessage" class="no-data-message hidden">심리 테스트 문항이 없습니다.</p>
                        </div>
                    `;
                    contentManagementArea.innerHTML = sectionHtml;
                    
                    // 동적으로 생성된 요소에 이벤트 리스너를 바인딩
                    // DOM 업데이트가 완료된 후 실행되도록 보장
                    // fetchPsychQuestions() 함수 내에서 DOM 요소들을 다시 쿼리하므로,
                    // 이 setTimeout은 addPsychQuestionButton에 대한 이벤트 리스너만 바인딩합니다.
                    setTimeout(() => {
                        const addPsychQuestionButton = document.getElementById('addPsychQuestionButton');
                        if (addPsychQuestionButton) {
                            addPsychQuestionButton.addEventListener('click', () => {
                                openCmsModalForAdd('psych_test_questions');
                            });
                        }
                        fetchPsychQuestions(); // 데이터 로드
                    }, 0); // 0ms 지연으로 DOM 업데이트 후 실행 보장
                    break;
                case 'chatbot_responses':
                    sectionHtml = `
                        <div id="chatbotResponsesSection" class="content-section">
                            <h2 class="section-title">챗봇 답변 데이터 관리</h2>
                            <p>챗봇 답변 데이터 관리 기능은 아직 준비 중입니다.</p>
                        </div>
                    `;
                    contentManagementArea.innerHTML = sectionHtml;
                    break;
                case 'risk_detection_materials':
                    sectionHtml = `
                        <div id="riskDetectionSection" class="content-section">
                            <h2 class="section-title">위험 감지 자료 관리</h2>
                            <p>위험 감지 자료 관리 기능은 아직 준비 중입니다.</p>
                        </div>
                    `;
                    contentManagementArea.innerHTML = sectionHtml;
                    break;
                default:
                    initialMessage.classList.remove('hidden'); // 기본 메시지 다시 표시
                    break;
            }
        }

        // 심리 테스트 문항 불러오기
        async function fetchPsychQuestions() {
            // 동적으로 생성된 요소를 다시 쿼리
            const psychQuestionTableBody = document.getElementById('psychQuestionTableBody');
            const noPsychQuestionsMessage = document.getElementById('noPsychQuestionsMessage');

            // 요소가 존재하지 않으면 오류 로그를 남기고 재시도하지 않음 (무한 루프 방지)
            if (!psychQuestionTableBody || !noPsychQuestionsMessage) {
                console.error("DOM elements for psych questions section not found after dynamic load. Cannot fetch data.");
                return; 
            }

            psychQuestionTableBody.innerHTML = '<tr><td colspan="5" class="loading-row">문항을 불러오는 중...</td></tr>';
            noPsychQuestionsMessage.classList.add('hidden');

            try {
                const response = await fetchWithAuth(`/api/admin/cms/psych_test_questions`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '심리 테스트 문항을 불러오는 데 실패했습니다.');
                    psychQuestionTableBody.innerHTML = '<tr><td colspan="5" class="error-row">문항을 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                renderPsychQuestionsTable(data.content);
            } catch (error) {
                console.error('심리 테스트 문항 로드 중 오류 발생:', error);
                await showAlert('심리 테스트 문항을 불러오는 중 네트워크 오류가 발생했습니다.');
                psychQuestionTableBody.innerHTML = '<tr><td colspan="5" class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 심리 테스트 문항 테이블 렌더링
        function renderPsychQuestionsTable(questions) {
            // 동적으로 생성된 요소를 다시 쿼리
            const psychQuestionTableBody = document.getElementById('psychQuestionTableBody');
            const noPsychQuestionsMessage = document.getElementById('noPsychQuestionsMessage');

            // 요소가 존재하지 않으면 오류 로그를 남기고 재시도하지 않음
            if (!psychQuestionTableBody || !noPsychQuestionsMessage) {
                console.error("DOM elements for psych questions section not found during render. Cannot render table.");
                return; 
            }

            psychQuestionTableBody.innerHTML = '';
            if (questions.length === 0) {
                noPsychQuestionsMessage.classList.remove('hidden');
                return;
            }
            noPsychQuestionsMessage.classList.add('hidden');

            questions.forEach(question => {
                const row = psychQuestionTableBody.insertRow();
                // options가 배열이고 각 요소가 객체인 경우 text 속성만 추출하여 표시
                const optionsDisplay = (question.options && Array.isArray(question.options)) 
                                     ? question.options.map(opt => opt.text).join(', ') 
                                     : '없음';
                
                row.innerHTML = `
                    <td>${String(question._id).substring(0, 8)}...</td>
                    <td>${question.title || question.question_text || '-'}</td>
                    <td>${question.content || '-'}</td>
                    <td class="options-cell">${optionsDisplay}</td>
                    <td class="action-cell">
                        <button class="button small secondary edit-cms-item-button" data-item-id="${String(question._id)}" data-content-type="psych_test_questions">수정</button>
                        <button class="button small danger delete-cms-item-button" data-item-id="${String(question._id)}" data-content-type="psych_test_questions">삭제</button>
                    </td>
                `;
            });

            // 동적으로 생성된 버튼에 이벤트 리스너 다시 바인딩
            document.querySelectorAll('.edit-cms-item-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const contentType = e.target.dataset.contentType;
                    openCmsModalForEdit(itemId, contentType);
                });
            });

            document.querySelectorAll('.delete-cms-item-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const contentType = e.target.dataset.contentType;
                    deleteCmsItem(itemId, contentType);
                });
            });
        }

        // 새 CMS 콘텐츠 추가 버튼 클릭 시 (openCmsModalForAdd 함수로 통합)
        function openCmsModalForAdd(type) {
            cmsModalTitle.textContent = `새 ${getKoreanContentType(type)} 추가`;
            cmsForm.reset();
            editingCmsItemId = null;
            cmsContentType.value = type; // 숨겨진 필드에 콘텐츠 유형 설정
            cmsOptionsGroup.classList.toggle('hidden', type !== 'psych_test_questions'); // 심리 테스트 문항일 때만 옵션 필드 표시

            cmsModal.classList.add('visible');
        }

        // CMS 모달 닫기
        closeCmsModalButton.addEventListener('click', () => {
            cmsModal.classList.remove('visible');
            editingCmsItemId = null;
            // 모달 닫을 때 옵션 필드 숨김 상태로 되돌림 (필요시)
            // cmsOptionsGroup.classList.add('hidden'); 
        });

        // CMS 콘텐츠 수정 모달 열기
        async function openCmsModalForEdit(itemId, contentType) {
            editingCmsItemId = itemId;
            cmsContentType.value = contentType; // 숨겨진 필드에 콘텐츠 유형 설정

            try {
                const response = await fetchWithAuth(`/api/admin/cms/${contentType}/${itemId}`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '콘텐츠 정보를 불러오는 데 실패했습니다.');
                    return;
                }
                const item = await response.json();

                cmsModalTitle.textContent = `${getKoreanContentType(contentType)} 수정`;
                cmsItemId.value = itemId;
                cmsTitleInput.value = item.title || item.question_text || '';
                cmsContentTextarea.value = item.content || '';

                // 심리 테스트 문항일 때만 옵션 필드 표시 및 값 설정
                if (contentType === 'psych_test_questions') {
                    cmsOptionsGroup.classList.remove('hidden');
                    cmsOptionsTextarea.value = item.options ? JSON.stringify(item.options, null, 2) : '[]';
                } else {
                    cmsOptionsGroup.classList.add('hidden');
                    cmsOptionsTextarea.value = '';
                }

                cmsModal.classList.add('visible');
            } catch (error) {
                console.error('CMS 콘텐츠 정보 로드 중 오류 발생:', error);
                await showAlert('콘텐츠 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }

        // CMS 콘텐츠 저장 (추가/수정)
        cmsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const contentType = cmsContentType.value;
            const title = cmsTitleInput.value.trim();
            const content = cmsContentTextarea.value.trim();
            let options = [];

            if (!title || !content) {
                await showAlert('제목/질문과 내용은 필수입니다.');
                return;
            }

            if (contentType === 'psych_test_questions') {
                const optionsString = cmsOptionsTextarea.value.trim();
                if (optionsString) {
                    try {
                        options = JSON.parse(optionsString);
                        // 옵션 배열의 각 항목이 올바른 형식인지 간단히 검증
                        if (!Array.isArray(options) || !options.every(opt => typeof opt === 'object' && 'text' in opt && 'score' in opt)) {
                            await showAlert('옵션 형식이 올바르지 않습니다. JSON 배열 형태로 입력하고 각 항목은 text와 score를 포함해야 합니다.');
                            return;
                        }
                    } catch (jsonError) {
                        await showAlert('옵션 JSON 형식이 올바르지 않습니다. JSON 파싱 오류: ' + jsonError.message);
                        return;
                    }
                }
            }

            const itemData = {
                title: title,
                content: content,
                options: options // 심리 테스트 문항에만 해당
            };

            let response;
            let result;

            try {
                if (editingCmsItemId) { // 수정
                    response = await fetchWithAuth(`/api/admin/cms/${contentType}/${editingCmsItemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                } else { // 추가
                    response = await fetchWithAuth(`/api/admin/cms/${contentType}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                }

                result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '콘텐츠가 성공적으로 저장되었습니다.');
                    cmsModal.classList.remove('visible');
                    // 현재 선택된 콘텐츠 유형에 따라 목록 새로고침
                    if (currentSelectedContentType === 'psych_test_questions') {
                        fetchPsychQuestions();
                    }
                    // 다른 유형의 콘텐츠도 필요하다면 여기에 추가
                } else {
                    await showAlert(result.message || '콘텐츠 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('CMS 콘텐츠 저장 중 오류 발생:', error);
                await showAlert('콘텐츠 저장 중 네트워크 오류가 발생했습니다.');
            }
        });

        // CMS 콘텐츠 삭제
        async function deleteCmsItem(itemId, contentType) {
            const confirmed = await showConfirm('정말로 이 콘텐츠를 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetchWithAuth(`/api/admin/cms/${contentType}/${itemId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await showAlert('콘텐츠가 성공적으로 삭제되었습니다.');
                    // 현재 선택된 콘텐츠 유형에 따라 목록 새로고침
                    if (currentSelectedContentType === 'psych_test_questions') {
                        fetchPsychQuestions();
                    }
                } else {
                    await showAlert('콘텐츠 삭제 실패.');
                }
            } catch (error) {
                console.error('Error deleting CMS item:', error);
                await showAlert('콘텐츠 삭제 중 오류가 발생했습니다.');
            }
        }

        // 콘텐츠 유형 한글명 반환 함수
        function getKoreanContentType(type) {
            switch(type) {
                case 'psych_test_questions': return '심리 테스트 문항';
                case 'chatbot_responses': return '챗봇 답변 데이터';
                case 'risk_detection_materials': return '위험 감지 자료';
                default: return '콘텐츠';
            }
        }

        // 초기 로드 시 관리자 접근 권한 확인
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                // 초기에는 contentManagementArea의 내용을 비우고 initialMessage만 표시
                contentManagementArea.innerHTML = ''; 
                initialMessage.classList.remove('hidden');
                
                // '심리 테스트 문항' 버튼을 기본으로 활성화하고 해당 콘텐츠 로드
                // 이 부분이 페이지 로드 시 바로 심리 테스트 문항 섹션이 보이도록 합니다.
                selectContentType('psych_test_questions'); 
            }
        });
    </script>
{% endblock %}
>>>>>>> 32e57f7623365b93a09d34dc9cad501cc18c11af
