<!-- frontend/templates/db_management.html -->
{% extends "base.html" %}

{% block title %}DB 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/db_management.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>DB 관리</h1>
        <p>상담 기록 및 요약본 데이터를 조회하고 관리합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>상담 기록 조회</h2>
            <div class="search-bar">
                <input type="text" id="userIdSearchInput" placeholder="사용자 ID 또는 이메일로 검색...">
                <button id="searchDbButton" class="button primary">검색</button>
            </div>
            <div class="data-table-container">
                <table class="data-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>사용자 ID</th>
                            <th>상담 유형</th>
                            <th>일시</th>
                            <th>요약</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="dbTableBody">
                        <tr><td colspan="6" class="loading-row">데이터를 불러오는 중...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="noDataMessage" class="no-data-message hidden">데이터가 없습니다.</p>
        </div>
    </div>

    <!-- 상세 보기 모달 -->
    <div id="detailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="detailModalTitle">상담 기록 상세</h3>
            <div class="detail-content">
                <p><strong>상담 ID:</strong> <span id="detailId"></span></p>
                <p><strong>사용자 ID:</strong> <span id="detailUserId"></span></p>
                <p><strong>상담 유형:</strong> <span id="detailType"></span></p>
                <p><strong>상담 일시:</strong> <span id="detailTimestamp"></span></p>
                <p><strong>상담 요약:</strong> <span id="detailSummary"></span></p>
                <p><strong>전체 대화 내용:</strong></p>
                <div id="detailConversation" class="conversation-area"></div>
            </div>
            <button class="button primary" id="closeDetailModalButton">닫기</button>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const dbTableBody = document.getElementById('dbTableBody');
        const userIdSearchInput = document.getElementById('userIdSearchInput');
        const searchDbButton = document.getElementById('searchDbButton');
        const noDataMessage = document.getElementById('noDataMessage');
        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        const detailModal = document.getElementById('detailModal');
        const closeDetailModalButton = document.getElementById('closeDetailModalButton');
        const detailModalTitle = document.getElementById('detailModalTitle');
        const detailId = document.getElementById('detailId');
        const detailUserId = document.getElementById('detailUserId');
        const detailType = document.getElementById('detailType');
        const detailTimestamp = document.getElementById('detailTimestamp');
        const detailSummary = document.getElementById('detailSummary');
        const detailConversation = document.getElementById('detailConversation');

        let allDbRecords = []; // 모든 DB 기록 데이터를 저장할 배열

        // 접근 권한 확인 함수 (관리자, 개발자, 연구자)
        async function checkDbAccess() {
            console.log('checkDbAccess (db_management): 함수 시작');
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('DB 관리 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response) { return false; }
                if (!response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkDbAccess (db_management): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자') && !userRoles.includes('개발자') && !userRoles.includes('연구자')) {
                    await showAlert('관리자, 개발자, 연구자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('checkDbAccess (db_management): 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 모든 상담 기록 불러오기 (임시)
        async function fetchAllDbRecords() {
            dbTableBody.innerHTML = '<tr><td colspan="6" class="loading-row">데이터를 불러오는 중...</td></tr>';
            noDataMessage.classList.add('hidden');

            try {
                // TODO: 실제 상담 기록을 불러오는 API 엔드포인트 구현 필요
                // 현재는 임시 데이터 또는 빈 배열 반환
                const response = await fetchWithAuth('/api/admin/db_records'); // 임시 API 엔드포인트
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '상담 기록을 불러오는 데 실패했습니다.');
                    dbTableBody.innerHTML = '<tr><td colspan="6" class="error-row">상담 기록을 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                allDbRecords = data.records || []; // 'records' 필드에 데이터가 있다고 가정
                renderDbTable(allDbRecords);
            } catch (error) {
                console.error('상담 기록 로드 중 오류 발생:', error);
                await showAlert('상담 기록을 불러오는 중 네트워크 오류가 발생했습니다.');
                dbTableBody.innerHTML = '<tr><td colspan="6" class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 테이블 렌더링
        function renderDbTable(recordsToRender) {
            dbTableBody.innerHTML = '';
            if (recordsToRender.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');

            recordsToRender.forEach(record => {
                const row = dbTableBody.insertRow();
                const displayTimestamp = record.timestamp ? new Date(record.timestamp).toLocaleString() : '-';

                row.innerHTML = `
                    <td>${record.id || record._id || '-'}</td>
                    <td>${record.user_id || '-'}</td>
                    <td>${record.type || '-'}</td>
                    <td>${displayTimestamp}</td>
                    <td>${record.summary || '-'}</td>
                    <td class="action-cell">
                        <button class="button small secondary view-detail-button" data-record-id="${record.id || record._id}">상세 보기</button>
                    </td>
                `;
            });

            document.querySelectorAll('.view-detail-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.target.dataset.recordId;
                    openDetailModal(recordId);
                });
            });
        }

        // 상세 보기 모달 열기
        function openDetailModal(recordId) {
            const record = allDbRecords.find(r => (r.id == recordId || r._id == recordId));
            if (!record) {
                showAlert('기록을 찾을 수 없습니다.');
                return;
            }

            detailId.textContent = record.id || record._id || '-';
            detailUserId.textContent = record.user_id || '-';
            detailType.textContent = record.type || '-';
            detailTimestamp.textContent = record.timestamp ? new Date(record.timestamp).toLocaleString() : '-';
            detailSummary.textContent = record.summary || '-';
            
            // 대화 내용 렌더링 (예시)
            detailConversation.innerHTML = '';
            if (record.conversation && Array.isArray(record.conversation)) {
                record.conversation.forEach(msg => {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${msg.role}:</strong> ${msg.text}`;
                    detailConversation.appendChild(p);
                });
            } else {
                detailConversation.textContent = '대화 내용 없음.';
            }

            detailModal.classList.add('visible');
        }

        // 상세 보기 모달 닫기
        closeDetailModalButton.addEventListener('click', () => {
            detailModal.classList.remove('visible');
        });

        // 검색 기능 (임시)
        searchDbButton.addEventListener('click', () => {
            const searchTerm = userIdSearchInput.value.toLowerCase().trim();
            const filteredRecords = allDbRecords.filter(record => {
                const userIdMatch = (record.user_id && String(record.user_id).toLowerCase().includes(searchTerm));
                const userEmailMatch = (record.user_email && record.user_email.toLowerCase().includes(searchTerm)); // 가정: 백엔드에서 이메일도 제공
                return userIdMatch || userEmailMatch;
            });
            renderDbTable(filteredRecords);
        });

        userIdSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchDbButton.click();
            }
        });

        // 초기 로드 시 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkDbAccess();
            if (hasAccess) {
                fetchAllDbRecords();
            }
        });
    </script>
{% endblock %}
