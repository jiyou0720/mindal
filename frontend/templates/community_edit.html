{% extends "base.html" %}

{% block title %}게시글 수정 - 영마인드링크{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_edit.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="community-create-container">
        <h1 class="create-post-title">게시글 수정</h1>
        <form id="editPostForm" class="create-post-form">
            <div class="form-group">
                <label for="postTitle">제목</label>
                <input type="text" id="postTitle" name="title" required placeholder="게시글 제목을 입력하세요">
            </div>

            <div class="form-group">
                <label for="postCategory">카테고리</label>
                <select id="postCategory" name="category" required>
                    <option value="">카테고리 선택</option>
                    <option value="daily">일상</option>
                    <option value="emotion">감정</option>
                    <option value="photo">사진</option>
                    <option value="music">음악</option>
                    <option value="secret">비밀</option>
                </select>
            </div>

            <div class="form-group">
                <label for="postContent">내용</label>
                <textarea id="postContent" name="content" rows="10" placeholder="내용을 입력하세요..." required></textarea>
            </div>

            <div class="form-group attachment-upload-group">
                <label for="attachmentUpload">첨부 파일</label>
                <input type="file" id="attachmentUpload" name="attachments" multiple accept="image/*,audio/*">
                <p class="file-info">이미지 또는 오디오 파일을 첨부할 수 있습니다.</p>
            </div>

            <div id="currentAttachments" class="current-attachments">
                <!-- 현재 첨부파일이 여기에 표시됩니다 -->
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" id="isAnonymous" name="is_anonymous">
                <label for="isAnonymous">익명으로 작성</label>
            </div>

            <div class="button-group">
                <button type="submit" class="button primary">수정 완료</button>
                <button type="button" class="button secondary" onclick="history.back()">취소</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postId = window.location.pathname.split('/').pop(); // URL에서 게시글 ID 추출
            const editPostForm = document.getElementById('editPostForm');
            const postTitleInput = document.getElementById('postTitle');
            const postCategorySelect = document.getElementById('postCategory');
            const postContentTextarea = document.getElementById('postContent');
            const isAnonymousCheckbox = document.getElementById('isAnonymous');
            const attachmentUploadInput = document.getElementById('attachmentUpload');
            const currentAttachmentsContainer = document.getElementById('currentAttachments');

            const loginUrl = "{{ url_for('login') }}";
            const communityListUrl = "{{ url_for('community_list') }}";
            const communityDetailUrlBase = "{{ url_for('community_detail', post_id='') }}";


            // localStorage에서 현재 로그인된 사용자 정보 가져오기
            const currentUserId = localStorage.getItem('user_id');
            let currentUserRoles = [];
            const userRolesString = localStorage.getItem('user_roles');
            if (userRolesString) {
                try {
                    currentUserRoles = JSON.parse(userRolesString);
                } catch (e) {
                    console.error("Error parsing user roles from localStorage:", e);
                }
            }
            console.log("Current user roles:", currentUserRoles); // 디버깅용

            // 관리자 역할인지 확인하는 헬퍼 함수
            const isAdmin = () => currentUserRoles.includes('관리자');

            let existingAttachments = []; // 기존 첨부파일 URL을 저장할 배열

            // 게시글 상세 정보를 불러와 폼에 채우기
            async function fetchPostDetailForEdit() {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    const response = await fetchWithAuth(`/api/community/posts/${postId}`, { // fetchWithAuth 사용
                        method: 'GET'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        const post = result.post;
                        const mongoContent = result.content; // MongoDB에서 가져온 실제 content와 attachments

                        // 권한 확인: 게시글 작성자 본인이거나 관리자만 수정 가능
                        if (parseInt(post.author_id) !== parseInt(currentUserId) && !isAdmin()) {
                            await showAlert('이 게시글을 수정할 권한이 없습니다.'); // alert 대신 showAlert
                            window.location.href = `${communityDetailUrlBase}${postId}`;
                            return;
                        }

                        postTitleInput.value = post.title;
                        postCategorySelect.value = post.category;
                        postContentTextarea.value = mongoContent.content; // MongoDB에서 가져온 내용 사용
                        isAnonymousCheckbox.checked = post.is_anonymous;

                        existingAttachments = mongoContent.attachment_paths || []; // 'attachments' 대신 'attachment_paths' 사용
                        renderCurrentAttachments();

                    } else {
                        await showAlert(result.message || '게시글을 불러오는 데 실패했습니다.'); // alert 대신 showAlert
                        window.location.href = communityListUrl;
                    }
                } catch (error) {
                    console.error('Error fetching post detail for edit:', error);
                    await showAlert('게시글 정보를 불러오는 중 오류가 발생했습니다.'); // alert 대신 showAlert
                    window.location.href = communityListUrl;
                }
            }

            // 현재 첨부파일을 렌더링하는 함수
            function renderCurrentAttachments() {
                currentAttachmentsContainer.innerHTML = '';
                if (existingAttachments.length > 0) {
                    const title = document.createElement('h3');
                    title.textContent = '현재 첨부 파일:';
                    currentAttachmentsContainer.appendChild(title);

                    existingAttachments.forEach((attachment, index) => {
                        const attachmentItem = document.createElement('div');
                        attachmentItem.className = 'attachment-item';

                        const attachmentName = attachment.split('/').pop(); // 파일명 추출
                        const attachmentType = attachmentName.split('.').pop().toLowerCase();

                        let displayElement;
                        if (['png', 'jpg', 'jpeg', 'gif'].includes(attachmentType)) {
                            displayElement = document.createElement('img');
                            displayElement.src = attachment;
                            displayElement.alt = attachmentName;
                            displayElement.style.maxWidth = '100px';
                            displayElement.style.maxHeight = '100px';
                        } else if (['mp3', 'wav'].includes(attachmentType)) {
                            displayElement = document.createElement('audio');
                            displayElement.controls = true;
                            displayElement.src = attachment;
                        } else {
                             displayElement = document.createElement('a');
                             displayElement.href = attachment;
                             displayElement.textContent = attachmentName;
                             displayElement.target = '_blank';
                        }
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.type = 'button';
                        deleteButton.className = 'delete-attachment-button';
                        deleteButton.innerHTML = '&times;'; // X 아이콘
                        deleteButton.title = '첨부파일 삭제';
                        deleteButton.addEventListener('click', () => {
                            // 배열에서 해당 첨부파일 제거
                            existingAttachments.splice(index, 1);
                            renderCurrentAttachments(); // 목록 다시 렌더링
                        });

                        attachmentItem.appendChild(displayElement);
                        attachmentItem.appendChild(deleteButton);
                        currentAttachmentsContainer.appendChild(attachmentItem);
                    });
                }
            }


            // 폼 제출 이벤트 핸들러
            editPostForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                const formData = new FormData();
                formData.append('title', postTitleInput.value.trim());
                formData.append('category', postCategorySelect.value);
                formData.append('content', postContentTextarea.value.trim());
                formData.append('is_anonymous', isAnonymousCheckbox.checked ? 'true' : 'false');
                formData.append('existing_attachments', JSON.stringify(existingAttachments)); // 기존 첨부파일 목록 전송

                // 새로 추가된 파일들 추가
                Array.from(attachmentUploadInput.files).forEach(file => {
                    formData.append('new_attachments', file);
                });

                try {
                    const response = await fetchWithAuth(`/api/community/posts/${postId}`, { // fetchWithAuth 사용
                        method: 'PUT', // PUT 요청
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // FormData를 사용할 때는 'Content-Type': 'multipart/form-data'를 명시적으로 설정하지 않습니다.
                            // 브라우저가 자동으로 Boundary를 포함하여 설정합니다.
                        },
                        body: formData
                    });
                    const result = await response.json();

                    // 응답 상태 및 메시지 로깅
                    console.log("--- Server Response ---");
                    console.log("Status:", response.status);
                    console.log("Result:", result);
                    console.log("-----------------------");


                    if (response.ok) {
                        await showAlert(result.message || '게시글이 성공적으로 수정되었습니다!'); // alert 대신 showAlert
                        window.location.href = `${communityDetailUrlBase}${postId}`; // 상세 페이지로 이동
                    } else {
                        await showAlert(result.message || '게시글 수정에 실패했습니다.'); // alert 대신 showAlert
                        // fetchWithAuth에서 401 처리하므로 여기서는 추가 처리 불필요
                    }
                } catch (error) {
                    console.error('Error updating post:', error);
                    await showAlert('게시글 수정 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            });

            fetchPostDetailForEdit();
        });
    </script>
{% endblock %}
