{% extends "base.html" %}

{% block title %}게시글 수정 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_edit.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="community-create-container">
        <h1 class="create-post-title">게시글 수정</h1>
        <form id="editPostForm" class="create-post-form">
            <div class="form-group">
                <label for="postTitle">제목</label>
                <input type="text" id="postTitle" name="title" required placeholder="게시글 제목을 입력하세요">
            </div>

            <div class="form-group">
                <label for="postCategory">카테고리</label>
                <select id="postCategory" name="category" required>
                    <option value="">카테고리 선택</option>
                    <option value="자유 게시판">자유 게시판</option>
                    <option value="질문 게시판">질문 게시판</option>
                    <option value="정보 공유">정보 공유</option>
                    <option value="건의 사항">건의 사항</option>
                </select>
            </div>

            <div class="form-group">
                <label for="postContent">내용</label>
                <textarea id="postContent" name="content" rows="10" placeholder="내용을 입력하세요..." required></textarea>
            </div>

            <div class="form-group attachment-upload-group">
                <label for="attachmentUpload">첨부 파일</label>
                <input type="file" id="attachmentUpload" name="attachments" multiple accept="image/*,audio/*">
                <p class="file-info">이미지 또는 오디오 파일을 첨부할 수 있습니다.</p>
            </div>

            <div id="currentAttachments" class="current-attachments">
                <!-- 현재 첨부파일이 여기에 표시됩니다 -->
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" id="isAnonymous" name="is_anonymous">
                <label for="isAnonymous">익명으로 작성</label>
            </div>

            <div class="button-group">
                <button type="submit" class="button primary">수정 완료</button>
                <button type="button" class="button secondary" onclick="history.back()">취소</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // URL 경로에서 게시글 ID를 정확히 추출
            // 예: /community/14/edit -> ["", "community", "14", "edit"]
            // 여기서 14를 가져오려면 인덱스 2를 사용
            const pathSegments = window.location.pathname.split('/');
            const postId = pathSegments[pathSegments.length - 2]; // <<< 이 부분 수정

            const editPostForm = document.getElementById('editPostForm');
            const postTitleInput = document.getElementById('postTitle');
            const postCategorySelect = document.getElementById('postCategory');
            const postContentTextarea = document.getElementById('postContent');
            const isAnonymousCheckbox = document.getElementById('isAnonymous');
            const attachmentUploadInput = document.getElementById('attachmentUpload');
            const currentAttachmentsContainer = document.getElementById('currentAttachments');

            const loginUrl = "{{ url_for('login') }}";
            const communityListUrl = "{{ url_for('community') }}";
            const communityDetailUrlBase = "{{ url_for('community') }}" + "/";


            const currentUserId = localStorage.getItem('user_id');
            let currentUserRoles = [];
            const userRolesString = localStorage.getItem('user_roles');
            if (userRolesString) {
                try {
                    currentUserRoles = JSON.parse(userRolesString);
                } catch (e) {
                    console.error("Error parsing user roles from localStorage:", e);
                }
            }
            console.log("Current user roles:", currentUserRoles);

            const isAdmin = () => currentUserRoles.includes('관리자');

            let existingAttachments = [];

            async function fetchPostDetailForEdit() {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.');
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    // 올바른 postId를 사용하여 API 호출
                    const response = await fetchWithAuth(`/api/community/posts/${postId}`, {
                        method: 'GET'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        const post = result;
                        const mongoContent = post.content;

                        if (parseInt(post.author_id) !== parseInt(currentUserId) && !isAdmin()) {
                            await showAlert('이 게시글을 수정할 권한이 없습니다.');
                            window.location.href = `${communityDetailUrlBase}${postId}`;
                            return;
                        }

                        postTitleInput.value = post.title;
                        postCategorySelect.value = post.category;
                        postContentTextarea.value = mongoContent;
                        isAnonymousCheckbox.checked = post.is_anonymous;

                        existingAttachments = [];
                        renderCurrentAttachments();

                    } else {
                        await showAlert(result.message || '게시글을 불러오는 데 실패했습니다.');
                        window.location.href = communityListUrl;
                    }
                } catch (error) {
                    console.error('Error fetching post detail for edit:', error);
                    await showAlert('게시글 정보를 불러오는 중 오류가 발생했습니다.');
                    window.location.href = communityListUrl;
                }
            }

            function renderCurrentAttachments() {
                currentAttachmentsContainer.innerHTML = '';
            }

            editPostForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.');
                    window.location.href = loginUrl;
                    return;
                }

                const formData = new FormData();
                formData.append('title', postTitleInput.value.trim());
                formData.append('category', postCategorySelect.value);
                formData.append('content', postContentTextarea.value.trim());
                formData.append('is_anonymous', isAnonymousCheckbox.checked ? 'true' : 'false');

                try {
                    const response = await fetchWithAuth(`/api/community/posts/${postId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    const result = await response.json();

                    console.log("--- Server Response ---");
                    console.log("Status:", response.status);
                    console.log("Result:", result);
                    console.log("-----------------------");


                    if (response.ok) {
                        await showAlert(result.message || '게시글이 성공적으로 수정되었습니다!');
                        window.location.href = `${communityDetailUrlBase}${postId}`;
                    } else {
                        await showAlert(result.message || '게시글 수정에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('Error updating post:', error);
                    await showAlert('게시글 수정 중 오류가 발생했습니다. 다시 시도해주세요.');
                }
            });

            fetchPostDetailForEdit();
        });
    </script>
{% endblock %}
