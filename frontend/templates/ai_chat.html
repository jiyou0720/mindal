<!--frontend/templates/ai_chat.html-->
{% extends "base.html" %}

{% block title %}AI 채팅 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai_chat.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="chat-main-area">
        <div class="chat-controls">
            <button id="showHistoryButton" class="button secondary small">대화 기록</button>
            <!-- "피드백 확인" 버튼 제거 -->
            <button id="endChatButton" class="button danger small">채팅 종료</button>
        </div>

        <div class="chat-messages-area" id="chatMessagesArea">
            <p class="chat-welcome-message">AI와 대화를 시작해보세요!</p>
        </div>

        <div class="chat-input-container">
            <input type="text" class="chat-input-field" id="chatInputField" placeholder="메시지를 입력하세요...">
            <button class="chat-send-button" id="chatSendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- 대화 기록 모달 -->
    <div id="historyModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="historyModalTitle">나의 대화 기록</h3>
            <div id="historyList" class="history-list">
                <p class="loading-row">기록을 불러오는 중...</p>
            </div>
            <button class="button primary" id="closeHistoryModalButton">닫기</button>
        </div>
    </div>

    <!-- 피드백 제출 모달 (기존) -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeFeedbackModalXButton">&times;</span>
            <h3>챗봇 피드백 제출</h3>
            <p>이번 상담에 대한 피드백을 남겨주세요.</p>
            <div class="rating-area">
                <label>별점:</label>
                <div class="stars" id="feedbackStars">
                    <i class="far fa-star" data-rating="1"></i>
                    <i class="far fa-star" data-rating="2"></i>
                    <i class="far fa-star" data-rating="3"></i>
                    <i class="far fa-star" data-rating="4"></i>
                    <i class="far fa-star" data-rating="5"></i>
                </div>
            </div>
            <div class="form-group">
                <label for="feedbackComment">의견:</label>
                <textarea id="feedbackComment" rows="5" placeholder="개선 사항이나 좋았던 점을 알려주세요."></textarea>
            </div>
            <button class="button primary" id="sendFeedbackButton">피드백 제출</button>
            <button class="button secondary" id="cancelFeedbackButton" style="margin-left: 10px;">취소</button>
        </div>
    </div>

    <!-- NEW: 나의 피드백 확인 모달 (관리자용) -->
    <div id="myFeedbackModal" class="modal hidden">
        <div class="modal-content large-modal">
            <span class="close-button" id="closeMyFeedbackModalXButton">&times;</span>
            <h3>내가 제출한 피드백</h3>
            <div id="myFeedbackList" class="my-feedback-list">
                <p class="loading-row">피드백을 불러오는 중...</p>
            </div>
            <div class="modal-actions">
                <button class="button primary" id="closeMyFeedbackModalButton">닫기</button>
            </div>
        </div>
    </div>

    <!-- 상담 요약 모달 -->
    <div id="summaryModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeSummaryModalXButton">&times;</span>
            <h3>상담 요약</h3>
            <div id="summaryContent" class="summary-content">
                <p>요약 내용을 불러오는 중...</p>
            </div>
            <button class="button primary" id="nextToFeedbackButton">다음</button>
        </div>
    </div>

    <!-- 커스텀 확인 모달 -->
    <div id="customConfirmModal" class="modal hidden">
        <div class="modal-content small-modal">
            <span class="close-button" id="closeCustomConfirmXButton">&times;</span>
            <h3 id="customConfirmTitle">확인</h3>
            <p id="customConfirmMessage">메시지</p>
            <div class="modal-actions">
                <button class="button primary" id="customConfirmOkButton">확인</button>
                <button class="button secondary" id="customConfirmCancelButton">취소</button>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        const chatMessagesArea = document.getElementById('chatMessagesArea');
        const chatInputField = document.getElementById('chatInputField');
        const chatSendButton = document.getElementById('chatSendButton');
        const showHistoryButton = document.getElementById('showHistoryButton');
        // const checkFeedbackButton = document.getElementById('checkFeedbackButton'); // 버튼 제거로 인해 주석 처리
        const endChatButton = document.getElementById('endChatButton');

        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const closeHistoryModalButton = document.getElementById('closeHistoryModalButton');
        const closeHistoryModalXButton = historyModal.querySelector('.close-button');

        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackStars = document.getElementById('feedbackStars');
        const feedbackComment = document.getElementById('feedbackComment');
        const sendFeedbackButton = document.getElementById('sendFeedbackButton');
        const cancelFeedbackButton = document.getElementById('cancelFeedbackButton');
        const closeFeedbackModalXButton = document.getElementById('closeFeedbackModalXButton');

        const myFeedbackModal = document.getElementById('myFeedbackModal');
        const myFeedbackList = document.getElementById('myFeedbackList');
        const closeMyFeedbackModalButton = document.getElementById('closeMyFeedbackModalButton');
        const closeMyFeedbackModalXButton = document.getElementById('closeMyFeedbackModalXButton');


        const summaryModal = document.getElementById('summaryModal');
        const summaryContent = document.getElementById('summaryContent');
        const nextToFeedbackButton = document.getElementById('nextToFeedbackButton');
        const closeSummaryModalXButton = document.getElementById('closeSummaryModalXButton');

        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmTitle = document.getElementById('customConfirmTitle');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const customConfirmOkButton = document.getElementById('customConfirmOkButton');
        const customConfirmCancelButton = document.getElementById('customConfirmCancelButton');
        const closeCustomConfirmXButton = document.getElementById('closeCustomConfirmXButton');


        let currentChatSessionId = null;
        let selectedRating = 0;

        // NEW: 대화 상태를 localStorage에 저장하는 함수
        function saveConversationState() {
            if (currentChatSessionId) { // 유효한 세션 ID가 있을 때만 저장
                localStorage.setItem('currentChatSessionId', currentChatSessionId);
                localStorage.setItem('chatMessagesAreaHTML', chatMessagesArea.innerHTML);
                // console.log('Conversation state saved.');
            } else {
                // 세션 ID가 없으면 저장된 상태도 초기화 (혹시 모를 잔여 데이터 방지)
                localStorage.removeItem('currentChatSessionId');
                localStorage.removeItem('chatMessagesAreaHTML');
            }
        }

        // NEW: 대화 상태를 localStorage에서 불러오는 함수
        function loadConversationState() {
            const savedSessionId = localStorage.getItem('currentChatSessionId');
            const savedChatHTML = localStorage.getItem('chatMessagesAreaHTML');

            // 저장된 세션 ID와 HTML 내용이 모두 있고, 환영 메시지가 아닌 경우에만 복원
            if (savedSessionId && savedChatHTML && savedChatHTML !== '<p class="chat-welcome-message">AI와 대화를 시작해보세요!</p>') {
                currentChatSessionId = savedSessionId;
                chatMessagesArea.innerHTML = savedChatHTML;
                chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight; // 불러온 후 스크롤 하단으로
                // console.log('Conversation state loaded.');
            } else {
                startNewChatSession(); // 저장된 대화가 없거나 유효하지 않으면 새 대화 시작
            }
        }

        // 커스텀 확인 함수
        function showCustomConfirm(message, title = '확인') {
            return new Promise((resolve) => {
                customConfirmTitle.textContent = title;
                customConfirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');

                const handleOk = () => {
                    customConfirmModal.classList.add('hidden');
                    customConfirmOkButton.removeEventListener('click', handleOk);
                    customConfirmCancelButton.removeEventListener('click', handleCancel);
                    closeCustomConfirmXButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    customConfirmModal.classList.add('hidden');
                    customConfirmOkButton.removeEventListener('click', handleOk);
                    customConfirmCancelButton.removeEventListener('click', handleCancel);
                    closeCustomConfirmXButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                customConfirmOkButton.addEventListener('click', handleOk);
                customConfirmCancelButton.addEventListener('click', handleCancel);
                closeCustomConfirmXButton.addEventListener('click', handleCancel);
            });
        }

        // 메시지 추가 함수
        function addMessage(role, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', role === 'user' ? 'user-message' : 'ai-message');
            messageElement.innerHTML = `<p>${text}</p>`;
            chatMessagesArea.appendChild(messageElement);
            chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
            // saveConversationState()는 이제 sendMessage()와 view-full-history-button에서만 호출
        }

        // 새 대화 시작 (세션 초기화)
        function startNewChatSession() {
            currentChatSessionId = null;
            chatMessagesArea.innerHTML = '<p class="chat-welcome-message">AI와 대화를 시작해보세요!</p>';
            chatSendButton.disabled = false;
            chatInputField.disabled = false;
            endChatButton.disabled = false;
            chatInputField.focus();
            localStorage.removeItem('currentChatSessionId'); // localStorage 초기화
            localStorage.removeItem('chatMessagesAreaHTML'); // localStorage 초기화
            // console.log('New chat session started and localStorage cleared.');
        }

        // 챗봇 메시지 전송
        async function sendMessage() {
            const message = chatInputField.value.trim();
            if (message === '') return;

            addMessage('user', message); // 사용자 메시지 추가 (HTML만 저장)
            chatInputField.value = '';
            chatSendButton.disabled = true;
            chatInputField.disabled = true;
            endChatButton.disabled = true;

            try {
                const response = await fetchWithAuth('/api/chat/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        chat_session_id: currentChatSessionId
                    })
                });

                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    addMessage('ai', '죄송합니다. AI 응답을 가져오는 데 실패했습니다.');
                    console.error('AI Chat Error:', errorData.message || 'Unknown error');
                    return;
                }

                const data = await response.json();
                addMessage('ai', data.response); // AI 메시지 추가 (HTML만 저장)
                currentChatSessionId = data.chat_session_id; // 서버에서 받은 세션 ID 업데이트
                saveConversationState(); // AI 응답 후, 유효한 세션 ID로 상태 저장

            } catch (error) {
                console.error('Network or AI Chat Error:', error);
                addMessage('ai', '네트워크 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                chatSendButton.disabled = false;
                chatInputField.disabled = false;
                endChatButton.disabled = false;
                chatInputField.focus();
            }
        }

        chatSendButton.addEventListener('click', sendMessage);
        chatInputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 채팅 종료 버튼 이벤트
        endChatButton.addEventListener('click', async () => {
            if (!currentChatSessionId) {
                showAlert('종료할 대화 세션이 없습니다. 먼저 대화를 시작해주세요.');
                return;
            }

            const confirmEnd = await showCustomConfirm('현재 대화를 종료하고 요약하시겠습니까?');
            if (!confirmEnd) {
                return;
            }

            endChatButton.disabled = true;
            chatSendButton.disabled = true;
            chatInputField.disabled = true;
            summaryContent.innerHTML = '<p>상담 내용을 요약하는 중...</p>';
            summaryModal.classList.remove('hidden');

            try {
                const response = await fetchWithAuth('/api/chat/end_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_session_id: currentChatSessionId })
                });

                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    summaryContent.innerHTML = `<p class="error-row">상담 요약 실패: ${errorData.message || '알 수 없는 오류'}</p>`;
                    console.error('End Session Error:', errorData.message || 'Unknown error');
                    nextToFeedbackButton.textContent = '피드백 건너뛰기';
                    nextToFeedbackButton.classList.remove('primary');
                    nextToFeedbackButton.classList.add('secondary');
                    return;
                }

                const data = await response.json();
                summaryContent.innerHTML = `<p>${data.summary}</p>`;
                nextToFeedbackButton.textContent = '다음';
                nextToFeedbackButton.classList.remove('secondary');
                nextToFeedbackButton.classList.add('primary');

            } catch (error) {
                console.error('Network or End Session Error:', error);
                summaryContent.innerHTML = '<p class="error-row">네트워크 오류로 상담 요약에 실패했습니다.</p>';
                nextToFeedbackButton.textContent = '피드백 건너뛰기';
                nextToFeedbackButton.classList.remove('primary');
                nextToFeedbackButton.classList.add('secondary');
            } finally {
                // 요약 모달이 열린 상태이므로 버튼 비활성화는 유지
            }
        });

        // 요약 모달의 "다음" 버튼 클릭 시 피드백 모달 열기
        nextToFeedbackButton.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
            selectedRating = 0;
            renderStars(selectedRating);
            feedbackComment.value = '';
            feedbackModal.classList.remove('hidden');
        });

        // 대화 기록 모달 열기
        showHistoryButton.addEventListener('click', async () => {
            // 모달을 먼저 표시합니다.
            historyModal.classList.remove('hidden'); 
            historyList.innerHTML = '<p class="loading-row">기록을 불러오는 중...</p>';
            try {
                const response = await fetchWithAuth('/api/chat/sessions');
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    historyList.innerHTML = `<p class="error-row">${errorData.message || '세션 기록을 불러오는 데 실패했습니다.'}</p>`;
                    return;
                }
                const data = await response.json();
                
                historyList.innerHTML = '';
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const logItem = document.createElement('div');
                        logItem.classList.add('history-item');
                        logItem.innerHTML = `
                            <p class="history-summary"><strong>요약:</strong> ${session.summary || '요약 없음'}</p>
                            <p class="history-date">${new Date(session.created_at).toLocaleString()}</p>
                            <div class="history-actions">
                                <button class="button small secondary view-full-history-button" data-session-id="${session.chat_session_id}">전체 대화 보기</button>
                                <button class="button small danger delete-session-button" data-session-id="${session.chat_session_id}">세션 삭제</button>
                            </div>
                        `;
                        historyList.appendChild(logItem);
                    });

                    document.querySelectorAll('.view-full-history-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const sessionId = e.target.dataset.sessionId;
                            try {
                                const historyResponse = await fetchWithAuth(`/api/chat/history?session_id=${sessionId}`);
                                if (!historyResponse || !historyResponse.ok) {
                                    const errorData = historyResponse ? await historyResponse.json() : {};
                                    showAlert(`대화 기록 로드 실패: ${errorData.message || '알 수 없는 오류'}`);
                                    return;
                                }
                                const historyData = await historyResponse.json();
                                
                                chatMessagesArea.innerHTML = '';
                                historyData.history.forEach(msg => {
                                    addMessage(msg.sender, msg.message);
                                });
                                currentChatSessionId = sessionId;
                                historyModal.classList.add('hidden');
                                showAlert('선택하신 대화 기록을 불러왔습니다.');
                                saveConversationState(); // 불러온 대화도 저장
                            } catch (error) {
                                console.error('Error loading full chat history:', error);
                                showAlert('전체 대화 기록을 불러오는 중 네트워크 오류가 발생했습니다.');
                            }
                        });
                    });

                    document.querySelectorAll('.delete-session-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const sessionIdToDelete = e.target.dataset.sessionId;
                            const confirmDelete = await showCustomConfirm('정말로 이 대화 세션을 삭제하시겠습니까? (개별 메시지와 요약 기록 모두 삭제됩니다.)');
                            if (!confirmDelete) {
                                return;
                            }

                            try {
                                    const deleteResponse = await fetchWithAuth(`/api/chat/session/${sessionIdToDelete}`, {
                                        method: 'DELETE'
                                    });
                                    if (!deleteResponse || !deleteResponse.ok) {
                                        const errorData = deleteResponse ? await deleteResponse.json() : {};
                                        showAlert(`세션 삭제 실패: ${errorData.message || '알 수 없는 오류'}`);
                                        return;
                                    }
                                    await showAlert('대화 세션이 성공적으로 삭제되었습니다.');
                                    showHistoryButton.click();
                                    if (currentChatSessionId === sessionIdToDelete) {
                                        startNewChatSession();
                                    }
                                } catch (error) {
                                    console.error('Error deleting chat session:', error);
                                    showAlert('대화 세션 삭제 중 네트워크 오류가 발생했습니다.');
                                }
                        });
                    });

                } else {
                    historyList.innerHTML = '<p class="no-data-message">저장된 대화 기록이 없습니다.</p>';
                }

            } catch (error) {
                console.error('Error fetching chat sessions:', error);
                historyList.innerHTML = '<p class="error-row">네트워크 오류로 세션 기록을 불러오지 못했습니다.</p>';
            }
            // 이 위치에서 historyModal.classList.add('hidden');을 제거하여 모달이 즉시 닫히지 않도록 합니다.
        });

        // 대화 기록 모달 닫기
        closeHistoryModalButton.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });
        closeHistoryModalXButton.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        // "피드백 확인" 버튼 제거로 인해 관련 이벤트 리스너도 제거합니다.
        /*
        checkFeedbackButton.addEventListener('click', async () => {
            myFeedbackModal.classList.remove('hidden');
            myFeedbackList.innerHTML = '<p class="loading-row">피드백을 불러오는 중...</p>';
            try {
                const response = await fetchWithAuth('/api/chat/my_feedback');
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    myFeedbackList.innerHTML = `<p class="error-row">${errorData.message || '내 피드백을 불러오는 데 실패했습니다.'}</p>`;
                    return;
                }
                const data = await response.json();

                myFeedbackList.innerHTML = '';
                if (data.my_feedback && data.my_feedback.length > 0) { // 'feedback' 대신 'my_feedback' 사용
                    data.my_feedback.forEach(item => {
                        const feedbackItem = document.createElement('div');
                        feedbackItem.classList.add('feedback-item');
                        const displayTimestamp = item.submitted_at ? new Date(item.submitted_at).toLocaleString() : '-'; // submitted_at 사용
                        const ratingStars = '⭐'.repeat(item.rating || 0);
                        feedbackItem.innerHTML = `
                            <p class="feedback-date"><strong>제출일:</strong> ${displayTimestamp}</p>
                            <p class="feedback-rating"><strong>별점:</strong> ${ratingStars} (${item.rating || 0}/5)</p>
                            <p class="feedback-comment"><strong>내용:</strong> ${item.comment || '내용 없음'}</p>
                            <button class="button small secondary view-full-conversation-button" data-session-id="${item.chat_session_id}">관련 대화 보기</button>
                        `;
                        myFeedbackList.appendChild(feedbackItem);
                    });

                    document.querySelectorAll('.view-full-conversation-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const sessionId = e.target.dataset.sessionId;
                            try {
                                const historyResponse = await fetchWithAuth(`/api/chat/history?session_id=${sessionId}`);
                                if (!historyResponse || !historyResponse.ok) {
                                    const errorData = historyResponse ? await historyResponse.json() : {};
                                    showAlert(`관련 대화 기록 로드 실패: ${errorData.message || '알 수 없는 오류'}`);
                                    return;
                                }
                                const historyData = await historyResponse.json();
                                
                                chatMessagesArea.innerHTML = '';
                                historyData.history.forEach(msg => {
                                    addMessage(msg.sender, msg.message);
                                });
                                currentChatSessionId = sessionId;
                                myFeedbackModal.classList.add('hidden'); // 피드백 모달 닫기
                                showAlert('선택하신 대화 기록을 불러왔습니다.');
                                saveConversationState(); // 불러온 대화도 저장
                            } catch (error) {
                                console.error('Error loading full chat history from feedback:', error);
                                showAlert('관련 대화 기록을 불러오는 중 네트워크 오류가 발생했습니다.');
                            }
                        });
                    });

                } else {
                    myFeedbackList.innerHTML = '<p class="no-data-message">제출한 피드백이 없습니다.</p>';
                }
            } catch (error) {
                console.error('Error fetching my feedback:', error);
                myFeedbackList.innerHTML = '<p class="error-row">네트워크 오류로 내 피드백을 불러오지 못했습니다.</p>';
            }
        });
        */


        // NEW: 나의 피드백 모달 닫기 버튼
        closeMyFeedbackModalButton.addEventListener('click', () => {
            myFeedbackModal.classList.add('hidden');
        });
        closeMyFeedbackModalXButton.addEventListener('click', () => {
            myFeedbackModal.classList.add('hidden');
        });

        // 별점 클릭 이벤트
        feedbackStars.addEventListener('click', (e) => {
            const star = e.target.closest('.fa-star');
            if (star) {
                selectedRating = parseInt(star.dataset.rating);
                renderStars(selectedRating);
            }
        });

        // 별점 렌더링
        function renderStars(rating) {
            Array.from(feedbackStars.children).forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }

        // 피드백 제출
        sendFeedbackButton.addEventListener('click', async () => {
            if (selectedRating === 0) {
                showAlert('별점을 선택해주세요.');
                return;
            }

            try {
                const response = await fetchWithAuth('/api/chat/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_session_id: currentChatSessionId,
                        rating: selectedRating,
                        comment: feedbackComment.value.trim()
                    })
                });

                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '피드백 제출에 실패했습니다.');
                    return;
                }

                await showAlert('피드백이 성공적으로 제출되었습니다. 감사합니다!');
                feedbackModal.classList.add('hidden');
                // 피드백 제출 성공 후 새 대화 시작
                startNewChatSession(); 

            } catch (error) {
                console.error('Error submitting feedback:', error);
                await showAlert('피드백 제출 중 네트워크 오류가 발생했습니다.');
            }
        });

        // 피드백 모달 닫기 (취소 버튼)
        cancelFeedbackButton.addEventListener('click', () => {
            feedbackModal.classList.add('hidden');
            // 피드백 취소 후 새 대화 시작
            startNewChatSession(); 
        });
        // 피드백 모달 닫기 (X 버튼)
        closeFeedbackModalXButton.addEventListener('click', () => {
            feedbackModal.classList.add('hidden');
            // 피드백 모달 X 버튼 클릭 후 새 대화 시작
            startNewChatSession(); 
        });

        // 상담 요약 모달 닫기 (이전에는 이 버튼이 새 대화를 시작했음)
        closeSummaryModalXButton.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
        });

        // 초기 로드 시 환영 메시지
        document.addEventListener('DOMContentLoaded', () => {
            loadConversationState(); // 페이지 로드 시 대화 상태 불러오기
        });
    </script>
{% endblock %}
