<!--frontend/templates/ai_chat.html-->
{% extends "base.html" %}

{% block title %}AI 채팅 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai_chat.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="chat-main-area">
        {# 상담 스타일 선택 및 피드백 섹션 #}
        <div class="chat-controls">
            <div class="chat-style-selector">
                <label for="chatStyle">상담 스타일:</label>
                <select id="chatStyle" class="chat-style-select">
                    <option value="empathy">일반 공감형</option>
                    <option value="cbt">인지행동치료(CBT) 기반</option>
                    <option value="solution">솔루션 중심 상담</option>
                </select>
            </div>
            <button id="showHistoryButton" class="button secondary small">대화 기록</button>
            <button id="submitFeedbackButton" class="button primary small">피드백 제출</button>
        </div>

        {# 채팅 메시지가 표시될 영역 #}
        <div class="chat-messages-area" id="chatMessagesArea">
            <p class="chat-welcome-message">AI와 대화를 시작해보세요!</p>
            {# 여기에 실제 채팅 메시지들이 동적으로 추가될 예정 #}
        </div>

        {# 입력 필드와 전송 버튼을 포함하는 컨테이너 #}
        <div class="chat-input-container">
            <input type="text" class="chat-input-field" id="chatInputField" placeholder="메시지를 입력하세요...">
            <button class="chat-send-button" id="chatSendButton">
                <i class="fas fa-paper-plane"></i> {# Font Awesome 전송 아이콘 #}
            </button>
        </div>
    </div>

    <!-- 대화 기록 모달 -->
    <div id="historyModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="historyModalTitle">나의 대화 기록</h3>
            <div id="historyList" class="history-list">
                <p class="loading-row">기록을 불러오는 중...</p>
            </div>
            <button class="button primary" id="closeHistoryModalButton">닫기</button>
        </div>
    </div>

    <!-- 피드백 모달 -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>챗봇 피드백</h3>
            <p>이번 상담에 대한 피드백을 남겨주세요.</p>
            <div class="rating-area">
                <label>별점:</label>
                <div class="stars" id="feedbackStars">
                    <i class="far fa-star" data-rating="1"></i>
                    <i class="far fa-star" data-rating="2"></i>
                    <i class="far fa-star" data-rating="3"></i>
                    <i class="far fa-star" data-rating="4"></i>
                    <i class="far fa-star" data-rating="5"></i>
                </div>
            </div>
            <div class="form-group">
                <label for="feedbackComment">의견:</label>
                <textarea id="feedbackComment" rows="5" placeholder="개선 사항이나 좋았던 점을 알려주세요."></textarea>
            </div>
            <button class="button primary" id="sendFeedbackButton">피드백 제출</button>
            <button class="button secondary" id="closeFeedbackModalButton" style="margin-left: 10px;">취소</button>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 fetchWithAuth, showAlert 사용 가능

        const chatMessagesArea = document.getElementById('chatMessagesArea');
        const chatInputField = document.getElementById('chatInputField');
        const chatSendButton = document.getElementById('chatSendButton');
        const chatStyleSelect = document.getElementById('chatStyle');
        const showHistoryButton = document.getElementById('showHistoryButton');
        const submitFeedbackButton = document.getElementById('submitFeedbackButton');

        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const closeHistoryModalButton = document.getElementById('closeHistoryModalButton');
        const closeHistoryModalXButton = historyModal.querySelector('.close-button');

        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackStars = document.getElementById('feedbackStars');
        const feedbackComment = document.getElementById('feedbackComment');
        const sendFeedbackButton = document.getElementById('sendFeedbackButton');
        const closeFeedbackModalButton = document.getElementById('closeFeedbackModalButton');
        const closeFeedbackModalXButton = feedbackModal.querySelector('.close-button');

        let currentChatSessionId = null; // 현재 대화 세션 ID
        let selectedRating = 0; // 피드백 별점

        // 메시지 추가 함수
        function addMessage(role, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', role === 'user' ? 'user-message' : 'ai-message');
            messageElement.innerHTML = `<p>${text}</p>`;
            chatMessagesArea.appendChild(messageElement);
            chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight; // 스크롤 하단으로 이동
        }

        // 챗봇 메시지 전송
        async function sendMessage() {
            const message = chatInputField.value.trim();
            if (message === '') return;

            addMessage('user', message);
            chatInputField.value = '';
            chatSendButton.disabled = true; // 전송 중 버튼 비활성화
            chatInputField.disabled = true; // 전송 중 입력 필드 비활성화

            try {
                // 백엔드의 OpenAI API 엔드포인트 호출
                const response = await fetchWithAuth('/api/chat/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        chat_style: chatStyleSelect.value,
                        chat_session_id: currentChatSessionId // 세션 ID가 있다면 전송
                    })
                });

                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    addMessage('ai', '죄송합니다. AI 응답을 가져오는 데 실패했습니다.');
                    console.error('AI Chat Error:', errorData.message || 'Unknown error');
                    return;
                }

                const data = await response.json();
                addMessage('ai', data.response);
                currentChatSessionId = data.chat_session_id; // 서버에서 받은 세션 ID 업데이트

            } catch (error) {
                console.error('Network or AI Chat Error:', error);
                addMessage('ai', '네트워크 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                chatSendButton.disabled = false; // 전송 완료 후 버튼 활성화
                chatInputField.disabled = false; // 전송 완료 후 입력 필드 활성화
                chatInputField.focus(); // 입력 필드에 포커스
            }
        }

        chatSendButton.addEventListener('click', sendMessage);
        chatInputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 대화 기록 모달 열기
        showHistoryButton.addEventListener('click', async () => {
            historyList.innerHTML = '<p class="loading-row">기록을 불러오는 중...</p>';
            try {
                const response = await fetchWithAuth('/api/chat/sessions'); // 모든 세션 목록 가져오기
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    historyList.innerHTML = `<p class="error-row">${errorData.message || '세션 기록을 불러오는 데 실패했습니다.'}</p>`;
                    return;
                }
                const data = await response.json();
                
                historyList.innerHTML = '';
                if (data.sessions && data.sessions.length > 0) {
                    // 각 세션에 대한 요약 정보를 가져오거나, 세션 ID만 표시
                    data.sessions.forEach(sessionId => {
                        const logItem = document.createElement('div');
                        logItem.classList.add('history-item');
                        logItem.innerHTML = `
                            <p class="history-summary"><strong>세션 ID:</strong> ${sessionId}</p>
                            <button class="button small secondary view-full-history-button" data-session-id="${sessionId}">전체 대화 보기</button>
                            <button class="button small danger delete-session-button" data-session-id="${sessionId}">세션 삭제</button>
                        `;
                        historyList.appendChild(logItem);
                    });

                    // 전체 대화 보기 버튼 이벤트
                    document.querySelectorAll('.view-full-history-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const sessionId = e.target.dataset.sessionId;
                            try {
                                const historyResponse = await fetchWithAuth(`/api/chat/history?session_id=${sessionId}`);
                                if (!historyResponse || !historyResponse.ok) {
                                    const errorData = historyResponse ? await historyResponse.json() : {};
                                    showAlert(`대화 기록 로드 실패: ${errorData.message || '알 수 없는 오류'}`);
                                    return;
                                }
                                const historyData = await historyResponse.json();
                                
                                chatMessagesArea.innerHTML = ''; // 현재 채팅창 비우기
                                historyData.history.forEach(msg => {
                                    addMessage(msg.sender, msg.message);
                                });
                                currentChatSessionId = sessionId; // 세션 ID 업데이트
                                historyModal.classList.add('hidden'); // 기록 모달 닫기
                                showAlert('선택하신 대화 기록을 불러왔습니다.');
                            } catch (error) {
                                console.error('Error loading full chat history:', error);
                                showAlert('전체 대화 기록을 불러오는 중 네트워크 오류가 발생했습니다.');
                            }
                        });
                    });

                    // 세션 삭제 버튼 이벤트
                    document.querySelectorAll('.delete-session-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const sessionIdToDelete = e.target.dataset.sessionId;
                            if (confirm('정말로 이 대화 세션을 삭제하시겠습니까?')) { // 사용자 확인
                                try {
                                    const deleteResponse = await fetchWithAuth(`/api/chat/session/${sessionIdToDelete}`, {
                                        method: 'DELETE'
                                    });
                                    if (!deleteResponse || !deleteResponse.ok) {
                                        const errorData = deleteResponse ? await deleteResponse.json() : {};
                                        showAlert(`세션 삭제 실패: ${errorData.message || '알 수 없는 오류'}`);
                                        return;
                                    }
                                    await showAlert('대화 세션이 성공적으로 삭제되었습니다.');
                                    // 삭제 후 기록 목록 새로고침
                                    showHistoryButton.click();
                                    // 만약 현재 세션이 삭제된 세션이라면 초기화
                                    if (currentChatSessionId === sessionIdToDelete) {
                                        currentChatSessionId = null;
                                        chatMessagesArea.innerHTML = '<p class="chat-welcome-message">새로운 대화를 시작해보세요!</p>';
                                    }
                                } catch (error) {
                                    console.error('Error deleting chat session:', error);
                                    showAlert('대화 세션 삭제 중 네트워크 오류가 발생했습니다.');
                                }
                            }
                        });
                    });

                } else {
                    historyList.innerHTML = '<p class="no-data-message">저장된 대화 기록이 없습니다.</p>';
                }

            } catch (error) {
                console.error('Error fetching chat sessions:', error);
                historyList.innerHTML = '<p class="error-row">네트워크 오류로 세션 기록을 불러오지 못했습니다.</p>';
            }
            historyModal.classList.remove('hidden');
        });

        // 대화 기록 모달 닫기
        closeHistoryModalButton.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });
        closeHistoryModalXButton.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        // 피드백 모달 열기
        submitFeedbackButton.addEventListener('click', () => {
            if (!currentChatSessionId) {
                showAlert('피드백을 제출하려면 먼저 챗봇과 대화를 시작해야 합니다.');
                return;
            }
            selectedRating = 0; // 별점 초기화
            renderStars(selectedRating);
            feedbackComment.value = '';
            feedbackModal.classList.remove('hidden');
        });

        // 별점 클릭 이벤트
        feedbackStars.addEventListener('click', (e) => {
            const star = e.target.closest('.fa-star');
            if (star) {
                selectedRating = parseInt(star.dataset.rating);
                renderStars(selectedRating);
            }
        });

        // 별점 렌더링
        function renderStars(rating) {
            Array.from(feedbackStars.children).forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }

        // 피드백 제출
        sendFeedbackButton.addEventListener('click', async () => {
            if (selectedRating === 0) {
                showAlert('별점을 선택해주세요.');
                return;
            }

            try {
                // 피드백 API 엔드포인트는 아직 백엔드에 구현되지 않았습니다.
                // 이 부분은 추후 백엔드에 `/api/chat/feedback` 엔드포인트를 구현해야 합니다.
                // 현재는 콘솔 로그와 알림만 표시합니다.
                console.log("Feedback submitted:", {
                    chat_session_id: currentChatSessionId,
                    rating: selectedRating,
                    comment: feedbackComment.value.trim()
                });
                await showAlert('피드백이 성공적으로 제출되었습니다. (백엔드 저장 기능은 미구현)');
                feedbackModal.classList.add('hidden');

            } catch (error) {
                console.error('Error submitting feedback:', error);
                await showAlert('피드백 제출 중 네트워크 오류가 발생했습니다.');
            }
        });

        // 피드백 모달 닫기
        closeFeedbackModalButton.addEventListener('click', () => {
            feedbackModal.classList.add('hidden');
        });
        closeFeedbackModalXButton.addEventListener('click', () => {
            feedbackModal.classList.add('hidden');
        });

        // 초기 로드 시 환영 메시지
        document.addEventListener('DOMContentLoaded', () => {
            // 환영 메시지는 이미 HTML에 있으므로 추가 로직 없음.
            // 필요시 로그인 상태에 따라 초기 메시지 변경 가능.
        });
    </script>
{% endblock %}
