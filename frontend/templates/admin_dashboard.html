<<<<<<< HEAD
<!--frontend/templates/admin_dashboard.html-->
{% extends "base.html" %}

{% block title %}관리자 대시보드 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1 class="admin-dashboard-title">관리자 대시보드</h1>
        <p class="admin-dashboard-subtitle">환영합니다, 관리자님! 다음 관리 페이지로 이동할 수 있습니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay">로딩 중...</span></p>

        <div class="dashboard-sections-grid">
            <a href="{{ url_for('user_management') }}" class="dashboard-link-card">
                <i class="fas fa-users-cog"></i>
                <h3>사용자 및 권한 관리</h3>
                <p>회원 목록을 조회하고 사용자 역할을 변경하거나 계정을 삭제합니다.</p>
            </a>
            <a href="{{ url_for('menu_management') }}" class="dashboard-link-card">
                <i class="fas fa-bars"></i>
                <h3>메뉴 관리</h3>
                <p>웹사이트 사이드바 메뉴들을 추가, 수정, 삭제합니다.</p>
            </a>
            <a href="{{ url_for('role_menu_assignment') }}" class="dashboard-link-card">
                <i class="fas fa-user-tag"></i>
                <h3>권한별 메뉴 설정</h3>
                <p>각 사용자 권한에 따른 메뉴 가시성을 설정합니다.</p>
            </a>
            <a href="{{ url_for('notice_management') }}" class="dashboard-link-card">
                <i class="fas fa-bullhorn"></i>
                <h3>공지사항 관리</h3>
                <p>공지사항을 작성하고 수정, 공개/비공개 전환합니다.</p>
            </a>
            {# NEW: 추가될 관리자 기능들 #}
            <a href="{{ url_for('db_management') }}" class="dashboard-link-card">
                <i class="fas fa-database"></i>
                <h3>DB 관리 (상담 기록)</h3>
                <p>상담 기록 데이터를 조회하고 관리합니다.</p>
            </a>
            <a href="{{ url_for('post_management') }}" class="dashboard-link-card">
                <i class="fas fa-file-alt"></i>
                <h3>게시글 관리</h3>
                <p>게시글 신고 내역을 확인하고 처리합니다.</p>
            </a>
            <a href="{{ url_for('cms_management') }}" class="dashboard-link-card">
                <i class="fas fa-cogs"></i>
                <h3>CMS 관리</h3>
                <p>심리 테스트 문항, 챗봇 답변 등을 관리합니다.</p>
            </a>
            <a href="{{ url_for('data_analytics') }}" class="dashboard-link-card">
                <i class="fas fa-chart-pie"></i>
                <h3>데이터 분석 및 통계</h3>
                <p>서비스 전반의 데이터를 시각적으로 분석합니다.</p>
            </a>
            <a href="{{ url_for('chatbot_feedback') }}" class="dashboard-link-card">
                <i class="fas fa-comments"></i>
                <h3>챗봇 피드백/별점 관리</h3>
                <p>사용자들이 남긴 챗봇 피드백을 열람하고 분석합니다.</p>
            </a>
            <a href="{{ url_for('admin_inquiry_management') }}" class="dashboard-link-card"> {# NEW: 문의사항 관리 링크 #}
                <i class="fas fa-envelope-open-text"></i>
                <h3>문의사항 관리</h3>
                <p>사용자 문의사항을 조회하고 답변합니다.</p>
            </a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        // 관리자 접근 권한 확인 함수
        async function checkAdminAccess() {
            console.log('checkAdminAccess (admin_dashboard): 함수 시작'); // 디버깅 로그
            const token = localStorage.getItem('access_token');
            console.log('checkAdminAccess (admin_dashboard): 로컬 스토리지 access_token:', token ? '존재함' : '없음'); // 토큰 존재 여부 로그

            if (!token) {
                console.log('checkAdminAccess (admin_dashboard): 토큰 없음, 로그인 페이지로 리다이렉트'); // 디버깅 로그
                await showAlert('관리자 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                console.log('checkAdminAccess (admin_dashboard): /api/auth/me 호출 시도'); // 디버깅 로그
                // debugger; // 디버깅 완료 후 주석 처리 또는 제거
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                console.log('checkAdminAccess (admin_dashboard): /api/auth/me fetchWithAuth 호출 결과:', response); // response 객체 자체를 로그

                if (!response) { // fetchWithAuth에서 401로 인해 undefined를 반환했을 경우
                    console.log('checkAdminAccess (admin_dashboard): fetchWithAuth가 undefined 반환 (401 리다이렉트 발생 예상)');
                    // fetchWithAuth 내부에서 이미 리다이렉트가 발생했으므로 추가적인 showAlert/리다이렉트 방지
                    return false; 
                }

                if (!response.ok) { // 200 OK가 아닌 다른 실패 응답 (401 제외)
                    console.log('checkAdminAccess (admin_dashboard): /api/auth/me 응답 실패 (response.ok = false), status:', response.status); // 디버깅 로그
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkAdminAccess (admin_dashboard): 사용자 역할:', userRoles); // 디버깅 로그

                // '관리자' 역할이 없으면 접근 제한
                if (!userRoles.includes('관리자')) {
                    console.log('checkAdminAccess (admin_dashboard): 관리자 역할 없음, 홈으로 리다이렉트'); // 디버깅 로그
                    await showAlert('관리자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                console.log('checkAdminAccess (admin_dashboard): 관리자 접근 권한 확인 완료'); // 디버깅 로그
                return true;
            } catch (error) {
                console.error('checkAdminAccess (admin_dashboard): 오류 발생:', error); // 디버깅 로그
                await showAlert('관리자 접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 초기 로드 시 관리자 접근 권한 확인
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded (admin_dashboard): 로드 완료'); // 디버깅 로그
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                console.log('DOMContentLoaded (admin_dashboard): 관리자 접근 권한 확인됨'); // 디버깅 로그
                // 추가적인 대시보드 데이터 로드 로직이 있다면 여기에 추가
            } else {
                console.log('DOMContentLoaded (admin_dashboard): 관리자 접근 권한 없음'); // 디버깅 로그
                // checkAdminAccess 함수 내에서 이미 리다이렉션 처리됨
            }
        });
    </script>
{% endblock %}
=======
<!--frontend/templates/admin_dashboard.html-->
{% extends "base.html" %}

{% block title %}관리자 대시보드 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1 class="admin-dashboard-title">관리자 대시보드</h1>
        <p class="admin-dashboard-subtitle">환영합니다, 관리자님! 다음 관리 페이지로 이동할 수 있습니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay">로딩 중...</span></p>

        <div class="dashboard-sections-grid">
            <a href="{{ url_for('user_management') }}" class="dashboard-link-card">
                <i class="fas fa-users-cog"></i>
                <h3>사용자 및 권한 관리</h3>
                <p>회원 목록을 조회하고 사용자 역할을 변경하거나 계정을 삭제합니다.</p>
            </a>
            <a href="{{ url_for('menu_management') }}" class="dashboard-link-card">
                <i class="fas fa-bars"></i>
                <h3>메뉴 관리</h3>
                <p>웹사이트 사이드바 메뉴들을 추가, 수정, 삭제합니다.</p>
            </a>
            <a href="{{ url_for('role_menu_assignment') }}" class="dashboard-link-card">
                <i class="fas fa-user-tag"></i>
                <h3>권한별 메뉴 설정</h3>
                <p>각 사용자 권한에 따른 메뉴 가시성을 설정합니다.</p>
            </a>
            <a href="{{ url_for('notice_management') }}" class="dashboard-link-card">
                <i class="fas fa-bullhorn"></i>
                <h3>공지사항 관리</h3>
                <p>공지사항을 작성하고 수정, 공개/비공개 전환합니다.</p>
            </a>
            {# NEW: 추가될 관리자 기능들 #}
            <a href="{{ url_for('db_management') }}" class="dashboard-link-card">
                <i class="fas fa-database"></i>
                <h3>DB 관리 (상담 기록)</h3>
                <p>상담 기록 데이터를 조회하고 관리합니다.</p>
            </a>
            <a href="{{ url_for('post_management') }}" class="dashboard-link-card">
                <i class="fas fa-file-alt"></i>
                <h3>게시글 관리</h3>
                <p>게시글 신고 내역을 확인하고 처리합니다.</p>
            </a>
            <a href="{{ url_for('cms_management') }}" class="dashboard-link-card">
                <i class="fas fa-cogs"></i>
                <h3>CMS 관리</h3>
                <p>심리 테스트 문항, 챗봇 답변 등을 관리합니다.</p>
            </a>
            <a href="{{ url_for('data_analytics') }}" class="dashboard-link-card">
                <i class="fas fa-chart-pie"></i>
                <h3>데이터 분석 및 통계</h3>
                <p>서비스 전반의 데이터를 시각적으로 분석합니다.</p>
            </a>
            <a href="{{ url_for('chatbot_feedback') }}" class="dashboard-link-card">
                <i class="fas fa-comments"></i>
                <h3>챗봇 피드백/별점 관리</h3>
                <p>사용자들이 남긴 챗봇 피드백을 열람하고 분석합니다.</p>
            </a>
            <a href="{{ url_for('admin_inquiry_management') }}" class="dashboard-link-card"> {# NEW: 문의사항 관리 링크 #}
                <i class="fas fa-envelope-open-text"></i>
                <h3>문의사항 관리</h3>
                <p>사용자 문의사항을 조회하고 답변합니다.</p>
            </a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        // 관리자 접근 권한 확인 함수
        async function checkAdminAccess() {
            console.log('checkAdminAccess (admin_dashboard): 함수 시작'); // 디버깅 로그
            const token = localStorage.getItem('access_token');
            console.log('checkAdminAccess (admin_dashboard): 로컬 스토리지 access_token:', token ? '존재함' : '없음'); // 토큰 존재 여부 로그

            if (!token) {
                console.log('checkAdminAccess (admin_dashboard): 토큰 없음, 로그인 페이지로 리다이렉트'); // 디버깅 로그
                await showAlert('관리자 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                console.log('checkAdminAccess (admin_dashboard): /api/auth/me 호출 시도'); // 디버깅 로그
                // debugger; // 디버깅 완료 후 주석 처리 또는 제거
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                console.log('checkAdminAccess (admin_dashboard): /api/auth/me fetchWithAuth 호출 결과:', response); // response 객체 자체를 로그

                if (!response) { // fetchWithAuth에서 401로 인해 undefined를 반환했을 경우
                    console.log('checkAdminAccess (admin_dashboard): fetchWithAuth가 undefined 반환 (401 리다이렉트 발생 예상)');
                    // fetchWithAuth 내부에서 이미 리다이렉트가 발생했으므로 추가적인 showAlert/리다이렉트 방지
                    return false; 
                }

                if (!response.ok) { // 200 OK가 아닌 다른 실패 응답 (401 제외)
                    console.log('checkAdminAccess (admin_dashboard): /api/auth/me 응답 실패 (response.ok = false), status:', response.status); // 디버깅 로그
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkAdminAccess (admin_dashboard): 사용자 역할:', userRoles); // 디버깅 로그

                // '관리자' 역할이 없으면 접근 제한
                if (!userRoles.includes('관리자')) {
                    console.log('checkAdminAccess (admin_dashboard): 관리자 역할 없음, 홈으로 리다이렉트'); // 디버깅 로그
                    await showAlert('관리자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                console.log('checkAdminAccess (admin_dashboard): 관리자 접근 권한 확인 완료'); // 디버깅 로그
                return true;
            } catch (error) {
                console.error('checkAdminAccess (admin_dashboard): 오류 발생:', error); // 디버깅 로그
                await showAlert('관리자 접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 초기 로드 시 관리자 접근 권한 확인
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded (admin_dashboard): 로드 완료'); // 디버깅 로그
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                console.log('DOMContentLoaded (admin_dashboard): 관리자 접근 권한 확인됨'); // 디버깅 로그
                // 추가적인 대시보드 데이터 로드 로직이 있다면 여기에 추가
            } else {
                console.log('DOMContentLoaded (admin_dashboard): 관리자 접근 권한 없음'); // 디버깅 로그
                // checkAdminAccess 함수 내에서 이미 리다이렉션 처리됨
            }
        });
    </script>
{% endblock %}
>>>>>>> 32e57f7623365b93a09d34dc9cad501cc18c11af
