<!--frontend/templates/diary.html-->
{% extends "base.html" %}

{% block title %}ì˜¤ëŠ˜, ì¼ê¸° - ì˜ë§ˆì¸ë“œë§í¬{% endblock %}

{% block head %}
    {# diary.css íŒŒì¼ë§Œ ì™¸ë¶€ ë§í¬ë¡œ ë¡œë“œí•©ë‹ˆë‹¤. #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diary.css') }}">
{% endblock %}

{% block content %}
    <div class="diary-main-area">
        <div class="diary-content-wrapper-outer" id="diaryContentWrapperOuter"> {# ì „ì²´ ì¼ê¸° ì½˜í…ì¸ ë¥¼ ê°ì‹¸ëŠ” ë˜í¼ #}
            <div class="diary-header-section">
                <h1 class="diary-page-title">ì˜¤ëŠ˜, ë‚˜ì˜ ì¼ê¸°</h1>
                <div class="diary-random-title-box">
                    <p id="randomDiaryTitle" class="diary-random-title-text">ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”?</p>
                </div>
            </div>

            <div class="diary-calendar-container">
                <div class="calendar-navigation">
                    <button id="prevMonth" class="nav-button"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="currentMonthYear" class="calendar-title"></h2>
                    <button id="nextMonth" class="nav-button"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                    <span>ì¼</span>
                    <span>ì›”</span>
                    <span>í™”</span>
                    <span>ìˆ˜</span>
                    <span>ëª©</span>
                    <span>ê¸ˆ</span>
                    <span>í† </span>
                </div>
                <div id="calendarDays" class="calendar-days">
                    <!-- ë‚ ì§œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>

                {# ë¡œê·¸ì¸ í•„ìš” ì˜¤ë²„ë ˆì´ëŠ” ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. #}
            </div>

            <!-- id="diaryEntrySection" ì¶”ê°€ -->
            <div class="diary-entry-section" id="diaryEntrySection">
                <div class="diary-entry-header">
                    <h2 id="diaryEntryTitle">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.</h2>
                    <div id="moodSelectionContainer" class="mood-selection-container mood-emojis">
                        <!-- ê¸°ë¶„ ì´ëª¨ì§€ë“¤ì´ ì—¬ê¸°ì— JSë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <form id="diaryEntryForm" class="diary-entry-form">
                    <textarea id="diaryContent" placeholder="ì˜¤ëŠ˜ì˜ ì¼ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”..." rows="10" class="diary-textarea"></textarea>
                    <div class="diary-buttons">
                        <button type="submit" id="saveDiary" class="btn primary">ì €ì¥</button>
                        <button type="button" id="deleteDiary" class="btn secondary">ì‚­ì œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="module">
        // Firebase ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸ ì œê±°ë¨

        // Firebase ì„¤ì • ê´€ë ¨ ë³€ìˆ˜ ì œê±°ë¨
        // let app, db, auth, userId = null;
        // let isAuthReady = false; // ì¸ì¦ ì¤€ë¹„ ìƒíƒœë¥¼ ì¶”ì  (ì´ì œ Flask ë°±ì—”ë“œ ì¸ì¦ ì‚¬ìš©)

        // ê¸°ë¶„ ì´ëª¨ì§€ ë§¤í•‘
        const moodEmojis = {
            'happy': 'ğŸ˜Š', 'neutral': 'ğŸ˜', 'sad': 'ğŸ˜”', 'angry': 'ğŸ˜ ',
            'excited': 'ğŸ¤©', 'calm': 'ğŸ˜Œ', 'anxious': 'ğŸ˜Ÿ', 'grateful': 'ğŸ™',
            'tired': 'ğŸ˜«', 'lonely': 'ğŸ¥º'
        };

        // í˜„ì¬ ë‹¬ë ¥ì— í‘œì‹œë  ë‚ ì§œ
        let currentDate = new Date();
        let selectedDate = null; // ì„ íƒëœ ë‚ ì§œ
        let selectedMood = null; // ì„ íƒëœ ê¸°ë¶„ ì´ëª¨ì§€ í‚¤
        let currentDiaryEntryId = null; // í˜„ì¬ ë¡œë“œëœ ì¼ê¸°ì˜ MongoDB _id (ì‚­ì œìš©)

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const calendarDaysEl = document.getElementById('calendarDays');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const diaryEntrySection = document.getElementById('diaryEntrySection'); // ID ì¶”ê°€ë¨
        const diaryEntryTitle = document.getElementById('diaryEntryTitle');
        const diaryContent = document.getElementById('diaryContent');
        const moodSelectionContainer = document.getElementById('moodSelectionContainer');
        const saveDiaryBtn = document.getElementById('saveDiary');
        const deleteDiaryBtn = document.getElementById('deleteDiary');
        const randomDiaryTitle = document.getElementById('randomDiaryTitle');

        // ì¼ê¸° ë°ì´í„° ì €ì¥ ê°ì²´ (ë¡œì»¬ ìºì‹œ ì—­í• )
        let diaryEntries = {};

        // ëœë¤ ì¼ê¸° ì œëª© ëª©ë¡
        const randomTitles = [
            "ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”?",
            "ê¸°ì–µí•˜ê³  ì‹¶ì€ ìˆœê°„ì„ ê¸°ë¡í•´ë³´ì„¸ìš”.",
            "ë‹¹ì‹ ì˜ ê°ì •ì„ í‘œí˜„í•´ë³´ì„¸ìš”.",
            "ì˜¤ëŠ˜ì˜ ì‘ì€ í–‰ë³µì„ ì°¾ì•„ë³´ì„¸ìš”.",
            "ë§ˆìŒì„ ì •ë¦¬í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.",
            "ì˜¤ëŠ˜ì˜ ë‹¹ì‹ ì€ ì–´ë–¤ê°€ìš”?"
        ];

        // ëœë¤ ì¼ê¸° ì œëª© ì„¤ì • í•¨ìˆ˜
        const setRandomDiaryTitle = () => {
            const randomIndex = Math.floor(Math.random() * randomTitles.length);
            randomDiaryTitle.textContent = randomTitles[randomIndex];
        };

        // ê¸°ë¶„ ì´ëª¨ì§€ ë Œë”ë§
        const renderMoodEmojis = () => {
            moodSelectionContainer.innerHTML = ''; // ê¸°ì¡´ ì´ëª¨ì§€ ì´ˆê¸°í™”
            for (const moodKey in moodEmojis) {
                const emojiSpan = document.createElement('span');
                emojiSpan.classList.add('mood-emoji');
                emojiSpan.textContent = moodEmojis[moodKey];
                emojiSpan.dataset.mood = moodKey; // ë°ì´í„° ì†ì„±ì— ê¸°ë¶„ í‚¤ ì €ì¥
                emojiSpan.addEventListener('click', () => selectMood(moodKey));
                moodSelectionContainer.appendChild(emojiSpan);
            }
        };

        // ê¸°ë¶„ ì„ íƒ í•¨ìˆ˜
        const selectMood = (moodKey) => {
            selectedMood = moodKey;
            // ëª¨ë“  ì´ëª¨ì§€ì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.mood-emoji').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            // ì„ íƒëœ ì´ëª¨ì§€ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            const selectedEmojiEl = document.querySelector(`.mood-emoji[data-mood="${moodKey}"]`);
            if (selectedEmojiEl) {
                selectedEmojiEl.classList.add('selected');
            }
        };

        // ìº˜ë¦°ë” ë Œë”ë§ í•¨ìˆ˜
        const renderCalendar = async (year, month) => { // async ì¶”ê°€
            currentMonthYearEl.textContent = `${year}ë…„ ${month + 1}ì›”`;
            calendarDaysEl.innerHTML = ''; // ê¸°ì¡´ ë‚ ì§œë“¤ ì´ˆê¸°í™”

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // í•´ë‹¹ ì›”ì˜ ì²«ì§¸ ë‚  ìš”ì¼ (0: ì¼ìš”ì¼, 6: í† ìš”ì¼)
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ

            // --- ì›”ë³„ ì¼ê¸° ìš”ì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Flask ë°±ì—”ë“œ API ì‚¬ìš©) ---
            let monthlySummary = {};
            try {
                const summaryResponse = await fetchWithAuth(`/api/diary/entries/month_summary?year=${year}&month=${month + 1}`);
                if (summaryResponse.ok) {
                    const summaryResult = await summaryResponse.json();
                    monthlySummary = summaryResult.summary;
                    console.log("Monthly summary fetched from Flask backend:", monthlySummary);
                } else if (summaryResponse.status === 401) {
                    // ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŒì„ ì•Œë¦¬ê³ , í† í° ì‚­ì œ
                    console.warn("Monthly summary fetch failed: Login session expired or invalid token. Displaying calendar without user-specific data.");
                    localStorage.removeItem('jwt_token');
                    // showAlert("ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); // ë„ˆë¬´ ìì£¼ ëœ° ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
                } else {
                    const errorData = await summaryResponse.json();
                    window.showAlert(errorData.message || "ì›”ë³„ ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜"); // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
                    console.error("Failed to fetch monthly summary from Flask backend:", summaryResponse.status, errorData.message);
                }
            } catch (error) {
                console.error("Error fetching monthly summary from Flask backend:", error);
                window.showAlert("ì›”ë³„ ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜"); // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
            }
            // ----------------------------------------------------------

            // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                calendarDaysEl.appendChild(emptyDay);
            }

            // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œ ì±„ìš°ê¸°
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day');
                dayEl.textContent = day;
                dayEl.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì €ì¥

                const fullDate = new Date(year, month, day);
                const today = new Date();
                // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
                if (fullDate.toDateString() === today.toDateString()) {
                    dayEl.classList.add('today');
                }

                // ì¼ê¸° ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œ í‘œì‹œ ë° ì´ëª¨ì§€ ì¶”ê°€ (Flask ë°±ì—”ë“œ ë°ì´í„° ì‚¬ìš©)
                const dateKey = dayEl.dataset.date;
                if (monthlySummary[dateKey] && monthlySummary[dateKey].has_entry) {
                    dayEl.classList.add('has-diary-entry');
                    const moodEmoji = document.createElement('span');
                    moodEmoji.classList.add('mood-display-emoji');
                    moodEmoji.textContent = moodEmojis[monthlySummary[dateKey].mood_emoji_key] || ''; // ì €ì¥ëœ ê¸°ë¶„ ì´ëª¨ì§€ í‘œì‹œ
                    dayEl.appendChild(moodEmoji);
                }

                dayEl.addEventListener('click', () => selectDate(dayEl.dataset.date));
                calendarDaysEl.appendChild(dayEl);
            }
        };

        // ë‚ ì§œ ì„ íƒ í•¨ìˆ˜
        const selectDate = async (dateString) => {

                   
            // Firebase ì¸ì¦ ê´€ë ¨ userId, isAuthReady ì²´í¬ ì œê±°
            // ì´ì œ Flask ë°±ì—”ë“œì˜ ì¸ì¦ ìƒíƒœì— ë”°ë¼ API ìš”ì²­ì´ ì²˜ë¦¬ë©ë‹ˆë‹¤.

            // ì´ì „ì— ì„ íƒëœ ë‚ ì§œì˜ 'selected' í´ë˜ìŠ¤ ì œê±°
            const prevSelected = document.querySelector('.calendar-day.selected');
            if (prevSelected) {
                prevSelected.classList.remove('selected');
            }

            // ìƒˆë¡œ ì„ íƒëœ ë‚ ì§œì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            const newSelected = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
            if (newSelected) {
                newSelected.classList.add('selected');
            }

            selectedDate = new Date(dateString);
            diaryEntryTitle.textContent = `${selectedDate.getFullYear()}ë…„ ${selectedDate.getMonth() + 1}ì›” ${selectedDate.getDate()}ì¼`;
            diaryEntrySection.classList.remove('hidden'); // ì¼ê¸° ì„¹ì…˜ í‘œì‹œ

            // í•´ë‹¹ ë‚ ì§œì˜ ì¼ê¸° ë°ì´í„° ë¡œë“œ (Flask ë°±ì—”ë“œ API ì‚¬ìš©)
            try {
                const response = await fetchWithAuth(`/api/diary/entries?date=${dateString}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.diary_entry) { // ë‹¨ì¼ ì¼ê¸° ì¡°íšŒ í˜•ì‹ì— ë§ì¶° ìˆ˜ì •
                        diaryContent.value = data.diary_entry.content;
                        selectMood(data.diary_entry.mood_emoji_key);
                        currentDiaryEntryId = data.diary_entry._id; // MongoDB _id ì €ì¥
                    } else {
                        diaryContent.value = ''; // ì¼ê¸° ì—†ìœ¼ë©´ ë‚´ìš© ë¹„ìš°ê¸°
                        selectedMood = null; // ê¸°ë¶„ ì„ íƒ í•´ì œ
                        currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
                        document.querySelectorAll('.mood-emoji').forEach(emoji => {
                            emoji.classList.remove('selected');
                        });
                    }
                } else if (response.status === 404) {
                    console.log(`No diary entry found for ${dateString}.`);
                    diaryContent.value = '';
                    selectedMood = null;
                    currentDiaryEntryId = null;
                    document.querySelectorAll('.mood-emoji').forEach(emoji => {
                        emoji.classList.remove('selected');
                    });
                } else if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    // window.location.href = "{{ url_for('login') }}"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ ì œê±°
                } else {
                    const errorData = await response.json();
                    window.showAlert(errorData.message || 'ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', "ì˜¤ë¥˜");
                    diaryContent.value = '';
                    selectedMood = null;
                    currentDiaryEntryId = null;
                    document.querySelectorAll('.mood-emoji').forEach(emoji => {
                        emoji.classList.remove('selected');
                    });
                }
            } catch (error) {
                console.error("Error loading diary entry from Flask backend:", error);
                window.showAlert('ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', "ì˜¤ë¥˜");
                diaryContent.value = '';
                selectedMood = null;
                currentDiaryEntryId = null;
                document.querySelectorAll('.mood-emoji').forEach(emoji => {
                    emoji.classList.remove('selected');
                });
            }
        };

        // ì¼ê¸° ì €ì¥ í•¨ìˆ˜ (Flask ë°±ì—”ë“œ API ì‚¬ìš©)
        const saveDiary = async () => {
            if (!selectedDate) {
                window.showAlert("ë‚ ì§œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜");
                return;
            }

            const dateKey = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            const content = diaryContent.value.trim();

            if (!content && !selectedMood) {
                const confirmed = await window.showConfirm("ì¼ê¸° ë‚´ìš©ê³¼ ê¸°ë¶„ ì„ íƒì´ ëª¨ë‘ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (confirmed) {
                    await deleteDiaryEntry(); // dateKeyëŠ” ì—¬ê¸°ì„œ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°
                    window.showAlert("ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "ì•Œë¦¼");
                } else {
                    window.showAlert("ì¼ê¸° ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.", "ì•Œë¦¼");
                }
                return;
            }

            if (!selectedMood) {
                window.showAlert("ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!", "ì•Œë¦¼");
                return;
            }

            try {
                const method = currentDiaryEntryId ? 'PUT' : 'POST'; // ê¸°ì¡´ ì¼ê¸°ë©´ PUT, ìƒˆ ì¼ê¸°ë©´ POST
                const url = currentDiaryEntryId ? `/api/diary/entries/${currentDiaryEntryId}` : '/api/diary/entries';

                const response = await fetchWithAuth(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `${dateKey} ì¼ê¸°`, // ì œëª©ì€ ë‚ ì§œë¡œ ìë™ ìƒì„±
                        content: content,
                        date: dateKey,
                        mood_emoji_key: selectedMood
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    window.showAlert(result.message || "ì¼ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "ì €ì¥ ì™„ë£Œ");
                    // ì €ì¥ í›„ ìº˜ë¦°ë” ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì´ëª¨ì§€ ì—…ë°ì´íŠ¸
                    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                    if (method === 'POST' && result.diary_entry && result.diary_entry._id) {
                        currentDiaryEntryId = result.diary_entry._id; // ìƒˆë¡œ ì €ì¥ëœ ì¼ê¸°ì˜ _id ì—…ë°ì´íŠ¸
                    }
                } else if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    // window.location.href = "{{ url_for('login') }}"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ ì œê±°
                } else {
                    window.showAlert(result.message || `ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, "ì €ì¥ ì˜¤ë¥˜");
                    console.error("Error saving diary entry from Flask backend:", result.message);
                }
            } catch (e) {
                console.error("ì¼ê¸° ì €ì¥ ì˜¤ë¥˜:", e);
                window.showAlert(`ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`, "ì €ì¥ ì˜¤ë¥˜");
            }
        };

        // ì¼ê¸° ì‚­ì œ í•¨ìˆ˜ (Flask ë°±ì—”ë“œ API ì‚¬ìš©)
        const deleteDiaryEntry = async () => { // dateKey ì¸ì ì œê±°
            if (!currentDiaryEntryId) {
                window.showAlert('ì‚­ì œí•  ì¼ê¸° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
                return;
            }

            try {
                const deleteResponse = await fetchWithAuth(`/api/diary/entries/${currentDiaryEntryId}`, {
                    method: 'DELETE'
                });

                const deleteResult = await deleteResponse.json();

                if (deleteResponse.ok) {
                    window.showAlert(deleteResult.message || 'ì¼ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', "ì‚­ì œ ì™„ë£Œ");
                    diaryContent.value = ''; // ì¼ê¸° ë‚´ìš© ì´ˆê¸°í™”
                    selectedMood = null; // ê¸°ë¶„ ì´ˆê¸°í™”
                    currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
                    document.querySelectorAll('.mood-emoji').forEach(emoji => {
                        emoji.classList.remove('selected');
                    });
                    renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); // ìº˜ë¦°ë” ë‹¤ì‹œ ë Œë”ë§
                    diaryEntrySection.classList.add('hidden'); // ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                } else if (deleteResponse.status === 401) {
                    localStorage.removeItem('jwt_token');
                    // window.location.href = "{{ url_for('login') }}"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ ì œê±°
                } else {
                    window.showAlert(deleteResult.message || "ì¼ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "ì‚­ì œ ì˜¤ë¥˜");
                    console.error("Error deleting diary entry from Flask backend:", deleteResult.message);
                }
            } catch (e) {
                console.error("ì¼ê¸° ì‚­ì œ ì˜¤ë¥˜:", e);
                window.showAlert(`ì¼ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`, "ì‚­ì œ ì˜¤ë¥˜");
            }
        };

        // ì¼ê¸° ì‚­ì œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        const handleDeleteButtonClick = async () => {
            if (!selectedDate) {
                window.showAlert('ì‚­ì œí•  ì¼ê¸°ì˜ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'ì•Œë¦¼');
                return;
            }

            if (!currentDiaryEntryId) {
                window.showAlert('ì‚­ì œí•  ì¼ê¸° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.', 'ì•Œë¦¼');
                return;
            }

            const confirmed = await window.showConfirm("ì •ë§ë¡œ ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (confirmed) {
                await deleteDiaryEntry(); // ì¸ì ì—†ì´ í˜¸ì¶œ (currentDiaryEntryId ì‚¬ìš©)
            } else {
                window.showAlert("ì¼ê¸° ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.", "ì•Œë¦¼");
            }
        };

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
            diaryContent.value = ''; // ì›” ë³€ê²½ ì‹œ ì¼ê¸° ë‚´ìš© ì´ˆê¸°í™”
            diaryEntryTitle.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.';
            selectedMood = null; // ê¸°ë¶„ ì´ˆê¸°í™”
            currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
            document.querySelectorAll('.mood-emoji').forEach(emoji => { emoji.classList.remove('selected'); });
            diaryEntrySection.classList.add('hidden'); // ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
            diaryContent.value = ''; // ì›” ë³€ê²½ ì‹œ ì¼ê¸° ë‚´ìš© ì´ˆê¸°í™”
            diaryEntryTitle.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.';
            selectedMood = null; // ê¸°ë¶„ ì´ˆê¸°í™”
            currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
            document.querySelectorAll('.mood-emoji').forEach(emoji => { emoji.classList.remove('selected'); });
            diaryEntrySection.classList.add('hidden'); // ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        });

        saveDiaryBtn.addEventListener('click', saveDiary);
        deleteDiaryBtn.addEventListener('click', handleDeleteButtonClick);

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = async () => {
            setRandomDiaryTitle(); // ëœë¤ ì¼ê¸° ì œëª© ì„¤ì •
            renderMoodEmojis(); // ê¸°ë¶„ ì´ëª¨ì§€ ë Œë”ë§
            // Firebase ì´ˆê¸°í™” ëŒ€ì‹  Flask ë°±ì—”ë“œ ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ìº˜ë¦°ë” ë Œë”ë§
            await checkLoginStatusAndUpdateUI();
        };

        // checkLoginStatusAndUpdateUI í•¨ìˆ˜ (base.htmlì— ì •ì˜ëœ fetchWithAuth ì‚¬ìš©)
        async function checkLoginStatusAndUpdateUI() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                try {
                    const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                    if (response.ok) {
                        console.log("Token verified successfully. User is logged in.");
                    } else {
                        console.error("Failed to verify token (server error or invalid token). User is not logged in.");
                        localStorage.removeItem('jwt_token');
                    }
                } catch (error) {
                    console.error("Failed to verify token (network error or unexpected response):", error);
                    localStorage.removeItem('jwt_token');
                }
            } else {
                console.log("No JWT token found. User is not logged in.");
            }
            // ë¡œê·¸ì¸ ìƒíƒœì™€ ê´€ê³„ì—†ì´ ìº˜ë¦°ë”ëŠ” í•­ìƒ ë Œë”ë§
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
    </script>
{% endblock %}
