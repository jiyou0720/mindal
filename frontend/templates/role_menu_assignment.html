<!--frontend/templates/role_menu_assignment.html-->
{% extends "base.html" %}

{% block title %}권한별 메뉴 설정 - Mindbridge{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}"> {# 관리자 대시보드 CSS 재사용 #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* role_menu_assignment.html 전용 스타일 */

        .admin-dashboard-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 40px;
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5em;
            color: #2C3E50;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .admin-dashboard-container > p {
            font-size: 1.1em;
            color: #6C7A89;
            text-align: center;
            margin-bottom: 30px;
        }

        #currentUserRolesDisplay {
            font-weight: 600;
            color: #007bff;
        }

        .admin-section {
            background-color: #F8FAFC;
            border: 1px solid #E9EEF4;
            border-radius: 10px;
            padding: 30px;
            margin-top: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .admin-section h2 {
            font-size: 1.8em;
            color: #34495E;
            margin-bottom: 25px;
            font-weight: 600;
            border-bottom: 1px solid #E0E6ED;
            padding-bottom: 15px;
        }

        .role-selector-container {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .role-selector-container label {
            font-size: 1.1em;
            font-weight: 600;
            color: #34495E;
        }

        #roleSelect {
            padding: 10px 15px;
            border: 1px solid #DCE4EC;
            border-radius: 8px;
            font-size: 1em;
            color: #4D4D4D;
            background-color: #FFFFFF;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
            transition: border-color 0.2s ease;
            flex-grow: 1;
            min-width: 200px;
        }

        #roleSelect:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .menu-assignment-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Left List, Buttons, Right List */
            gap: 20px;
            align-items: flex-start; /* 상단 정렬 */
        }

        .menu-list-container {
            background-color: #FFFFFF;
            border: 1px solid #E9EEF4;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px; /* 최소 높이 설정 */
            max-height: 600px; /* 최대 높이 설정 */
            overflow-y: auto; /* 스크롤 가능 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .menu-list-container h3 {
            font-size: 1.3em;
            color: #34495E;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
            border-bottom: 1px solid #E0E6ED;
            padding-bottom: 10px;
        }

        .menu-list-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .menu-list-table th, .menu-list-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #F8FAFC;
            font-size: 0.9em;
        }

        .menu-list-table th {
            background-color: #F0F4F8;
            color: #5A6B7F;
            font-weight: 600;
            position: sticky; /* 헤더 고정 */
            top: 0;
            z-index: 1;
        }

        .menu-list-table tbody tr:last-child td {
            border-bottom: none;
        }

        .menu-list-table tbody tr:hover {
            background-color: #F8FAFC;
        }

        .menu-list-table input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .menu-list-table .menu-icon {
            margin-right: 8px;
            color: #007bff;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }

        .menu-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 18px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2);
            width: 60px; /* 버튼 너비 고정 */
        }

        .menu-buttons button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .menu-buttons button i {
            margin: 0; /* 아이콘 마진 제거 */
        }

        .save-button-container {
            text-align: center;
            margin-top: 30px;
        }

        .save-button {
            background-color: #28a745; /* 초록색 저장 버튼 */
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
        }

        .save-button:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }

        .no-items-message {
            text-align: center;
            color: #888;
            padding: 20px;
            font-size: 1em;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .menu-assignment-grid {
                grid-template-columns: 1fr; /* 모바일에서는 세로로 정렬 */
            }
            .menu-buttons {
                flex-direction: row; /* 버튼을 가로로 정렬 */
                flex-wrap: wrap;
                width: 100%;
                justify-content: center;
            }
            .menu-buttons button {
                width: 80px; /* 버튼 너비 조정 */
                padding: 12px 0; /* 세로 패딩 조정 */
            }
        }

        @media (max-width: 768px) {
            .admin-dashboard-container {
                padding: 25px;
                margin: 20px auto;
            }
            h1 {
                font-size: 2em;
            }
            .admin-dashboard-container > p {
                font-size: 1em;
                margin-bottom: 20px;
            }
            .admin-section {
                padding: 20px;
                margin-top: 30px;
            }
            .admin-section h2 {
                font-size: 1.6em;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
            .role-selector-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            #roleSelect {
                width: 100%;
                min-width: unset;
            }
            .menu-list-container {
                min-height: 300px;
                max-height: 400px;
                padding: 15px;
            }
            .menu-list-container h3 {
                font-size: 1.2em;
                margin-bottom: 10px;
                padding-bottom: 8px;
            }
            .menu-list-table th, .menu-list-table td {
                padding: 8px 10px;
                font-size: 0.85em;
            }
            .menu-buttons button {
                width: 70px;
                padding: 10px 0;
                font-size: 0.9em;
            }
            .save-button {
                padding: 12px 25px;
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .admin-dashboard-container {
                padding: 15px;
                margin: 15px auto;
            }
            h1 {
                font-size: 1.8em;
            }
            .admin-dashboard-container > p {
                font-size: 0.9em;
            }
            .admin-section {
                padding: 15px;
            }
            .admin-section h2 {
                font-size: 1.4em;
            }
            .menu-list-table th, .menu-list-table td {
                font-size: 0.8em;
                padding: 6px 8px;
            }
            .menu-buttons button {
                width: 60px;
                padding: 8px 0;
                font-size: 0.8em;
            }
            .save-button {
                padding: 10px 20px;
                font-size: 0.9em;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>권한별 메뉴 설정</h1>
        <p>각 사용자 권한에 따라 사이드바에 표시될 메뉴를 설정할 수 있습니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>권한 선택</h2>
            <div class="role-selector-container">
                <label for="roleSelect">권한 선택:</label>
                <select id="roleSelect">
                    <option value="">-- 권한을 선택하세요 --</option>
                    <!-- 역할 목록이 여기에 동적으로 로드됩니다 -->
                </select>
            </div>

            <div class="menu-assignment-grid">
                <div class="menu-list-container">
                    <h3>전체 메뉴</h3>
                    <table class="menu-list-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllAvailable"></th>
                                <th>메뉴 ID</th>
                                <th>메뉴명</th>
                            </tr>
                        </thead>
                        <tbody id="availableMenusTableBody">
                            <!-- 전체 메뉴가 여기에 동적으로 로드됩니다 -->
                            <tr><td colspan="3" class="no-items-message">메뉴를 불러오는 중...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="menu-buttons">
                    <button id="addMenuButton" title="선택된 메뉴 추가"><i class="fas fa-play"></i></button>
                    <button id="removeMenuButton" title="선택된 메뉴 제거"><i class="fas fa-backward"></i></button>
                    <button id="moveUpButton" title="선택된 메뉴 위로 이동"><i class="fas fa-arrow-up"></i></button>
                    <button id="moveDownButton" title="선택된 메뉴 아래로 이동"><i class="fas fa-arrow-down"></i></button>
                </div>

                <div class="menu-list-container">
                    <h3>선택된 메뉴</h3>
                    <table class="menu-list-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllSelected"></th>
                                <th>메뉴 ID</th>
                                <th>메뉴명</th>
                            </tr>
                        </thead>
                        <tbody id="selectedMenusTableBody">
                            <!-- 선택된 메뉴가 여기에 동적으로 로드됩니다 -->
                            <tr><td colspan="3" class="no-items-message">권한을 선택해주세요.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="save-button-container">
                <button id="saveMenuAssignmentButton" class="save-button">저장</button>
            </div>
        </div>
    </div>

    <script>
        const loginUrl = "{{ url_for('login') }}";
        const homeUrl = "{{ url_for('index') }}";

        let allRoles = [];
        let allMenuItems = [];
        let currentRoleSelectedMenus = [];

        const roleSelect = document.getElementById('roleSelect');
        const availableMenusTableBody = document.getElementById('availableMenusTableBody');
        const selectedMenusTableBody = document.getElementById('selectedMenusTableBody');
        const addMenuButton = document.getElementById('addMenuButton');
        const removeMenuButton = document.getElementById('removeMenuButton');
        const moveUpButton = document.getElementById('moveUpButton');
        const moveDownButton = document.getElementById('moveDownButton');
        const saveMenuAssignmentButton = document.getElementById('saveMenuAssignmentButton');
        const selectAllAvailableCheckbox = document.getElementById('selectAllAvailable');
        const selectAllSelectedCheckbox = document.getElementById('selectAllSelected');
        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        let currentSelectedRoleId = null;

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('jwt_token');
            const headers = {
                ...options.headers,
                'Content-Type': 'application/json'
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            } else {
                console.warn("fetchWithAuth: Token is missing for URL:", url);
            }

            try {
                const response = await fetch(url, { ...options, headers });

                if (response.status === 401) {
                    const errorData = await response.json();
                    console.error("Authentication error:", errorData.message);
                    alert(errorData.message || '로그인 세션이 만료되었거나 유효하지 않습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('jwt_token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('user_uid');
                    localStorage.removeItem('nickname');
                    localStorage.removeItem('username');
                    localStorage.removeItem('user_roles');
                    localStorage.removeItem('cached_menu_items');
                    window.location.href = loginUrl;
                    throw new Error('Unauthorized'); // 에러를 throw하여 호출 함수에서 catch하도록 함
                }

                return response;
            } catch (error) {
                console.error("Network or fetch error:", error);
                alert('네트워크 오류가 발생했습니다. 인터넷 연결을 확인하거나 다시 시도해주세요.');
                throw error;
            }
        }

        async function checkAdminAccess() {
            const token = localStorage.getItem('jwt_token');
            const userRolesString = localStorage.getItem('user_roles');
            let userRoles = [];

            if (!token) {
                alert('관리자 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            if (userRolesString) {
                try {
                    userRoles = JSON.parse(userRolesString);
                } catch (e) {
                    console.error("Error parsing user roles from localStorage:", e);
                    alert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('jwt_token');
                    window.location.href = loginUrl;
                    return false;
                }
            }

            if (!userRoles.includes('관리자')) {
                alert('관리자만 접근할 수 있는 페이지입니다.');
                window.location.href = homeUrl;
                return false;
            }

            currentUserRolesDisplay.textContent = userRoles.join(', ');
            return true;
        }

        async function fetchAllRoles() {
            try {
                const response = await fetchWithAuth('/api/admin/roles');
                const result = await response.json();
                if (response.ok) {
                    allRoles = result.roles;
                    renderRoleSelect(); // 역할 목록 렌더링
                } else {
                    console.error('Failed to load roles:', result.message);
                }
            } catch (error) {
                console.error('Network error fetching roles:', error);
            }
        }

        // 새로 추가된 함수: 역할 선택 드롭다운 렌더링
        function renderRoleSelect() {
            // "권한을 선택하세요" 옵션을 제외한 모든 기존 옵션 제거
            roleSelect.querySelectorAll('option:not([value=""])').forEach(option => option.remove());

            if (allRoles.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "역할이 없습니다.";
                roleSelect.appendChild(option);
                return;
            }

            allRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
        }

        async function fetchAllMenuItems() {
            availableMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">메뉴를 불러오는 중...</td></tr>';
            try {
                const response = await fetchWithAuth('/api/admin/menu_configs');
                const result = await response.json();
                if (response.ok) {
                    allMenuItems = result.menu_items;
                    renderAvailableMenus();
                } else {
                    console.error('Failed to load menu items:', result.message);
                    availableMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">메뉴를 불러오는 데 실패했습니다.</td></tr>';
                }
            } catch (error) {
                console.error('Network error fetching menu items:', error);
                availableMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">네트워크 오류가 발생했습니다.</td></tr>';
            }
        }

        function renderAvailableMenus() {
            availableMenusTableBody.innerHTML = '';
            const availableForSelection = allMenuItems.filter(item => 
                !currentRoleSelectedMenus.some(selected => selected._id === item._id)
            );

            if (availableForSelection.length === 0) {
                availableMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">사용 가능한 메뉴가 없습니다.</td></tr>';
                return;
            }

            availableForSelection.forEach(item => {
                const row = availableMenusTableBody.insertRow();
                row.dataset.id = item._id;
                row.innerHTML = `
                    <td><input type="checkbox" data-id="${item._id}" class="available-menu-checkbox"></td>
                    <td>${item._id ? item._id.substring(0, 7) + '...' : 'N/A'}</td>
                    <td><i class="${item.icon_class} menu-icon"></i>${item.name}</td>
                `;
            });
        }

        function renderSelectedMenus() {
            selectedMenusTableBody.innerHTML = '';
            if (currentRoleSelectedMenus.length === 0) {
                selectedMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">선택된 메뉴가 없습니다.</td></tr>';
                return;
            }

            currentRoleSelectedMenus.forEach(item => {
                const row = selectedMenusTableBody.insertRow();
                row.dataset.id = item._id;
                row.innerHTML = `
                    <td><input type="checkbox" data-id="${item._id}" class="selected-menu-checkbox"></td>
                    <td>${item._id ? item._id.substring(0, 7) + '...' : 'N/A'}</td>
                    <td><i class="${item.icon_class} menu-icon"></i>${item.name}</td>
                `;
            });
        }

        roleSelect.addEventListener('change', async (event) => {
            currentSelectedRoleId = event.target.value;
            selectedMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">메뉴를 불러오는 중...</td></tr>';
            currentRoleSelectedMenus = [];

            if (!currentSelectedRoleId) {
                selectedMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">권한을 선택해주세요.</td></tr>';
                renderAvailableMenus();
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/admin/roles/${currentSelectedRoleId}/menu_configs`);
                const result = await response.json();

                if (response.ok) {
                    currentRoleSelectedMenus = result.menu_items;
                    renderSelectedMenus();
                    renderAvailableMenus();
                } else {
                    console.error('Failed to load role menu configs:', result.message);
                    selectedMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">메뉴를 불러오는 데 실패했습니다.</td></tr>';
                }
            } catch (error) {
                console.error('Network error fetching role menu configs:', error);
                selectedMenusTableBody.innerHTML = '<tr><td colspan="3" class="no-items-message">네트워크 오류가 발생했습니다.</td></tr>';
            }
        });

        addMenuButton.addEventListener('click', () => {
            const selectedCheckboxes = Array.from(availableMenusTableBody.querySelectorAll('.available-menu-checkbox:checked'));
            const itemsToAdd = selectedCheckboxes.map(checkbox => 
                allMenuItems.find(item => item._id === checkbox.dataset.id)
            );

            itemsToAdd.forEach(item => {
                if (item && !currentRoleSelectedMenus.some(selected => selected._id === item._id)) {
                    currentRoleSelectedMenus.push(item);
                }
            });

            renderSelectedMenus();
            renderAvailableMenus();
            selectAllAvailableCheckbox.checked = false;
        });

        removeMenuButton.addEventListener('click', () => {
            const selectedCheckboxes = Array.from(selectedMenusTableBody.querySelectorAll('.selected-menu-checkbox:checked'));
            const idsToRemove = new Set(selectedCheckboxes.map(checkbox => checkbox.dataset.id));
            
            currentRoleSelectedMenus = currentRoleSelectedMenus.filter(item => !idsToRemove.has(item._id));

            renderSelectedMenus();
            renderAvailableMenus();
            selectAllSelectedCheckbox.checked = false;
        });

        moveUpButton.addEventListener('click', () => {
            const selectedCheckboxes = Array.from(selectedMenusTableBody.querySelectorAll('.selected-menu-checkbox:checked'));
            if (selectedCheckboxes.length !== 1) {
                alert('하나의 메뉴만 선택하여 이동할 수 있습니다.');
                return;
            }
            const idToMove = selectedCheckboxes[0].dataset.id;
            const index = currentRoleSelectedMenus.findIndex(item => item._id === idToMove);

            if (index > 0) {
                const [item] = currentRoleSelectedMenus.splice(index, 1);
                currentRoleSelectedMenus.splice(index - 1, 0, item);
                renderSelectedMenus();
                selectedMenusTableBody.querySelector(`.selected-menu-checkbox[data-id="${idToMove}"]`).checked = true;
            }
        });

        moveDownButton.addEventListener('click', () => {
            const selectedCheckboxes = Array.from(selectedMenusTableBody.querySelectorAll('.selected-menu-checkbox:checked'));
            if (selectedCheckboxes.length !== 1) {
                alert('하나의 메뉴만 선택하여 이동할 수 있습니다.');
                return;
            }
            const idToMove = selectedCheckboxes[0].dataset.id;
            const index = currentRoleSelectedMenus.findIndex(item => item._id === idToMove);

            if (index < currentRoleSelectedMenus.length - 1) {
                const [item] = currentRoleSelectedMenus.splice(index, 1);
                currentRoleSelectedMenus.splice(index + 1, 0, item);
                renderSelectedMenus();
                selectedMenusTableBody.querySelector(`.selected-menu-checkbox[data-id="${idToMove}"]`).checked = true;
            }
        });

        selectAllAvailableCheckbox.addEventListener('change', (event) => {
            availableMenusTableBody.querySelectorAll('.available-menu-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });

        selectAllSelectedCheckbox.addEventListener('change', (event) => {
            selectedMenusTableBody.querySelectorAll('.selected-menu-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });

        saveMenuAssignmentButton.addEventListener('click', async () => {
            if (!currentSelectedRoleId) {
                alert('메뉴를 저장할 권한을 먼저 선택해주세요.');
                return;
            }

            const menuIdsToSave = currentRoleSelectedMenus.map(item => item._id);

            try {
                const response = await fetchWithAuth(`/api/admin/roles/${currentSelectedRoleId}/menu_configs`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ menu_item_ids: menuIdsToSave })
                });
                const result = await response.json();

                if (response.ok) {
                    alert(result.message || '메뉴 할당이 성공적으로 저장되었습니다!');
                    localStorage.removeItem('cached_menu_items'); // 메뉴 캐시 삭제하여 새로고침 유도
                    roleSelect.dispatchEvent(new Event('change')); 
                } else {
                    alert(result.message || '메뉴 할당 저장에 실패했습니다.');
                    console.error('Error saving menu assignment:', result.message);
                }
            } catch (error) {
                console.error('Network error saving menu assignment:', error);
                alert('네트워크 오류가 발생했습니다. 메뉴 할당을 저장할 수 없습니다.');
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                fetchAllRoles();
                fetchAllMenuItems();
            }
        });
    </script>
{% endblock %}
