<!--frontend/templates/community_detail.html-->
{% extends "base.html" %}

{% block title %}게시글 상세 - Mindbridge{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_detail.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> {# Font Awesome 6으로 변경 #}
{% endblock %}

{% block content %}
    <div class="community-detail-container">
        <div class="community-post-card">
            <h1 class="post-detail-title" id="postTitle"></h1>
            <div class="post-meta">
                <div class="meta-left"> {# 메타 정보 왼쪽 정렬을 위한 래퍼 #}
                    <span id="postCategory" class="post-category"></span>
                    <span class="meta-divider">|</span>
                    <span id="postAuthor"></span>
                    <span class="meta-divider">|</span>
                    <span id="postCreatedAt"></span>
                    <span class="meta-divider">|</span>
                    <span id="postViews">조회수: 0</span>
                    <span class="meta-divider">|</span> {# 게시글 공감수와 다른 메타 정보 사이에 구분선 추가 #}
                    <span id="postLikes">공감: 0</span> {# 게시글 공감수 표시 #}
                </div>
                <div class="post-actions" id="postActions">
                    <!-- 게시글 관리 버튼이 여기에 동적으로 로드됩니다. -->
                </div>
            </div>
            <div class="post-content-section">
                <p id="postContent"></p>
                <div id="postAttachments" class="post-attachments">
                    <!-- 첨부파일이 여기에 표시됩니다 -->
                </div>
            </div>

            <div class="comments-section">
                <h2 class="comments-title">댓글</h2>
                <div class="comment-input-area">
                    <textarea id="commentContent" placeholder="댓글을 입력하세요..."></textarea>
                    <button id="submitComment" class="button primary">댓글 작성</button>
                </div>
                <div id="commentsList" class="comments-list">
                    <!-- 댓글 목록이 여기에 동적으로 로드됩니다. -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postId = window.location.pathname.split('/').pop();
            const postTitleElement = document.getElementById('postTitle');
            const postCategoryElement = document.getElementById('postCategory');
            const postAuthorElement = document.getElementById('postAuthor');
            const postCreatedAtElement = document.getElementById('postCreatedAt');
            const postViewsElement = document.getElementById('postViews');
            const postLikesElement = document.getElementById('postLikes'); // 게시글 공감수 요소
            const postContentElement = document.getElementById('postContent');
            const postAttachmentsElement = document.getElementById('postAttachments');
            const postActionsElement = document.getElementById('postActions'); // post-actions div

            const commentContentInput = document.getElementById('commentContent');
            const submitCommentButton = document.getElementById('submitComment');
            const commentsListElement = document.getElementById('commentsList');

            const loginUrl = "{{ url_for('login') }}";
            const communityListUrl = "{{ url_for('community_list') }}";
            const communityEditBaseUrl = "/community/edit/"; // 수정 페이지 URL 베이스


            // localStorage에서 현재 로그인된 사용자 정보 가져오기
            const currentUserId = localStorage.getItem('user_id');
            let currentUserRoles = [];
            const userRolesString = localStorage.getItem('user_roles');
            if (userRolesString) {
                try {
                    currentUserRoles = JSON.parse(userRolesString);
                } catch (e) {
                    console.error("Error parsing user roles from localStorage:", e);
                }
            }
            console.log("Current user roles:", currentUserRoles); // 디버깅용

            // 관리자 또는 운영자 역할인지 확인하는 헬퍼 함수
            const isAdminOrModerator = () => currentUserRoles.includes('관리자') || currentUserRoles.includes('운영자');


            async function fetchPostDetail() {
                const token = localStorage.getItem('jwt_token');
                console.log("fetchPostDetail: Using token:", token); // 토큰 로깅 추가
                try {
                    // 게시글 상세 정보 API는 @token_required가 필요하므로 fetchWithAuth 사용
                    const response = await fetchWithAuth(`/api/community/posts/${postId}`);
                    const result = await response.json();

                    if (response.ok) {
                        const post = result.post;
                        const mongoContent = result.content; // MongoDB에서 가져온 실제 content와 attachments

                        postTitleElement.textContent = post.title;
                        postCategoryElement.textContent = post.category;
                        postAuthorElement.textContent = `작성자: ${post.display_author_name}`;
                        postCreatedAtElement.textContent = `작성일: ${new Date(post.created_at).toLocaleString()}`;
                        postViewsElement.textContent = `조회수: ${post.views}`;
                        postLikesElement.textContent = `공감: ${post.likes}`; // 게시글 공감수 표시
                        postContentElement.textContent = mongoContent.content; // ⭐ 수정: post.content 대신 mongoContent.content 사용

                        // 첨부파일 표시
                        postAttachmentsElement.innerHTML = ''; // 기존 첨부파일 비우기
                        if (mongoContent.attachments && mongoContent.attachments.length > 0) { // mongoContent.attachments 사용
                            mongoContent.attachments.forEach(path => {
                                const attachmentType = path.split('.').pop().toLowerCase();
                                let element;
                                if (['png', 'jpg', 'jpeg', 'gif'].includes(attachmentType)) {
                                    element = document.createElement('img');
                                    element.src = path;
                                    element.alt = '첨부 이미지';
                                    element.style.maxWidth = '100%'; // 이미지 크기 조정
                                    element.style.height = 'auto';
                                    element.style.borderRadius = '8px';
                                    element.style.marginBottom = '10px';
                                } else if (['mp3', 'wav'].includes(attachmentType)) {
                                    element = document.createElement('audio');
                                    element.controls = true;
                                    element.src = path;
                                    element.style.width = '100%';
                                    element.style.marginBottom = '10px';
                                } else {
                                    element = document.createElement('a');
                                    element.href = path;
                                    element.textContent = `첨부파일: ${path.split('/').pop()}`;
                                    element.target = '_blank';
                                    element.classList.add('attachment-link'); // CSS 클래스 추가
                                }
                                if (element) {
                                    postAttachmentsElement.appendChild(element);
                                }
                            });
                        }


                        // 게시글 관리 버튼 (수정, 삭제, 신고) 표시 로직
                        postActionsElement.innerHTML = ''; // 기존 버튼 비우기
                        const isAdmin = currentUserRoles.includes('관리자'); // 관리자 역할 여부
                        const actionElements = []; // 액션 버튼들을 담을 배열

                        // 수정 버튼
                        if (parseInt(post.user_id) === parseInt(currentUserId) || isAdmin) {
                            const editButton = document.createElement('a');
                            editButton.href = `${communityEditBaseUrl}${postId}`; // JavaScript에서 직접 URL 구성
                            editButton.className = 'action-button';
                            editButton.textContent = '수정';
                            actionElements.push(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.className = 'action-button';
                            deleteButton.textContent = '삭제';
                            deleteButton.addEventListener('click', () => deletePost(postId));
                            actionElements.push(deleteButton);
                        }

                        // 신고 버튼은 로그인 되어있고, 자신의 글이 아닐 경우에만 표시
                        if (localStorage.getItem('jwt_token') && parseInt(post.user_id) !== parseInt(currentUserId)) {
                            const reportButton = document.createElement('button');
                            reportButton.className = 'action-button';
                            reportButton.textContent = '신고';
                            reportButton.addEventListener('click', () => reportPost(postId));
                            actionElements.push(reportButton);
                        }
                        
                        // 게시글 공감 버튼 (로그인 되어있고, 자신의 글이 아닐 경우)
                        if (localStorage.getItem('jwt_token') && parseInt(post.user_id) !== parseInt(currentUserId)) {
                            const recommendPostButton = document.createElement('button');
                            recommendPostButton.className = 'action-button';
                            recommendPostButton.textContent = '공감'; // "공감"으로 표시
                            recommendPostButton.addEventListener('click', () => recommendPost(postId));
                            actionElements.push(recommendPostButton);
                        }

                        // actionElements를 순회하며 DOM에 추가하고, 사이에 구분선 추가
                        actionElements.forEach((element, index) => {
                            if (index > 0) {
                                const divider = document.createElement('span');
                                divider.classList.add('meta-divider'); // 기존 구분선 스타일 활용
                                divider.textContent = '|';
                                postActionsElement.appendChild(divider);
                            }
                            postActionsElement.appendChild(element);
                        });


                    } else {
                        await showAlert(result.message || '게시글을 불러오는 데 실패했습니다.'); // alert 대신 showAlert
                        window.location.href = communityListUrl; // 실패 시 목록으로 돌아가기
                    }
                } catch (error) {
                    console.error('Error fetching post detail:', error);
                    await showAlert('게시글 정보를 불러오는 중 오류가 발생했습니다.'); // alert 대신 showAlert
                    window.location.href = communityListUrl;
                }
            }

            async function deletePost(postId) {
                const confirmed = await showConfirm('정말로 이 게시글을 삭제하시겠습니까?'); // confirm 대신 showConfirm
                if (!confirmed) {
                    return;
                }

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    // fetchWithAuth 사용
                    const response = await fetchWithAuth(`/api/community/posts/${postId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '게시글이 성공적으로 삭제되었습니다!'); // alert 대신 showAlert
                        window.location.href = communityListUrl;
                    } else {
                        await showAlert(result.message || '게시글 삭제에 실패했습니다.'); // alert 대신 showAlert
                        // fetchWithAuth가 401을 처리하므로 여기서는 추가 처리 불필요
                    }
                } catch (error) {
                    console.error('Error deleting post:', error);
                    await showAlert('게시글 삭제 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            }

            async function reportPost(postId) {
                const confirmed = await showConfirm('이 게시글을 신고하시겠습니까? 부적절한 게시물인 경우에만 신고해주세요.'); // confirm 대신 showConfirm
                if (!confirmed) {
                    return;
                }

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    // fetchWithAuth는 base.html에 정의되어 있으므로 직접 호출
                    const response = await fetchWithAuth(`/api/community/posts/${postId}/report`, {
                        method: 'POST'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '게시글이 성공적으로 신고되었습니다!'); // alert 대신 showAlert
                    } else {
                        await showAlert(result.message || '게시글 신고에 실패했습니다.'); // alert 대신 showAlert
                        // fetchWithAuth가 401을 처리하므로 여기서는 추가 처리 불필요
                    }
                } catch (error) {
                    console.error('Error reporting post:', error);
                    await showAlert('게시글 신고 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            }

            async function recommendPost(postId) {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    const response = await fetchWithAuth(`/api/community/posts/${postId}/like`, { //# recommend 대신 like 사용
                        method: 'POST'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '게시글을 추천했습니다!'); // alert 대신 showAlert
                        // 추천 후 게시글 상세 정보 새로고침
                        fetchPostDetail(); 
                    } else if (response.status === 409) { // 이미 공감한 경우
                        await showAlert(result.message || '이미 이 게시글에 공감했습니다.'); // alert 대신 showAlert
                    } else {
                        await showAlert(result.message || '게시글 추천에 실패했습니다.'); // alert 대신 showAlert
                    }
                } catch (error) {
                    console.error('Error recommending post:', error);
                    await showAlert('게시글 추천 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            }


            async function recommendComment(commentId) {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    const response = await fetchWithAuth(`/api/community/comments/${commentId}/like`, {// # recommend 대신 like 사용
                        method: 'POST'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '댓글을 추천했습니다!'); // alert 대신 showAlert
                        // 추천 후 댓글 목록 새로고침 (선택 사항)
                        fetchComments(); 
                    } else if (response.status === 409) { // 이미 공감한 경우
                        await showAlert(result.message || '이미 이 댓글에 공감했습니다.'); // alert 대신 showAlert
                    } else {
                        await showAlert(result.message || '댓글 추천에 실패했습니다.'); // alert 대신 showAlert
                    }
                } catch (error) {
                    console.error('Error recommending comment:', error);
                    await showAlert('댓글 추천 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            }


            async function fetchComments() {
                const token = localStorage.getItem('jwt_token');
                console.log("fetchComments: Using token:", token); // 토큰 로깅 추가
                try {
                    // 댓글 조회 API는 여전히 @token_required가 있으므로 토큰이 필요
                    // fetchWithAuth 함수를 사용하여 토큰을 자동으로 포함시킵니다.
                    const response = await fetchWithAuth(`/api/community/posts/${postId}/comments`);
                    const result = await response.json();

                    if (response.ok) {
                        commentsListElement.innerHTML = ''; // 기존 댓글 비우기
                        if (result.comments && result.comments.length > 0) {
                            result.comments.forEach(comment => {
                                const commentDiv = document.createElement('div');
                                commentDiv.className = 'comment-item';

                                const isCommentAuthor = parseInt(comment.author_id) === parseInt(currentUserId);
                                const canDeleteComment = isCommentAuthor || isAdminOrModerator();

                                // 댓글 수정, 삭제, 신고, 추천 액션을 담을 배열
                                const commentActionElements = [];

                                // 댓글 추천 버튼
                                if (localStorage.getItem('jwt_token') && !isCommentAuthor) { // 로그인 되어있고, 자신의 댓글이 아닐 경우
                                    const recommendCommentButton = document.createElement('button');
                                    recommendCommentButton.className = 'action-button';
                                    recommendCommentButton.textContent = '공감'; // "공감"으로 표시
                                    recommendCommentButton.addEventListener('click', () => recommendComment(comment.id));
                                    commentActionElements.push(recommendCommentButton);
                                }

                                // 댓글 삭제 버튼
                                if (canDeleteComment) {
                                    const deleteCommentButton = document.createElement('button');
                                    deleteCommentButton.className = 'action-button';
                                    deleteCommentButton.textContent = '삭제';
                                    deleteCommentButton.addEventListener('click', () => deleteComment(comment.id));
                                    commentActionElements.push(deleteCommentButton);
                                }

                                // 댓글 신고 버튼 (로그인 되어있고, 자신의 댓글이 아닐 경우)
                                if (localStorage.getItem('jwt_token') && !isCommentAuthor) {
                                    const reportCommentButton = document.createElement('button');
                                    reportCommentButton.className = 'action-button';
                                    reportCommentButton.textContent = '신고';
                                    reportCommentButton.addEventListener('click', () => reportComment(comment.id));
                                    commentActionElements.push(reportCommentButton);
                                }


                                commentDiv.innerHTML = `
                                    <div class="comment-header">
                                        <div class="comment-author-info"> {# 작성자 이름과 공감수를 묶는 래퍼 #}
                                            <span class="comment-author">${comment.display_author_name}</span>
                                            <span class="comment-likes">공감: ${comment.likes}</span> {# 댓글 공감수 표시 #}
                                        </div>
                                        <div class="comment-actions-inline"></div> {# 인라인 액션을 위한 새로운 래퍼 #}
                                    </div>
                                    <span class="comment-date">${new Date(comment.created_at).toLocaleString()}</span> {# 날짜를 이름 아래로 이동 #}
                                    <p class="comment-content">${comment.content}</p>
                                `;
                                commentsListElement.appendChild(commentDiv);

                                // commentActionElements를 순회하며 comment-actions-inline에 추가하고 구분선 추가
                                const commentActionsInlineDiv = commentDiv.querySelector('.comment-actions-inline');
                                commentActionElements.forEach((element, index) => {
                                    if (index > 0) {
                                        const divider = document.createElement('span');
                                        divider.classList.add('meta-divider'); // 기존 구분선 스타일 활용
                                        divider.textContent = '|';
                                        commentActionsInlineDiv.appendChild(divider);
                                    }
                                    commentActionsInlineDiv.appendChild(element);
                                });
                            });

                        } else {
                            commentsListElement.innerHTML = '<p class="no-comments">아직 댓글이 없습니다.</p>';
                        }
                    } else {
                        console.error('Failed to fetch comments:', result.message);
                        commentsListElement.innerHTML = '<p class="no-comments">댓글을 불러오는 데 실패했습니다.</p>';
                        commentContentInput.disabled = true;
                        submitCommentButton.disabled = true;
                    }
                } catch (error) {
                    console.error('Error fetching comments:', error);
                    commentsListElement.innerHTML = '<p class="no-comments">댓글을 불러오는 중 오류가 발생했습니다.</p>';
                    commentContentInput.disabled = true;
                    submitCommentButton.disabled = true;
                }
            }

            async function deleteComment(commentId) {
                const confirmed = await showConfirm('정말로 이 댓글을 삭제하시겠습니까?'); // confirm 대신 showConfirm
                if (!confirmed) {
                    return;
                }

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                try {
                    const response = await fetchWithAuth(`/api/community/comments/${commentId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '댓글이 성공적으로 삭제되었습니다!'); // alert 대신 showAlert
                        fetchComments(); // 삭제 후 댓글 목록 새로고침
                    } else {
                        await showAlert(result.message || '댓글 삭제에 실패했습니다.'); // alert 대신 showAlert
                    }
                } catch (error) {
                    console.error('Error deleting comment:', error);
                    await showAlert('댓글 삭제 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            }

            submitCommentButton.addEventListener('click', async function() {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    await showAlert('로그인이 필요합니다.'); // alert 대신 showAlert
                    window.location.href = loginUrl;
                    return;
                }

                const content = commentContentInput.value.trim();
                if (!content) {
                    await showAlert('댓글 내용을 입력해주세요.'); // alert 대신 showAlert
                    return;
                }

                try {
                    const response = await fetchWithAuth(`/api/community/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: content })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '댓글이 성공적으로 작성되었습니다!'); // alert 대신 showAlert
                        commentContentInput.value = '';
                        fetchComments();
                    } else {
                        await showAlert(result.message || '댓글 작성에 실패했습니다.'); // alert 대신 showAlert
                    }
                } catch (error) {
                    console.error('Error creating comment:', error);
                    await showAlert('댓글 작성 중 오류가 발생했습니다. 다시 시도해주세요.'); // alert 대신 showAlert
                }
            });

            fetchPostDetail();
            fetchComments();
        });
    </script>
{% endblock %}
