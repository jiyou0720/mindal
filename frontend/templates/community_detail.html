{% extends "base.html" %}

{% block title %}게시글 상세 - Mind AI{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_detail.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block page_title %}
    커뮤니티
{% endblock %}

{% block content %}
<div class="post-container">
    <div id="post-content-area">
        <div class="loading-spinner"></div>
    </div>

    <div class="comments-section">
        <h3>댓글 <span id="comment-count">0</span></h3>
        <div id="comments-list">
        </div>
    </div>

    <div class="comment-form-section">
        <form id="comment-form">
            <textarea id="comment-content" placeholder="댓글을 입력하세요..." required></textarea>
            <div class="comment-form-actions">
                <div class="checkbox-group">
                    <input type="checkbox" id="comment-is-anonymous">
                    <label for="comment-is-anonymous">익명으로 작성</label>
                </div>
                <button type="submit" class="submit-comment-btn">댓글 등록</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const postId = {{ post_id }};
    const postContentArea = document.getElementById('post-content-area');
    const commentsList = document.getElementById('comments-list');
    const commentCountSpan = document.getElementById('comment-count');
    const commentForm = document.getElementById('comment-form');

    let currentPostData = null; // 현재 게시글 데이터 저장

    async function fetchPostDetails() {
        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}`);
            if (!response || !response.ok) {
                const errorData = await response.json();
                postContentArea.innerHTML = `<p class="error-text">${errorData.message || '게시글을 불러올 수 없습니다.'}</p>`;
                return;
            }
            const data = await response.json();
            currentPostData = data; // 데이터 저장

            renderPost(currentPostData);
            renderComments(currentPostData.comments || []);
        } catch (error) {
            console.error('Error fetching post details:', error);
            postContentArea.innerHTML = '<p class="error-text">오류가 발생했습니다.</p>';
        }
    }

    function renderPost(post) {
        const postDate = new Date(post.created_at).toLocaleString();
        const authorHtml = post.is_anonymous ? '익명' : `${post.author_nickname || '알수없음'}`;
        const likeIconClass = post.user_liked ? 'fas fa-heart liked' : 'far fa-heart';

        postContentArea.innerHTML = `
            <div class="post-header">
                <span class="post-category">${post.category || '자유'}</span>
                <h1 class="post-title">${post.title}</h1>
                <div class="post-meta">
                    <span class="author">${authorHtml}</span>
                    <span class="date">${postDate}</span>
                    <span class="views">조회수 ${post.views}</span>
                </div>
            </div>
            <div class="post-body">
                ${post.content.replace(/\n/g, '<br>')}
            </div>
            <div class="post-actions">
                <button class="action-btn like-btn" id="like-btn">
                    <i class="${likeIconClass}"></i> 좋아요 <span id="like-count">${post.likes}</span>
                </button>
                <div class="author-actions" id="author-actions" style="display: none;">
                    <a href="/community/edit/${post.id}" class="action-btn edit-btn"><i class="fas fa-edit"></i> 수정</a>
                    <button id="delete-btn" class="action-btn delete-btn"><i class="fas fa-trash"></i> 삭제</button>
                </div>
            </div>
        `;

        // 본인 게시글일 경우 수정/삭제 버튼 표시
        if (currentPostData && window.currentUser && currentPostData.user_id === window.currentUser.id) {
            document.getElementById('author-actions').style.display = 'flex';
        }
        
        // 이벤트 리스너 연결
        document.getElementById('delete-btn')?.addEventListener('click', handleDeletePost);
        document.getElementById('like-btn')?.addEventListener('click', handleLikePost);
    }

    function renderComments(comments) {
        commentCountSpan.textContent = comments.length;
        if (comments.length === 0) {
            commentsList.innerHTML = '<p class="no-comments">아직 댓글이 없습니다.</p>';
            return;
        }
        commentsList.innerHTML = comments.map(comment => {
            // ✅ 댓글 익명 여부 렌더링 수정
            const authorDisplay = comment.is_anonymous ? '익명' : (comment.author_nickname || '알 수 없음');
            return `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${authorDisplay}</span>
                        <span class="comment-date">${new Date(comment.created_at).toLocaleString()}</span>
                    </div>
                    <div class="comment-body">
                        <p>${comment.content.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `
        }).join('');
    }

    async function handleCommentSubmit(e) {
        e.preventDefault();
        const content = document.getElementById('comment-content').value;
        const is_anonymous = document.getElementById('comment-is-anonymous').checked;

        if (!content.trim()) {
            await showAlert('댓글 내용을 입력해주세요.');
            return;
        }

        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, is_anonymous })
            });

            if (response && response.ok) {
                document.getElementById('comment-content').value = '';
                document.getElementById('comment-is-anonymous').checked = false;
                fetchPostDetails(); // 댓글 목록 새로고침
            } else {
                const result = await response.json();
                await showAlert(result.message || '댓글 작성에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error submitting comment:', error);
            await showAlert('댓글 작성 중 오류가 발생했습니다.');
        }
    }
    
    // ✅ 좋아요 버튼 핸들러 추가
    async function handleLikePost() {
        if (!window.currentUser) {
            await showAlert('로그인이 필요합니다.');
            window.location.href = loginUrl;
            return;
        }
        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}/like`, {
                method: 'POST'
            });
            const result = await response.json();

            if(response.ok) {
                const likeCountSpan = document.getElementById('like-count');
                const likeIcon = document.querySelector('#like-btn i');
                
                likeCountSpan.textContent = result.like_count;
                currentPostData.user_liked = result.liked; // 상태 업데이트
                
                if (result.liked) {
                    likeIcon.className = 'fas fa-heart liked';
                } else {
                    likeIcon.className = 'far fa-heart';
                }
            } else {
                await showAlert(result.message || '좋아요 처리에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error liking post:', error);
            await showAlert('좋아요 처리 중 오류가 발생했습니다.');
        }
    }

    async function handleDeletePost() {
        const confirmed = await showConfirm('정말로 이 게시글을 삭제하시겠습니까?');
        if (!confirmed) {
            return;
        }
        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}`, {
                method: 'DELETE'
            });
            if (response && response.ok) {
                await showAlert('게시글이 삭제되었습니다.');
                window.location.href = "{{ url_for('community_list') }}";
            } else {
                const result = await response.json();
                await showAlert(result.message || '게시글 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error deleting post:', error);
            await showAlert('게시글 삭제 중 오류가 발생했습니다.');
        }
    }

    commentForm.addEventListener('submit', handleCommentSubmit);
    fetchPostDetails();
});
</script>
{% endblock %}
