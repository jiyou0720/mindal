{% extends "base.html" %}

{% block title %}게시글 상세 - Mind AI{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_detail.css') }}">
{% endblock %}

{% block page_title %}
    커뮤니티
{% endblock %}

{% block content %}
<div class="post-container">
    <!-- 게시글 내용은 JavaScript로 동적 로드됩니다. -->
    <div id="post-content-area">
        <div class="loading-spinner"></div>
    </div>

    <!-- 댓글 목록 -->
    <div class="comments-section">
        <h3>댓글 <span id="comment-count">0</span></h3>
        <div id="comments-list">
            <!-- 댓글 목록은 JavaScript로 동적 로드됩니다. -->
        </div>
    </div>

    <!-- 댓글 작성 폼 -->
    <div class="comment-form-section">
        <form id="comment-form">
            <textarea id="comment-content" placeholder="댓글을 입력하세요..." required></textarea>
            <div class="comment-form-actions">
                <div class="checkbox-group">
                    <input type="checkbox" id="comment-is-anonymous">
                    <label for="comment-is-anonymous">익명으로 작성</label>
                </div>
                <button type="submit" class="submit-comment-btn">댓글 등록</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const postId = {{ post_id }};
    const postContentArea = document.getElementById('post-content-area');
    const commentsList = document.getElementById('comments-list');
    const commentCountSpan = document.getElementById('comment-count');
    const commentForm = document.getElementById('comment-form');

    async function fetchPostDetails() {
        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}`);
            if (!response || !response.ok) {
                postContentArea.innerHTML = '<p class="error-text">게시글을 불러올 수 없습니다.</p>';
                return;
            }
            const data = await response.json();

            // FIX: Handle cases where the post data might not be nested under a 'post' key.
            const postData = data.post || data;

            // FIX: Ensure postData is a valid object before rendering.
            if (!postData || typeof postData !== 'object' || !postData.created_at) {
                console.error("Invalid or missing post data received from API:", data);
                postContentArea.innerHTML = '<p class="error-text">게시글 데이터를 처리할 수 없습니다.</p>';
                return;
            }

            renderPost(postData);
            renderComments(postData.comments || []); // Safely handle comments
        } catch (error) {
            console.error('Error fetching post details:', error);
            postContentArea.innerHTML = '<p class="error-text">오류가 발생했습니다.</p>';
        }
    }

    function renderPost(post) {
        const postDate = new Date(post.created_at).toLocaleString();
        const authorHtml = post.is_anonymous ? '익명' : `${post.author_nickname} (${post.author_uid})`;
        
        postContentArea.innerHTML = `
            <div class="post-header">
                <span class="post-category">${post.category || '자유'}</span>
                <h1 class="post-title">${post.title}</h1>
                <div class="post-meta">
                    <span class="author">${authorHtml}</span>
                    <span class="date">${postDate}</span>
                    <span class="views">조회수 ${post.views}</span>
                </div>
            </div>
            <div class="post-body">
                ${post.content.replace(/\n/g, '<br>')}
            </div>
            <div class="post-actions">
                <button class="action-btn like-btn"><i class="far fa-heart"></i> 좋아요 <span id="like-count">${post.likes}</span></button>
                <div class="author-actions" id="author-actions" style="display: none;">
                    <a href="/community/edit/${post.id}" class="action-btn edit-btn"><i class="fas fa-edit"></i> 수정</a>
                    <button id="delete-btn" class="action-btn delete-btn"><i class="fas fa-trash"></i> 삭제</button>
                </div>
            </div>
        `;

        const token = localStorage.getItem('access_token');
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.user_id === post.user_id) {
                    document.getElementById('author-actions').style.display = 'flex';
                }
            } catch(e) { console.error('Error parsing token', e); }
        }
        
        document.getElementById('delete-btn')?.addEventListener('click', handleDeletePost);
    }

    function renderComments(comments) {
        commentCountSpan.textContent = comments.length;
        if (comments.length === 0) {
            commentsList.innerHTML = '<p class="no-comments">아직 댓글이 없습니다.</p>';
            return;
        }
        commentsList.innerHTML = comments.map(comment => `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">${comment.is_anonymous ? '익명' : comment.author_nickname}</span>
                    <span class="comment-date">${new Date(comment.created_at).toLocaleString()}</span>
                </div>
                <div class="comment-body">
                    <p>${comment.content.replace(/\n/g, '<br>')}</p>
                </div>
            </div>
        `).join('');
    }

    async function handleCommentSubmit(e) {
        e.preventDefault();
        const content = document.getElementById('comment-content').value;
        const is_anonymous = document.getElementById('comment-is-anonymous').checked;

        if (!content.trim()) return;

        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, is_anonymous })
            });

            if (response && response.ok) {
                document.getElementById('comment-content').value = '';
                document.getElementById('comment-is-anonymous').checked = false;
                fetchPostDetails(); // Refresh comments
            } else {
                await showAlert('댓글 작성에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error submitting comment:', error);
            await showAlert('댓글 작성 중 오류가 발생했습니다.');
        }
    }
    
    async function handleDeletePost() {
        if (!window.confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
            return;
        }
        try {
            const response = await fetchWithAuth(`/api/community/posts/${postId}`, {
                method: 'DELETE'
            });
            if (response && response.ok) {
                await showAlert('게시글이 삭제되었습니다.');
                window.location.href = "{{ url_for('community_list') }}";
            } else {
                await showAlert('게시글 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error deleting post:', error);
            await showAlert('게시글 삭제 중 오류가 발생했습니다.');
        }
    }

    commentForm.addEventListener('submit', handleCommentSubmit);
    fetchPostDetails();
});
</script>
{% endblock %}
