<<<<<<< HEAD
<!-- frontend/templates/chatbot_feedback.html -->
{% extends "base.html" %}

{% block title %}챗봇 피드백 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot_feedback.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>챗봇 피드백/별점 관리</h1>
        <p>사용자들이 남긴 챗봇 상담 피드백과 별점 데이터를 열람하고 분석합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>피드백 목록</h2>
            <div class="search-bar">
                <input type="text" id="feedbackSearchInput" placeholder="사용자 ID, 상담 내용 등으로 검색...">
                <button id="searchFeedbackButton" class="button primary">검색</button>
            </div>
            <div class="data-table-container">
                <table class="data-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>사용자 ID</th>
                            <th>별점</th>
                            <th>피드백 내용</th>
                            <th>상담 일시</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody">
                        <tr><td colspan="6" class="loading-row">피드백을 불러오는 중...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="noFeedbackMessage" class="no-data-message hidden">피드백이 없습니다.</p>
        </div>
    </div>

    <!-- 피드백 상세 모달 -->
    <div id="feedbackDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="feedbackModalTitle">피드백 상세</h3>
            <div class="detail-content">
                <p><strong>피드백 ID:</strong> <span id="detailFeedbackId"></span></p>
                <p><strong>사용자 ID:</strong> <span id="detailFeedbackUserId"></span></p>
                <p><strong>별점:</strong> <span id="detailFeedbackRating"></span></p>
                <p><strong>상담 일시:</strong> <span id="detailFeedbackTimestamp"></span></p>
                <p><strong>피드백 내용:</strong></p>
                <div id="detailFeedbackContent" class="feedback-content-area"></div>
                <p><strong>관련 상담 대화:</strong></p>
                <div id="detailConversation" class="conversation-area"></div>
            </div>
            <div class="modal-actions"> {# NEW: 모달 액션 버튼 그룹 #}
                <button class="button danger" id="deleteFeedbackButton">피드백 삭제</button> {# NEW #}
                <button class="button primary" id="closeFeedbackModalButton">닫기</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const feedbackTableBody = document.getElementById('feedbackTableBody');
        const feedbackSearchInput = document.getElementById('feedbackSearchInput');
        const searchFeedbackButton = document.getElementById('searchFeedbackButton');
        const noFeedbackMessage = document.getElementById('noFeedbackMessage');
        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        const feedbackDetailModal = document.getElementById('feedbackDetailModal');
        const closeFeedbackModalButton = feedbackDetailModal.querySelector('.close-button');
        const detailFeedbackId = document.getElementById('detailFeedbackId');
        const detailFeedbackUserId = document.getElementById('detailFeedbackUserId');
        const detailFeedbackRating = document.getElementById('detailFeedbackRating');
        const detailFeedbackTimestamp = document.getElementById('detailFeedbackTimestamp');
        const detailFeedbackContent = document.getElementById('detailFeedbackContent');
        const detailConversation = document.getElementById('detailConversation');
        const deleteFeedbackButton = document.getElementById('deleteFeedbackButton'); // NEW

        let allFeedback = []; // 모든 피드백 데이터를 저장할 배열

        // 접근 권한 확인 함수 (관리자, 개발자)
        async function checkFeedbackAccess() {
            console.log('checkFeedbackAccess (chatbot_feedback): 함수 시작');
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('챗봇 피드백 관리 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response) { return false; }
                if (!response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkFeedbackAccess (chatbot_feedback): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자') && !userRoles.includes('개발자')) {
                    await showAlert('관리자 또는 개발자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('checkFeedbackAccess (chatbot_feedback): 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 모든 피드백 불러오기
        async function fetchAllFeedback() {
            feedbackTableBody.innerHTML = '<tr><td colspan="6" class="loading-row">피드백을 불러오는 중...</td></tr>';
            noFeedbackMessage.classList.add('hidden');

            try {
                const response = await fetchWithAuth('/api/admin/chatbot_feedback');
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '피드백 목록을 불러오는 데 실패했습니다.');
                    feedbackTableBody.innerHTML = '<tr><td colspan="6" class="error-row">피드백을 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                allFeedback = data.feedback || [];
                renderFeedbackTable(allFeedback);
            } catch (error) {
                console.error('피드백 목록 로드 중 오류 발생:', error);
                await showAlert('피드백 목록을 불러오는 중 네트워크 오류가 발생했습니다.');
                feedbackTableBody.innerHTML = '<tr><td colspan="6" class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 피드백 테이블 렌더링
        function renderFeedbackTable(feedbackToRender) {
            feedbackTableBody.innerHTML = '';
            if (feedbackToRender.length === 0) {
                noFeedbackMessage.classList.remove('hidden');
                return;
            }
            noFeedbackMessage.classList.add('hidden');

            feedbackToRender.forEach(item => {
                const row = feedbackTableBody.insertRow();
                const displayTimestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : '-';
                const ratingStars = '⭐'.repeat(item.rating || 0); 

                row.innerHTML = `
                    <td>${item.id || item._id || '-'}</td>
                    <td>${item.user_id || '-'}</td>
                    <td>${ratingStars} (${item.rating || 0}/5)</td>
                    <td>${item.comment || '-'}</td>
                    <td>${displayTimestamp}</td>
                    <td class="action-cell">
                        <button class="button small secondary view-feedback-button" data-feedback-id="${item.id || item._id}">상세 보기</button>
                        <button class="button small danger delete-feedback-button" data-feedback-id="${item.id || item._id}">삭제</button> {# NEW #}
                    </td>
                `;
            });

            document.querySelectorAll('.view-feedback-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const feedbackId = e.target.dataset.feedbackId;
                    openFeedbackDetailModal(feedbackId);
                });
            });

            document.querySelectorAll('.delete-feedback-button').forEach(button => { // NEW
                button.addEventListener('click', (e) => {
                    const feedbackId = e.target.dataset.feedbackId;
                    deleteFeedback(feedbackId);
                });
            });
        }

        // 피드백 상세 모달 열기
        async function openFeedbackDetailModal(feedbackId) {
            try {
                const response = await fetchWithAuth(`/api/admin/chatbot_feedback/${feedbackId}`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '피드백 상세 정보를 불러오는 데 실패했습니다.');
                    return;
                }
                const feedback = await response.json();

                detailFeedbackId.textContent = feedback.id || feedback._id || '-';
                detailFeedbackUserId.textContent = feedback.user_id || '-';
                detailFeedbackRating.textContent = `${'⭐'.repeat(feedback.rating || 0)} (${feedback.rating || 0}/5)`;
                detailFeedbackTimestamp.textContent = feedback.timestamp ? new Date(feedback.timestamp).toLocaleString() : '-';
                detailFeedbackContent.textContent = feedback.comment || '내용 없음';

                detailConversation.innerHTML = '';
                if (feedback.conversation && Array.isArray(feedback.conversation)) {
                    feedback.conversation.forEach(msg => {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>${msg.role}:</strong> ${msg.text}`;
                        detailConversation.appendChild(p);
                    });
                } else {
                    detailConversation.textContent = '관련 대화 내용 없음.';
                }

                // 삭제 버튼에 이벤트 리스너 재할당 및 feedbackId 설정
                deleteFeedbackButton.onclick = () => deleteFeedback(feedbackId); // NEW

                feedbackDetailModal.classList.add('visible');
            } catch (error) {
                console.error('피드백 상세 정보 로드 중 오류 발생:', error);
                await showAlert('피드백 상세 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }

        // 피드백 삭제
        async function deleteFeedback(feedbackId) { // NEW
            const confirmed = await showConfirm('정말로 이 피드백을 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetchWithAuth(`/api/admin/chatbot_feedback/${feedbackId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await showAlert('피드백이 성공적으로 삭제되었습니다.');
                    feedbackDetailModal.classList.remove('visible'); // 모달 닫기
                    fetchAllFeedback(); // 목록 새로고침
                } else {
                    await showAlert('피드백 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('피드백 삭제 중 오류 발생:', error);
                await showAlert('피드백 삭제 중 오류가 발생했습니다.');
            }
        }

        // 피드백 상세 모달 닫기
        closeFeedbackModalButton.addEventListener('click', () => {
            feedbackDetailModal.classList.remove('visible');
        });

        // 검색 기능 (임시)
        searchFeedbackButton.addEventListener('click', () => {
            const searchTerm = feedbackSearchInput.value.toLowerCase().trim();
            const filteredFeedback = allFeedback.filter(item => {
                const userIdMatch = (item.user_id && String(item.user_id).toLowerCase().includes(searchTerm));
                const commentMatch = (item.comment && item.comment.toLowerCase().includes(searchTerm));
                return userIdMatch || commentMatch;
            });
            renderFeedbackTable(filteredFeedback);
        });

        feedbackSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFeedbackButton.click();
            }
        });

        // 초기 로드 시 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkFeedbackAccess();
            if (hasAccess) {
                fetchAllFeedback();
            }
        });
    </script>
{% endblock %}
=======
<!-- frontend/templates/chatbot_feedback.html -->
{% extends "base.html" %}

{% block title %}챗봇 피드백 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot_feedback.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>챗봇 피드백/별점 관리</h1>
        <p>사용자들이 남긴 챗봇 상담 피드백과 별점 데이터를 열람하고 분석합니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>피드백 목록</h2>
            <div class="search-bar">
                <input type="text" id="feedbackSearchInput" placeholder="사용자 ID, 상담 내용 등으로 검색...">
                <button id="searchFeedbackButton" class="button primary">검색</button>
            </div>
            <div class="data-table-container">
                <table class="data-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>사용자 ID</th>
                            <th>별점</th>
                            <th>피드백 내용</th>
                            <th>상담 일시</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody">
                        <tr><td colspan="6" class="loading-row">피드백을 불러오는 중...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="noFeedbackMessage" class="no-data-message hidden">피드백이 없습니다.</p>
        </div>
    </div>

    <!-- 피드백 상세 모달 -->
    <div id="feedbackDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="feedbackModalTitle">피드백 상세</h3>
            <div class="detail-content">
                <p><strong>피드백 ID:</strong> <span id="detailFeedbackId"></span></p>
                <p><strong>사용자 ID:</strong> <span id="detailFeedbackUserId"></span></p>
                <p><strong>별점:</strong> <span id="detailFeedbackRating"></span></p>
                <p><strong>상담 일시:</strong> <span id="detailFeedbackTimestamp"></span></p>
                <p><strong>피드백 내용:</strong></p>
                <div id="detailFeedbackContent" class="feedback-content-area"></div>
                <p><strong>관련 상담 대화:</strong></p>
                <div id="detailConversation" class="conversation-area"></div>
            </div>
            <div class="modal-actions"> {# NEW: 모달 액션 버튼 그룹 #}
                <button class="button danger" id="deleteFeedbackButton">피드백 삭제</button> {# NEW #}
                <button class="button primary" id="closeFeedbackModalButton">닫기</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // base.html에서 전역으로 선언된 loginUrl, homeUrl, fetchWithAuth, showAlert, showConfirm 사용

        const feedbackTableBody = document.getElementById('feedbackTableBody');
        const feedbackSearchInput = document.getElementById('feedbackSearchInput');
        const searchFeedbackButton = document.getElementById('searchFeedbackButton');
        const noFeedbackMessage = document.getElementById('noFeedbackMessage');
        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        const feedbackDetailModal = document.getElementById('feedbackDetailModal');
        const closeFeedbackModalButton = feedbackDetailModal.querySelector('.close-button');
        const detailFeedbackId = document.getElementById('detailFeedbackId');
        const detailFeedbackUserId = document.getElementById('detailFeedbackUserId');
        const detailFeedbackRating = document.getElementById('detailFeedbackRating');
        const detailFeedbackTimestamp = document.getElementById('detailFeedbackTimestamp');
        const detailFeedbackContent = document.getElementById('detailFeedbackContent');
        const detailConversation = document.getElementById('detailConversation');
        const deleteFeedbackButton = document.getElementById('deleteFeedbackButton'); // NEW

        let allFeedback = []; // 모든 피드백 데이터를 저장할 배열

        // 접근 권한 확인 함수 (관리자, 개발자)
        async function checkFeedbackAccess() {
            console.log('checkFeedbackAccess (chatbot_feedback): 함수 시작');
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('챗봇 피드백 관리 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response) { return false; }
                if (!response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];
                console.log('checkFeedbackAccess (chatbot_feedback): 사용자 역할:', userRoles);

                if (!userRoles.includes('관리자') && !userRoles.includes('개발자')) {
                    await showAlert('관리자 또는 개발자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('checkFeedbackAccess (chatbot_feedback): 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 모든 피드백 불러오기
        async function fetchAllFeedback() {
            feedbackTableBody.innerHTML = '<tr><td colspan="6" class="loading-row">피드백을 불러오는 중...</td></tr>';
            noFeedbackMessage.classList.add('hidden');

            try {
                const response = await fetchWithAuth('/api/admin/chatbot_feedback');
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '피드백 목록을 불러오는 데 실패했습니다.');
                    feedbackTableBody.innerHTML = '<tr><td colspan="6" class="error-row">피드백을 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                allFeedback = data.feedback || [];
                renderFeedbackTable(allFeedback);
            } catch (error) {
                console.error('피드백 목록 로드 중 오류 발생:', error);
                await showAlert('피드백 목록을 불러오는 중 네트워크 오류가 발생했습니다.');
                feedbackTableBody.innerHTML = '<tr><td colspan="6" class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 피드백 테이블 렌더링
        function renderFeedbackTable(feedbackToRender) {
            feedbackTableBody.innerHTML = '';
            if (feedbackToRender.length === 0) {
                noFeedbackMessage.classList.remove('hidden');
                return;
            }
            noFeedbackMessage.classList.add('hidden');

            feedbackToRender.forEach(item => {
                const row = feedbackTableBody.insertRow();
                const displayTimestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : '-';
                const ratingStars = '⭐'.repeat(item.rating || 0); 

                row.innerHTML = `
                    <td>${item.id || item._id || '-'}</td>
                    <td>${item.user_id || '-'}</td>
                    <td>${ratingStars} (${item.rating || 0}/5)</td>
                    <td>${item.comment || '-'}</td>
                    <td>${displayTimestamp}</td>
                    <td class="action-cell">
                        <button class="button small secondary view-feedback-button" data-feedback-id="${item.id || item._id}">상세 보기</button>
                        <button class="button small danger delete-feedback-button" data-feedback-id="${item.id || item._id}">삭제</button> {# NEW #}
                    </td>
                `;
            });

            document.querySelectorAll('.view-feedback-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const feedbackId = e.target.dataset.feedbackId;
                    openFeedbackDetailModal(feedbackId);
                });
            });

            document.querySelectorAll('.delete-feedback-button').forEach(button => { // NEW
                button.addEventListener('click', (e) => {
                    const feedbackId = e.target.dataset.feedbackId;
                    deleteFeedback(feedbackId);
                });
            });
        }

        // 피드백 상세 모달 열기
        async function openFeedbackDetailModal(feedbackId) {
            try {
                const response = await fetchWithAuth(`/api/admin/chatbot_feedback/${feedbackId}`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '피드백 상세 정보를 불러오는 데 실패했습니다.');
                    return;
                }
                const feedback = await response.json();

                detailFeedbackId.textContent = feedback.id || feedback._id || '-';
                detailFeedbackUserId.textContent = feedback.user_id || '-';
                detailFeedbackRating.textContent = `${'⭐'.repeat(feedback.rating || 0)} (${feedback.rating || 0}/5)`;
                detailFeedbackTimestamp.textContent = feedback.timestamp ? new Date(feedback.timestamp).toLocaleString() : '-';
                detailFeedbackContent.textContent = feedback.comment || '내용 없음';

                detailConversation.innerHTML = '';
                if (feedback.conversation && Array.isArray(feedback.conversation)) {
                    feedback.conversation.forEach(msg => {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>${msg.role}:</strong> ${msg.text}`;
                        detailConversation.appendChild(p);
                    });
                } else {
                    detailConversation.textContent = '관련 대화 내용 없음.';
                }

                // 삭제 버튼에 이벤트 리스너 재할당 및 feedbackId 설정
                deleteFeedbackButton.onclick = () => deleteFeedback(feedbackId); // NEW

                feedbackDetailModal.classList.add('visible');
            } catch (error) {
                console.error('피드백 상세 정보 로드 중 오류 발생:', error);
                await showAlert('피드백 상세 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }

        // 피드백 삭제
        async function deleteFeedback(feedbackId) { // NEW
            const confirmed = await showConfirm('정말로 이 피드백을 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetchWithAuth(`/api/admin/chatbot_feedback/${feedbackId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await showAlert('피드백이 성공적으로 삭제되었습니다.');
                    feedbackDetailModal.classList.remove('visible'); // 모달 닫기
                    fetchAllFeedback(); // 목록 새로고침
                } else {
                    await showAlert('피드백 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('피드백 삭제 중 오류 발생:', error);
                await showAlert('피드백 삭제 중 오류가 발생했습니다.');
            }
        }

        // 피드백 상세 모달 닫기
        closeFeedbackModalButton.addEventListener('click', () => {
            feedbackDetailModal.classList.remove('visible');
        });

        // 검색 기능 (임시)
        searchFeedbackButton.addEventListener('click', () => {
            const searchTerm = feedbackSearchInput.value.toLowerCase().trim();
            const filteredFeedback = allFeedback.filter(item => {
                const userIdMatch = (item.user_id && String(item.user_id).toLowerCase().includes(searchTerm));
                const commentMatch = (item.comment && item.comment.toLowerCase().includes(searchTerm));
                return userIdMatch || commentMatch;
            });
            renderFeedbackTable(filteredFeedback);
        });

        feedbackSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFeedbackButton.click();
            }
        });

        // 초기 로드 시 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkFeedbackAccess();
            if (hasAccess) {
                fetchAllFeedback();
            }
        });
    </script>
{% endblock %}
>>>>>>> 32e57f7623365b93a09d34dc9cad501cc18c11af
