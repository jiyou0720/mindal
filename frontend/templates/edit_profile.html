<!-- frontend/templates/edit_profile.html -->
{% extends "base.html" %}

{% block title %}프로필 수정 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_profile.css') }}">
{% endblock %}

{% block content %}
    <div class="edit-profile-container">
        <h1>프로필 수정</h1>
        <p>회원님의 정보를 수정하고 닉네임 변경 이력을 확인할 수 있습니다.</p>

        <div class="profile-form-card">
            <h2>내 정보 수정</h2>
            <form id="profileEditForm">
                <div class="form-group">
                    <label for="username">사용자 이름 (변경 불가)</label>
                    <input type="text" id="username" name="username" readonly>
                </div>
                <div class="form-group">
                    <label for="email">이메일 (변경 불가)</label>
                    <input type="email" id="email" name="email" readonly>
                </div>
                <div class="form-group">
                    <label for="nickname">닉네임</label>
                    <input type="text" id="nickname" name="nickname" required>
                </div>
                <div class="form-group">
                    <label for="gender">성별</label>
                    <select id="gender" name="gender">
                        <option value="">선택 안 함</option>
                        <option value="남성">남성</option>
                        <option value="여성">여성</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="age">나이</label>
                    <input type="number" id="age" name="age" min="0" max="150">
                </div>
                <div class="form-group">
                    <label for="major">전공</label>
                    <input type="text" id="major" name="major">
                </div>
                <button type="submit" class="button primary"><i class="fas fa-save"></i> 변경 사항 저장</button>
            </form>
        </div>

        <div class="nickname-history-card">
            <h2>닉네임 변경 이력</h2>
            <div id="nicknameHistoryList" class="history-list">
                <!-- 닉네임 이력이 여기에 동적으로 로드됩니다 -->
                <p id="noHistoryMessage" style="display: none;">닉네임 변경 이력이 없습니다.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const nicknameInput = document.getElementById('nickname');
            const genderSelect = document.getElementById('gender');
            const ageInput = document.getElementById('age');
            const majorInput = document.getElementById('major');
            const profileEditForm = document.getElementById('profileEditForm');
            const nicknameHistoryList = document.getElementById('nicknameHistoryList');
            const noHistoryMessage = document.getElementById('noHistoryMessage');

            // 사용자 정보 불러오기 및 폼 채우기
            async function fetchUserProfileAndFillForm() {
                console.log('edit_profile: Attempting to fetch user profile for editing...');
                try {
                    const response = await fetchWithAuth('/api/auth/me');
                    const result = await response.json();

                    if (response.ok) {
                        const user = result.user;
                        console.log('edit_profile: User profile fetched:', user);
                        usernameInput.value = user.username;
                        emailInput.value = user.email;
                        nicknameInput.value = user.nickname || '';
                        genderSelect.value = user.gender || '';
                        ageInput.value = user.age !== null ? user.age : '';
                        majorInput.value = user.major || '';
                    } else {
                        await showAlert(result.message || '사용자 정보를 불러오는 데 실패했습니다.');
                        console.error('edit_profile: Failed to load user profile. Status:', response.status, 'Message:', result.message);
                    }
                } catch (error) {
                    console.error('edit_profile: Network error or unexpected error fetching user profile:', error);
                    await showAlert('네트워크 오류가 발생하여 사용자 정보를 불러올 수 없습니다. 콘솔을 확인해주세요.');
                }
            }

            // 닉네임 변경 이력 불러오기
            async function fetchNicknameHistory() {
                console.log('edit_profile: Attempting to fetch nickname history...');
                try {
                    const response = await fetchWithAuth('/api/auth/nickname_history');
                    const result = await response.json();

                    if (response.ok) {
                        const history = result.nickname_history;
                        console.log('edit_profile: Nickname history fetched:', history);
                        nicknameHistoryList.innerHTML = ''; // 기존 목록 초기화

                        if (!Array.isArray(history) || history.length === 0) {
                            noHistoryMessage.style.display = 'block';
                        } else {
                            noHistoryMessage.style.display = 'none';
                            history.forEach(entry => {
                                const historyItem = document.createElement('div');
                                historyItem.classList.add('history-item');
                                const changedDate = new Date(entry.changed_at).toLocaleString('ko-KR', {
                                    year: 'numeric', month: 'long', day: 'numeric',
                                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                                });
                                historyItem.innerHTML = `
                                    <span class="history-date">${changedDate}</span>
                                    <span class="history-detail">
                                        ${entry.old_nickname ? `<span class="old-nickname">${entry.old_nickname}</span> → ` : ''}
                                        <span class="new-nickname">${entry.new_nickname}</span>
                                    </span>
                                `;
                                nicknameHistoryList.appendChild(historyItem);
                            });
                        }
                    } else {
                        await showAlert(result.message || '닉네임 이력을 불러오는 데 실패했습니다.');
                        console.error('edit_profile: Failed to load nickname history. Status:', response.status, 'Message:', result.message);
                    }
                } catch (error) {
                    console.error('edit_profile: Network error or unexpected error fetching nickname history:', error);
                    await showAlert('네트워크 오류가 발생하여 닉네임 이력을 불러올 수 없습니다. 콘솔을 확인해주세요.');
                }
            }

            // 폼 제출 시 프로필 업데이트
            profileEditForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // 기본 폼 제출 방지
                console.log('edit_profile: Profile update form submitted.');

                const updatedData = {
                    nickname: nicknameInput.value,
                    gender: genderSelect.value,
                    age: ageInput.value ? parseInt(ageInput.value, 10) : null,
                    major: majorInput.value
                };

                try {
                    const response = await fetchWithAuth('/api/auth/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });
                    const result = await response.json();

                    if (response.ok) {
                        await showAlert(result.message || '프로필이 성공적으로 업데이트되었습니다.');
                        console.log('edit_profile: Profile update successful. New user data:', result.user);
                        
                        localStorage.setItem('nickname', result.user.nickname);
                        
                        // **수정된 부분**: 닉네임 이력을 새로고침하여 변경 사항을 즉시 반영합니다.
                        // 사용자에게 로딩 상태를 보여주어 더 나은 경험을 제공합니다.
                        nicknameHistoryList.innerHTML = '<p>이력 목록을 새로고침하는 중...</p>';
                        await fetchNicknameHistory();

                    } else {
                        await showAlert(result.message || `프로필 업데이트 실패: 상태 코드 ${response.status}`);
                        console.error('edit_profile: Profile update failed. Status:', response.status, 'Message:', result.message);
                    }
                } catch (error) {
                    console.error('edit_profile: Network error or unexpected error during profile update:', error);
                    await showAlert('네트워크 오류가 발생하여 프로필을 업데이트할 수 없습니다. 콘솔을 확인해주세요.');
                }
            });

            // 페이지 로드 시 정보 불러오기
            await fetchUserProfileAndFillForm();
            await fetchNicknameHistory();
        });
    </script>
{% endblock %}

