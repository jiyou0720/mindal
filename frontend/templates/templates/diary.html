<!--frontend/templates/diary.html-->
{% extends "base.html" %}

{% block title %}ì˜¤ëŠ˜, ì¼ê¸° - ì˜ë§ˆì¸ë“œë§í¬{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diary.css') }}">
    {# Firebase SDK CDN ë§í¬ëŠ” ì´ì œ í•„ìš” ì—†ìŠµë‹ˆë‹¤. Flask ë°±ì—”ë“œ APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. #}
    {# <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script> #}
    {# <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script> #}
    {# <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script> #}
{% endblock %}

{% block content %}
    <div class="diary-main-area">
        <div class="diary-content-wrapper-outer" id="diaryContentWrapperOuter"> {# ì „ì²´ ì¼ê¸° ì½˜í…ì¸ ë¥¼ ê°ì‹¸ëŠ” ë˜í¼ #}
            <div class="diary-header-section">
                <h1 class="diary-page-title">ì˜¤ëŠ˜, ë‚˜ì˜ ì¼ê¸°</h1>
                <div class="diary-random-title-box">
                    <div class="diary-random-title-text">ì˜¤ëŠ˜ì˜ ëœë¤ ì¼ê¸° - ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”!</div>
                </div>
            </div>

            <div class="diary-calendar-container">
                <div class="calendar-navigation">
                    <button id="prevMonth" class="nav-button"><i class="fas fa-chevron-left"></i></button>
                    <span id="currentMonthYear" class="month-year-display"></span>
                    <button id="nextMonth" class="nav-button"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekdays">
                        <span>ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- ë‚ ì§œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <div class="diary-entry-section">
                <div class="diary-entry-header">
                    <h2 id="diaryEntryTitle">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.</h2>
                    <div class="mood-selection-container" id="moodEmojisContainer">
                        <span class="mood-emoji" data-mood="happy">ğŸ˜Š</span>
                        <span class="mood-emoji" data-mood="neutral">ğŸ˜</span>
                        <span class="mood-emoji" data-mood="sad">ğŸ˜”</span>
                        <span class="mood-emoji" data-mood="angry">ğŸ˜ </span>
                        <span class="mood-emoji" data-mood="excited">ğŸ¤©</span>
                        <span class="mood-emoji" data-mood="calm">ğŸ˜Œ</span>
                        <span class="mood-emoji" data-mood="anxious">ğŸ˜Ÿ</span>
                        <span class="mood-emoji" data-mood="grateful">ğŸ™</span>
                        <span class="mood-emoji" data-mood="tired">ğŸ˜«</span>
                        <span class="mood-emoji" data-mood="lonely">ğŸ¥º</span>
                    </div>
                </div>
                <form id="diaryEntryForm" class="diary-entry-form">
                    <textarea id="diaryContent" placeholder="ì˜¤ëŠ˜ì˜ ì¼ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”..." rows="10" class="diary-textarea"></textarea>
                    <div class="diary-buttons">
                        <button type="submit" id="saveDiary" class="btn primary">ì €ì¥</button>
                        <button type="button" id="deleteDiary" class="btn secondary">ì‚­ì œ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
        <div class="login-overlay hidden" id="loginOverlay">
            <div class="login-prompt-card">
                <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                <p>ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ê±°ë‚˜ íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”.</p>
                <div class="prompt-buttons">
                    <a href="{{ url_for('login') }}" class="btn primary">ë¡œê·¸ì¸</a>
                    <a href="{{ url_for('signup') }}" class="btn secondary">íšŒì›ê°€ì…</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        const moodEmojis = {
            'happy': 'ğŸ˜Š', 'neutral': 'ğŸ˜', 'sad': 'ğŸ˜”', 'angry': 'ğŸ˜ ',
            'excited': 'ğŸ¤©', 'calm': 'ğŸ˜Œ', 'anxious': 'ğŸ˜Ÿ', 'grateful': 'ğŸ™',
            'tired': 'ğŸ˜«', 'lonely': 'ğŸ¥º'
        };

        let currentActiveDateElement = null; // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ DOM ìš”ì†Œ
        let selectedDate = null; // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ (Date ê°ì²´)
        let selectedMood = null; // ì„ íƒëœ ë¬´ë“œ í‚¤
        let currentDiaryEntryId = null; // í˜„ì¬ ë¡œë“œëœ ì¼ê¸°ì˜ MongoDB _id (ì‚­ì œìš©)

        // --- ì—¬ê¸°ì— currentMonth ë³€ìˆ˜ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤ ---
        let currentMonth = new Date(); // ìº˜ë¦°ë”ì˜ í˜„ì¬ í‘œì‹œ ì›”ì„ ë‚˜íƒ€ë‚´ëŠ” Date ê°ì²´

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const calendarDaysContainer = document.getElementById('calendarDays');
        const currentMonthYearSpan = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const diaryEntryForm = document.getElementById('diaryEntryForm');
        const diaryContentInput = document.getElementById('diaryContent');
        const saveDiaryButton = document.getElementById('saveDiary');
        const deleteDiaryButton = document.getElementById('deleteDiary');
        const diaryContentWrapperOuter = document.getElementById('diaryContentWrapperOuter');
        const loginOverlay = document.getElementById('loginOverlay');
        const moodEmojisContainer = document.getElementById('moodEmojisContainer');
        const diaryEntryTitle = document.getElementById('diaryEntryTitle'); // ì¶”ê°€ëœ ì œëª© ìš”ì†Œ

        // JWT í† í°ì´ í•„ìš”í•œ API ìš”ì²­ì„ ìœ„í•œ fetch ë˜í¼ í•¨ìˆ˜ (base.htmlì— ì •ì˜ë¨)
        // ì´ í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ì²´í¬ë‚˜ ì¼ê¸° ì €ì¥/ë¡œë“œ ì‹œ ì˜¤ë¥˜ ë°œìƒ
        // base.htmlì—ì„œ ì •ì˜ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì„ ì–¸í•˜ì§€ ì•ŠìŒ

        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function showLoginRequiredUI() {
            diaryContentWrapperOuter.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        }

        function showDiaryContentUI() {
            diaryContentWrapperOuter.classList.remove('hidden');
            loginOverlay.classList.add('hidden');
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function checkLoginStatusAndUpdateUI() {
            const token = localStorage.getItem('jwt_token');

            if (!token) {
                console.log("No JWT token found. Showing login required UI.");
                showLoginRequiredUI();
                return;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', {
                    method: 'GET'
                });

                if (response.ok) {
                    console.log("Token verified successfully. Showing diary content.");
                    showDiaryContentUI();
                    renderCalendar(); // í† í° í™•ì¸ ì„±ê³µ ì‹œ ìº˜ë¦°ë” ë Œë”ë§
                } else {
                    console.error("Failed to verify token (server error or invalid token). Showing login required UI.");
                    localStorage.removeItem('jwt_token'); // ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ì œê±°
                    showLoginRequiredUI();
                }
            } catch (error) {
                console.error("Failed to verify token (network error or unexpected response):", error);
                localStorage.removeItem('jwt_token'); // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œì—ë„ í† í° ì œê±°
                showLoginRequiredUI();
            }
        }

        // ìº˜ë¦°ë” ë Œë”ë§ í•¨ìˆ˜
        async function renderCalendar() { // async í‚¤ì›Œë“œ ì¶”ê°€
            calendarDaysContainer.innerHTML = ''; // ê¸°ì¡´ ë‚ ì§œ ì§€ìš°ê¸°
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth(); // 0-11
            currentMonthYearSpan.textContent = `${year}ë…„ ${month + 1}ì›”`;

            // í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ ë‚  (ìš”ì¼ì„ ì•Œê¸° ìœ„í•¨)
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = ì¼ìš”ì¼, 6 = í† ìš”ì¼
            // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ 
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

            // --- ì›”ë³„ ì¼ê¸° ìš”ì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ---
            let monthlySummary = {};
            try {
                const summaryResponse = await fetchWithAuth(`/api/diary/entries/month_summary?year=${year}&month=${month + 1}`);
                if (summaryResponse.ok) {
                    const summaryResult = await summaryResponse.json();
                    monthlySummary = summaryResult.summary;
                    console.log("Monthly summary fetched:", monthlySummary); // ë””ë²„ê¹…ìš©
                } else if (summaryResponse.status === 401) {
                    localStorage.removeItem('jwt_token');
                    showLoginRequiredUI();
                    alert("ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                } else {
                    console.error("Failed to fetch monthly summary:", summaryResponse.status);
                }
            } catch (error) {
                console.error("Error fetching monthly summary:", error);
            }
            // ------------------------------------

            // ì´ì „ ë‹¬ì˜ ë‚ ì§œ ì±„ìš°ê¸° (ì²«ì§¸ ë‚  ì´ì „ì˜ ë¹ˆ ì¹¸)
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                calendarDaysContainer.appendChild(emptyDay);
            }

            // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œ ì±„ìš°ê¸°
            for (let date = 1; date <= lastDateOfMonth; date++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = date;
                dayElement.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

                // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
                const today = new Date();
                if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayElement.classList.add('today');
                }

                // --- ì¼ê¸° ì¡´ì¬ ì—¬ë¶€ ë° ê¸°ë¶„ ì´ëª¨í‹°ì½˜ í‘œì‹œ ---
                const cellDateKey = dayElement.dataset.date; // YYYY-MM-DD í˜•ì‹
                if (monthlySummary[cellDateKey] && monthlySummary[cellDateKey].has_entry) {
                    const moodEmojiKey = monthlySummary[cellDateKey].mood_emoji_key;
                    if (moodEmojiKey && moodEmojis[moodEmojiKey]) {
                        const emojiSpan = document.createElement('span');
                        emojiSpan.classList.add('calendar-mood-emoji');
                        emojiSpan.textContent = moodEmojis[moodEmojiKey];
                        dayElement.appendChild(document.createElement('br')); // ë‚ ì§œ ì•„ë˜ì— ì´ëª¨í‹°ì½˜ì„ ìœ„í•´ ì¤„ ë°”ê¿ˆ
                        dayElement.appendChild(emojiSpan);
                        dayElement.classList.add('has-diary-entry'); // CSS ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
                    }
                }
                // -----------------------------------------

                dayElement.addEventListener('click', () => {
                    selectDate(dayElement);
                });
                calendarDaysContainer.appendChild(dayElement);
            }

            // `loadAndDisplayDiaryEntries`ëŠ” ì´ì œ `renderCalendar` ì•ˆì—ì„œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.
            // ë”°ë¼ì„œ ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ìº˜ë¦°ë” ë Œë”ë§ í›„ì— ì§ì ‘ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            // loadAndDisplayDiaryEntries(year, month + 1); // ì´ ì¤„ì€ ì´ì œ í•„ìš” ì—†ìŒ
        }

        // ë‚ ì§œ ì„ íƒ ì‹œ ì²˜ë¦¬
        async function selectDate(dayElement) {
            // ì´ì „ì— ì„ íƒëœ ë‚ ì§œì˜ 'selected' í´ë˜ìŠ¤ ì œê±°
            if (currentActiveDateElement) {
                currentActiveDateElement.classList.remove('selected');
            }

            // ìƒˆë¡­ê²Œ ì„ íƒëœ ë‚ ì§œì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            dayElement.classList.add('selected');
            currentActiveDateElement = dayElement; // í˜„ì¬ í™œì„± ë‚ ì§œ ìš”ì†Œ ì—…ë°ì´íŠ¸

            const dateString = dayElement.dataset.date; // "YYYY-MM-DD"
            selectedDate = new Date(dateString); // Date ê°ì²´ë¡œ ì €ì¥

            // ì œëª© ì—…ë°ì´íŠ¸
            const dateParts = dateString.split('-');
            diaryEntryTitle.textContent = `${dateParts[0]}ë…„ ${parseInt(dateParts[1])}ì›” ${parseInt(dateParts[2])}ì¼ ì¼ê¸°`;

            // ì„ íƒëœ ë‚ ì§œì˜ ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
            await loadDiaryEntry(dateString);
        }

        // ì¼ê¸° ë¡œë“œ í•¨ìˆ˜
        async function loadDiaryEntry(dateString) {
            try {
                // ë°±ì—”ë“œ API ê²½ë¡œ ìˆ˜ì •: /api/diary/entries/by_date?date=YYYY-MM-DD
                const response = await fetchWithAuth(`/api/diary/entries/by_date?date=${dateString}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.diary_entry) {
                        diaryContentInput.value = data.diary_entry.content;
                        updateSelectedMoodEmoji(data.diary_entry.mood_emoji_key);
                        currentDiaryEntryId = data.diary_entry._id; // ë¡œë“œëœ ì¼ê¸°ì˜ _id ì €ì¥
                    } else {
                        diaryContentInput.value = ''; // ì¼ê¸° ì—†ìœ¼ë©´ ë‚´ìš© ë¹„ìš°ê¸°
                        updateSelectedMoodEmoji(null); // ë¬´ë“œ ì„ íƒ í•´ì œ
                        currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
                    }
                } else if (response.status === 404) {
                    console.log(`No diary entry found for ${dateString}.`);
                    diaryContentInput.value = ''; // ì¼ê¸° ì—†ìœ¼ë©´ ë‚´ìš© ë¹„ìš°ê¸°
                    updateSelectedMoodEmoji(null); // ë¬´ë“œ ì„ íƒ í•´ì œ
                    currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    diaryContentInput.value = '';
                    updateSelectedMoodEmoji(null);
                    currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
                }
            } catch (error) {
                console.error("Error loading diary entry:", error);
                alert('ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                diaryContentInput.value = '';
                updateSelectedMoodEmoji(null);
                currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
            }
        }

        // ë¬´ë“œ ì´ëª¨í‹°ì½˜ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSelectedMoodEmoji(moodKey) {
            selectedMood = moodKey; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.mood-emoji').forEach(emojiSpan => {
                emojiSpan.classList.remove('selected');
                if (emojiSpan.dataset.mood === moodKey) {
                    emojiSpan.classList.add('selected');
                }
            });
        }

        // ì›”ë³„ ì¼ê¸° ì¡´ì¬ ì—¬ë¶€ ë¡œë“œ ë° í‘œì‹œ (ì´ì œ renderCalendarì— í†µí•©ë¨)
        // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì§ì ‘ í˜¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        async function loadAndDisplayDiaryEntries(year, month) {
            // ì´ í•¨ìˆ˜ëŠ” ì´ì œ renderCalendar ë‚´ì—ì„œ í†µí•©ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.
            // ë”°ë¼ì„œ ì´ í•¨ìˆ˜ ìì²´ëŠ” ë” ì´ìƒ ìº˜ë¦°ë” ë Œë”ë§ í›„ì— ì§ì ‘ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            // ì´ì „ ë²„ì „ì˜ ì½”ë“œë¥¼ ì°¸ê³ í•˜ì—¬ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
        }


        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        prevMonthButton.addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
            diaryContentInput.value = ''; // ì›” ë³€ê²½ ì‹œ ì¼ê¸° ë‚´ìš© ì´ˆê¸°í™”
            diaryEntryTitle.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.';
            updateSelectedMoodEmoji(null); // ë¬´ë“œ ì„ íƒ í•´ì œ
            currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
        });

        nextMonthButton.addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
            diaryContentInput.value = ''; // ì›” ë³€ê²½ ì‹œ ì¼ê¸° ë‚´ìš© ì´ˆê¸°í™”
            diaryEntryTitle.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.';
            updateSelectedMoodEmoji(null); // ë¬´ë“œ ì„ íƒ í•´ì œ
            currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
        });

        diaryEntryForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!selectedDate) {
                alert('ì¼ê¸°ë¥¼ ì €ì¥í•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const content = diaryContentInput.value.trim();
            if (!content) {
                alert('ì¼ê¸° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // 'YYYY-MM-DD' í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const dateForApi = `${year}-${month}-${day}`;

            try {
                const response = await fetchWithAuth('/api/diary/entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: dateForApi,
                        content: content,
                        mood_emoji_key: selectedMood // ì„ íƒëœ ë¬´ë“œ ì´ëª¨í‹°ì½˜ í‚¤ ì „ì†¡
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'ì¼ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    renderCalendar(); // í˜„ì¬ ë‹¬ì˜ ìº˜ë¦°ë”ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì´ëª¨í‹°ì½˜ í‘œì‹œ
                    currentDiaryEntryId = result.diary_entry._id; // ìƒˆë¡œ ì €ì¥ëœ ì¼ê¸°ì˜ _id ì €ì¥
                } else {
                    alert(result.message || 'ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error("Error saving diary entry:", result.message);
                    if (response.status === 401) { // í† í° ë§Œë£Œ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ
                        localStorage.removeItem('jwt_token');
                        showLoginRequiredUI();
                    }
                }
            } catch (error) {
                console.error("Error saving diary entry:", error);
                alert('ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì¼ê¸° ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        deleteDiaryButton.addEventListener('click', async () => {
            if (!selectedDate) {
                alert('ì‚­ì œí•  ì¼ê¸°ì˜ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!currentDiaryEntryId) {
                alert('ì‚­ì œí•  ì¼ê¸° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm('ì •ë§ë¡œ ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const deleteResponse = await fetchWithAuth(`/api/diary/entries/${currentDiaryEntryId}`, {
                    method: 'DELETE'
                });

                const deleteResult = await deleteResponse.json();

                if (deleteResponse.ok) {
                    alert(deleteResult.message || 'ì¼ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    diaryContentInput.value = ''; // ì…ë ¥ í•„ë“œ ë¹„ìš°ê¸°
                    updateSelectedMoodEmoji(null); // ë¬´ë“œ ì„ íƒ í•´ì œ
                    currentDiaryEntryId = null; // _id ì´ˆê¸°í™”
                    renderCalendar(); // ìº˜ë¦°ë” ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì´ëª¨í‹°ì½˜ ì œê±°
                } else {
                    alert(deleteResult.message || "ì¼ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    console.error("Error deleting diary entry:", deleteResult.message);
                    if (deleteResponse.status === 401) {
                        localStorage.removeItem('jwt_token');
                        showLoginRequiredUI();
                    }
                }
            } catch (error) {
                console.error("Error deleting diary entry:", error);
                alert("ì¼ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // ë¬´ë“œ ì´ëª¨í‹°ì½˜ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        moodEmojisContainer.addEventListener('click', (event) => {
            const target = event.target.closest('.mood-emoji');
            if (target) {
                // ëª¨ë“  ì´ëª¨í‹°ì½˜ì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.mood-emoji').forEach(emojiSpan => {
                    emojiSpan.classList.remove('selected');
                });
                // í´ë¦­ëœ ì´ëª¨í‹°ì½˜ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
                target.classList.add('selected');
                selectedMood = target.dataset.mood; // ì„ íƒëœ ë¬´ë“œ í‚¤ ì €ì¥
            }
        });

        // DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•˜ì—¬ DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatusAndUpdateUI();
        });
    </script>
{% endblock %}
