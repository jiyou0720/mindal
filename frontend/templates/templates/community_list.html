<!--frontend/templates/community_list.html-->

{% extends "base.html" %}

{% block title %}게시판 - 영마인드링크{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_list.css') }}">
{% endblock %}

{% block content %}
    <div class="page-content-wrapper">
        <h1 class="page-title">게시판</h1>
        <p class="page-description">다양한 주제의 게시글들을 확인하고, 자유롭게 소통해보세요!</p>

        <div class="community-header">
            <div class="category-tabs">
                <button class="category-tab active" data-category="all">전체</button>
                <button class="category-tab" data-category="photo">사진</button>
                <button class="category-tab" data-category="music">음악</button>
                <button class="category-tab" data-category="secret">비밀</button>
                <button class="category-tab" data-category="daily">일상</button>
                <button class="category-tab" data-category="emotion">감정</button>
            </div>
            <a href="{{ url_for('create_post') }}" class="button primary create-post-button">
                <i class="fas fa-pencil-alt"></i> 글쓰기
            </a>
        </div>

        <div class="post-list-container">
            {# 게시글 목록이 동적으로 로드될 영역 #}
            <p class="loading-message">게시글을 불러오는 중...</p>
            <div id="postList" class="post-cards-grid">
                {# 여기에 게시글 카드들이 동적으로 삽입됩니다. #}
            </div>
            <p id="noPostsMessage" class="no-posts-message" style="display: none;">
                해당 카테고리의 게시글이 없습니다. 첫 글을 작성해보세요!
            </p>
        </div>

        <div class="pagination-container">
            <button id="prevPage" class="pagination-button" disabled><i class="fas fa-chevron-left"></i></button>
            <span id="currentPageDisplay" class="page-number">1</span>
            <button id="nextPage" class="pagination-button"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postListContainer = document.getElementById('postList');
            const categoryTabs = document.querySelector('.category-tabs');
            const prevPageButton = document.getElementById('prevPage');
            const nextPageButton = document.getElementById('nextPage');
            const currentPageDisplay = document.getElementById('currentPageDisplay');
            const loadingMessage = document.querySelector('.loading-message');
            const noPostsMessage = document.getElementById('noPostsMessage');

            let currentPage = 1;
            let currentCategory = 'all';
            const postsPerPage = 10; // 한 페이지에 표시할 게시글 수

            // 게시글 목록을 가져오는 함수
            async function fetchPosts(category = 'all', page = 1) {
                loadingMessage.style.display = 'block'; // 로딩 메시지 표시
                noPostsMessage.style.display = 'none'; // '게시글 없음' 메시지 숨김
                postListContainer.innerHTML = ''; // 기존 목록 비우기

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    // 로그인되지 않은 경우 처리 (예: 로그인 페이지로 리다이렉트 또는 메시지 표시)
                    loadingMessage.textContent = '로그인이 필요합니다.';
                    alert('게시판을 이용하려면 로그인해주세요.');
                    window.location.href = "{{ url_for('login') }}"; // 로그인 페이지로 리다이렉트
                    return;
                }

                let url = `/api/community/posts?page=${page}&limit=${postsPerPage}`;
                if (category && category !== 'all') {
                    url += `&category=${category}`;
                }

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    loadingMessage.style.display = 'none'; // 로딩 메시지 숨김

                    if (response.ok) {
                        const result = await response.json();
                        const posts = result.posts;
                        const total_pages = result.total_pages;

                        if (posts.length > 0) {
                            posts.forEach(post => {
                                const postCard = document.createElement('div');
                                postCard.classList.add('post-card');
                                postCard.dataset.postId = post.id; // 게시글 ID 저장
                                
                                // MongoDB에서 가져온 content의 첫 몇 줄만 표시 (더미 데이터에서는 'content' 필드 가정)
                                // 실제 MongoDB에서 post_content를 가져와야 합니다. 현재는 MariaDB의 title과 author만 사용.
                                // 백엔드에서 post.content 또는 post.preview_content를 포함하여 전달해야 함
                                const previewContent = post.preview_content ? post.preview_content.substring(0, 100) + '...' : '내용 미리보기를 불러올 수 없습니다.';

                                postCard.innerHTML = `
                                    <h3 class="post-title">${post.title}</h3>
                                    <p class="post-meta">
                                        <span class="post-author">${post.author_username}</span>
                                        <span class="post-date">${new Date(post.created_at).toLocaleDateString()}</span>
                                        <span class="post-category">#${post.category}</span>
                                    </p>
                                    <p class="post-preview">${previewContent}</p>
                                `;
                                postListContainer.appendChild(postCard);

                                // 게시글 카드 클릭 이벤트 리스너 추가
                                postCard.addEventListener('click', () => {
                                    window.location.href = `/community/posts/${post.id}`; // 상세 페이지로 이동
                                });
                            });
                        } else {
                            noPostsMessage.style.display = 'block'; // 게시글 없음 메시지 표시
                        }

                        // 페이지네이션 버튼 상태 업데이트
                        currentPageDisplay.textContent = page;
                        prevPageButton.disabled = page === 1;
                        nextPageButton.disabled = page >= total_pages;

                    } else if (response.status === 401) {
                        localStorage.removeItem('jwt_token');
                        alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                        window.location.href = "{{ url_for('login') }}";
                    } else {
                        const errorResult = await response.json();
                        postListContainer.innerHTML = `<p class="error-message">게시글을 불러오는데 실패했습니다: ${errorResult.message || '알 수 없는 오류'}</p>`;
                    }
                } catch (error) {
                    console.error('게시글 로드 중 오류 발생:', error);
                    loadingMessage.style.display = 'none';
                    postListContainer.innerHTML = `<p class="error-message">네트워크 오류가 발생했습니다. 다시 시도해주세요.</p>`;
                }
            }

            // 카테고리 탭 클릭 이벤트
            categoryTabs.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('category-tab')) {
                    // 모든 탭의 active 클래스 제거
                    document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                    // 클릭된 탭에 active 클래스 추가
                    target.classList.add('active');

                    currentCategory = target.dataset.category;
                    currentPage = 1; // 카테고리 변경 시 페이지를 1로 초기화
                    fetchPosts(currentCategory, currentPage);
                }
            });

            // 페이지네이션 버튼 이벤트
            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchPosts(currentCategory, currentPage);
                }
            });

            nextPageButton.addEventListener('click', () => {
                currentPage++;
                fetchPosts(currentCategory, currentPage);
            });

            // 초기 게시글 로드
            fetchPosts(currentCategory, currentPage);
        });
    </script>
{% endblock %}