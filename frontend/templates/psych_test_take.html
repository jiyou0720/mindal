<!-- frontend/templates/psych_test_take.html -->
{% extends "base.html" %}

{% block title %}심리 테스트 진행 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/psych_test.css') }}"> {# 심리 테스트 전용 CSS #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="psych-test-container">
        <h1 id="testTitle">심리 테스트</h1>
        <p class="page-description" id="testDescription">테스트를 진행해주세요.</p>

        <div class="test-questions-section">
            <form id="testForm">
                <div id="questionsContainer">
                    <!-- 질문들이 여기에 동적으로 로드됩니다 -->
                    <p class="loading-message">질문을 불러오는 중...</p>
                </div>
                <div class="button-group">
                    <button type="submit" class="button primary" id="submitTestButton" disabled>결과 보기</button>
                    <button type="button" class="button secondary" id="cancelTestButton">취소</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const testId = "{{ test_id }}"; // Flask 템플릿에서 test_id를 받음
        const testTitleElement = document.getElementById('testTitle');
        const testDescriptionElement = document.getElementById('testDescription');
        const questionsContainer = document.getElementById('questionsContainer');
        const testForm = document.getElementById('testForm');
        const submitTestButton = document.getElementById('submitTestButton');
        const cancelTestButton = document.getElementById('cancelTestButton');

        let questionsData = []; // 불러온 질문 데이터를 저장

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('심리 테스트를 이용하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return;
            }
            if (testId) {
                fetchTestQuestions(testId);
            } else {
                questionsContainer.innerHTML = '<p class="error-message">테스트 ID가 없습니다.</p>';
            }
        });

        async function fetchTestQuestions(id) {
            questionsContainer.innerHTML = '<p class="loading-message">질문을 불러오는 중...</p>';
            submitTestButton.disabled = true;

            try {
                const response = await fetchWithAuth(`/api/psych_test/tests/${id}/questions`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '테스트 질문을 불러오는 데 실패했습니다.');
                    questionsContainer.innerHTML = '<p class="error-message">질문을 불러오지 못했습니다.</p>';
                    return;
                }
                const data = await response.json();
                testTitleElement.textContent = data.test_title || '심리 테스트';
                questionsData = data.questions;
                renderQuestions(questionsData);
                submitTestButton.disabled = false; // 질문 로드 후 버튼 활성화
            } catch (error) {
                console.error('테스트 질문 로드 중 오류 발생:', error);
                await showAlert('테스트 질문을 불러오는 중 네트워크 오류가 발생했습니다.');
                questionsContainer.innerHTML = '<p class="error-message">네트워크 오류로 질문을 불러오지 못했습니다.</p>';
            }
        }

        function renderQuestions(questions) {
            questionsContainer.innerHTML = '';
            if (questions.length === 0) {
                questionsContainer.innerHTML = '<p class="no-data-message">표시할 질문이 없습니다.</p>';
                return;
            }

            questions.sort((a, b) => a.order - b.order); // 질문 순서대로 정렬

            questions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.innerHTML = `
                    <p class="question-text">${q.order}. ${q.question_text}</p>
                    <div class="options-group">
                        ${q.options.map((option, optIndex) => `
                            <label class="option-label">
                                <input type="radio" name="question_${q._id}" value="${optIndex}" data-question-id="${q._id}" required>
                                <span>${option.text}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }

        // 테스트 결과 제출
        testForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const answers = [];
            let allAnswered = true;
            questionsData.forEach(q => {
                const selectedOption = document.querySelector(`input[name="question_${q._id}"]:checked`);
                if (selectedOption) {
                    answers.push({
                        question_id: q._id,
                        selected_option_index: parseInt(selectedOption.value)
                    });
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                await showAlert('모든 질문에 답변해주세요.');
                return;
            }

            const confirmed = await showConfirm('테스트를 완료하고 결과를 보시겠습니까?');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/psych_test/tests/${testId}/submit_result`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers: answers })
                });
                const result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '테스트 결과가 성공적으로 제출되었습니다.');
                    window.location.href = `/psych_test/result/${result.result_id}`; // 결과 페이지로 이동
                } else {
                    await showAlert(result.message || '결과 제출에 실패했습니다.');
                }
            } catch (error) {
                console.error('테스트 결과 제출 중 오류 발생:', error);
                await showAlert('테스트 결과 제출 중 네트워크 오류가 발생했습니다.');
            }
        });

        // 취소 버튼
        cancelTestButton.addEventListener('click', () => {
            window.location.href = '/psych_test'; // 테스트 목록으로 돌아가기
        });
    </script>
{% endblock %}
