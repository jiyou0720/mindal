<!-- frontend/templates/admin_inquiry_management.html -->
{% extends "base.html" %}

{% block title %}문의사항 관리 - Mindbridge{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inquiry_management.css') }}"> {# 문의사항 관리 전용 CSS #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="admin-dashboard-container">
        <h1>문의사항 관리</h1>
        <p>사용자들이 제출한 문의사항을 조회하고 답변하거나 상태를 변경할 수 있습니다.</p>
        <p>현재 로그인된 사용자 역할: <span id="currentUserRolesDisplay"></span></p>

        <div class="admin-section">
            <h2>문의사항 목록</h2>
            <div class="search-bar">
                <input type="text" id="inquirySearchInput" placeholder="제목, 사용자 이름, 이메일로 검색...">
                <select id="inquiryStatusFilter">
                    <option value="">모든 상태</option>
                    <option value="pending">대기 중</option>
                    <option value="replied">답변 완료</option>
                    <option value="closed">종료됨</option>
                </select>
                <button id="searchInquiryButton" class="button primary">검색</button>
            </div>
            <div class="data-table-container">
                <table class="data-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>제목</th>
                            <th>작성자</th>
                            <th>이메일</th>
                            <th>상태</th>
                            <th>작성일</th>
                            <th>답변일</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="inquiryTableBody">
                        <tr><td colspan="8" class="loading-row">문의사항을 불러오는 중...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="noInquiriesMessage" class="no-data-message hidden">문의사항이 없습니다.</p>
        </div>
    </div>

    <!-- 문의사항 상세 및 답변 모달 -->
    <div id="inquiryDetailModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle">문의사항 상세</h3>
            <div class="detail-content">
                <p><strong>문의 ID:</strong> <span id="detailInquiryId"></span></p>
                <p><strong>제목:</strong> <span id="detailInquiryTitle"></span></p>
                <p><strong>작성자:</strong> <span id="detailInquiryAuthor"></span></p>
                <p><strong>이메일:</strong> <span id="detailInquiryEmail"></span></p>
                <p><strong>상태:</strong> <span id="detailInquiryStatus"></span></p>
                <p><strong>작성일:</strong> <span id="detailInquiryCreatedAt"></span></p>
                <p><strong>내용:</strong></p>
                <div id="detailInquiryContent" class="content-area"></div>
                
                <h4 style="margin-top: 20px;">답변</h4>
                <div id="replyArea" class="reply-area">
                    <textarea id="replyContent" rows="5" placeholder="답변 내용을 입력하세요."></textarea>
                    <p class="reply-info">답변자: <span id="repliedBy"></span> (답변일: <span id="repliedAt"></span>)</p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="button primary" id="submitReplyButton">답변 제출</button>
                <select id="changeStatusSelect" class="button secondary">
                    <option value="">상태 변경</option>
                    <option value="pending">대기 중</option>
                    <option value="replied">답변 완료</option>
                    <option value="closed">종료됨</option>
                </select>
                <button class="button danger" id="deleteInquiryButton">삭제</button>
                <button class="button secondary" id="closeDetailModalButton">닫기</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const inquiryTableBody = document.getElementById('inquiryTableBody');
        const inquirySearchInput = document.getElementById('inquirySearchInput');
        const inquiryStatusFilter = document.getElementById('inquiryStatusFilter');
        const searchInquiryButton = document.getElementById('searchInquiryButton');
        const noInquiriesMessage = document.getElementById('noInquiriesMessage');
        const currentUserRolesDisplay = document.getElementById('currentUserRolesDisplay');

        const inquiryDetailModal = document.getElementById('inquiryDetailModal');
        const closeModalButton = inquiryDetailModal.querySelector('.close-button');
        const detailInquiryId = document.getElementById('detailInquiryId');
        const detailInquiryTitle = document.getElementById('detailInquiryTitle');
        const detailInquiryAuthor = document.getElementById('detailInquiryAuthor');
        const detailInquiryEmail = document.getElementById('detailInquiryEmail');
        const detailInquiryStatus = document.getElementById('detailInquiryStatus');
        const detailInquiryCreatedAt = document.getElementById('detailInquiryCreatedAt');
        const detailInquiryContent = document.getElementById('detailInquiryContent');
        const replyContentInput = document.getElementById('replyContent');
        const repliedBySpan = document.getElementById('repliedBy');
        const repliedAtSpan = document.getElementById('repliedAt');
        const submitReplyButton = document.getElementById('submitReplyButton');
        const changeStatusSelect = document.getElementById('changeStatusSelect');
        const deleteInquiryButton = document.getElementById('deleteInquiryButton');
        const closeDetailModalButton = document.getElementById('closeDetailModalButton');

        let allInquiries = []; // 모든 문의사항 데이터를 저장할 배열
        let currentViewingInquiryId = null; // 현재 상세 모달에서 보고 있는 문의사항 ID

        // 관리자/운영자 접근 권한 확인 함수
        async function checkAdminOrOperatorAccess() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                await showAlert('문의사항 관리 페이지에 접근하려면 로그인이 필요합니다.');
                window.location.href = loginUrl;
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/auth/me', { method: 'GET' });
                if (!response || !response.ok) {
                    await showAlert('사용자 역할 정보를 불러오는 데 실패했습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('access_token');
                    window.location.href = loginUrl;
                    return false;
                }

                const data = await response.json();
                const userRoles = data.user.roles || [];

                if (!userRoles.includes('관리자') && !userRoles.includes('운영자')) {
                    await showAlert('관리자 또는 운영자만 접근할 수 있는 페이지입니다.');
                    window.location.href = homeUrl;
                    return false;
                }

                currentUserRolesDisplay.textContent = userRoles.join(', ');
                return true;
            } catch (error) {
                console.error('접근 권한 확인 중 오류 발생:', error);
                await showAlert('접근 권한 확인 중 오류가 발생했습니다. 다시 시도해주세요.');
                window.location.href = homeUrl;
                return false;
            }
        }

        // 모든 문의사항 불러오기
        async function fetchAllInquiries() {
            inquiryTableBody.innerHTML = '<tr><td colspan="8" class="loading-row">문의사항을 불러오는 중...</td></tr>';
            noInquiriesMessage.classList.add('hidden');

            try {
                const response = await fetchWithAuth('/api/admin/inquiries');
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '문의사항 목록을 불러오는 데 실패했습니다.');
                    inquiryTableBody.innerHTML = '<tr><td colspan="8" class="error-row">문의사항을 불러오지 못했습니다.</td></tr>';
                    return;
                }
                const data = await response.json();
                allInquiries = data.inquiries || [];
                renderInquiryTable(allInquiries);
            } catch (error) {
                console.error('문의사항 목록 로드 중 오류 발생:', error);
                await showAlert('문의사항 목록을 불러오는 중 네트워크 오류가 발생했습니다.');
                inquiryTableBody.innerHTML = '<tr><td colspan="8" class="error-row">네트워크 오류로 정보를 불러오지 못했습니다.</td></tr>';
            }
        }

        // 문의사항 테이블 렌더링
        function renderInquiryTable(inquiriesToRender) {
            inquiryTableBody.innerHTML = '';
            if (inquiriesToRender.length === 0) {
                noInquiriesMessage.classList.remove('hidden');
                return;
            }
            noInquiriesMessage.classList.add('hidden');

            inquiriesToRender.forEach(inquiry => {
                const row = inquiryTableBody.insertRow();
                const displayCreatedAt = inquiry.created_at ? new Date(inquiry.created_at).toLocaleDateString() : '-';
                const displayRepliedAt = inquiry.replied_at ? new Date(inquiry.replied_at).toLocaleDateString() : '-';
                
                let statusText = '';
                let statusClass = '';
                switch(inquiry.status) {
                    case 'pending':
                        statusText = '대기 중';
                        statusClass = 'status-pending';
                        break;
                    case 'replied':
                        statusText = '답변 완료';
                        statusClass = 'status-replied';
                        break;
                    case 'closed':
                        statusText = '종료됨';
                        statusClass = 'status-closed';
                        break;
                    default:
                        statusText = '알 수 없음';
                        statusClass = '';
                }

                row.innerHTML = `
                    <td>${inquiry._id.substring(0, 8)}...</td>
                    <td>${inquiry.title}</td>
                    <td>${inquiry.username || '-'}</td>
                    <td>${inquiry.email || '-'}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${displayCreatedAt}</td>
                    <td>${displayRepliedAt}</td>
                    <td class="action-cell">
                        <button class="button small secondary view-inquiry-button" data-inquiry-id="${inquiry._id}">상세/처리</button>
                    </td>
                `;
            });

            document.querySelectorAll('.view-inquiry-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const inquiryId = e.target.dataset.inquiryId;
                    openInquiryDetailModal(inquiryId);
                });
            });
        }

        // 문의사항 상세 모달 열기
        async function openInquiryDetailModal(inquiryId) {
            currentViewingInquiryId = inquiryId;
            try {
                const response = await fetchWithAuth(`/api/admin/inquiries/${inquiryId}`);
                if (!response || !response.ok) {
                    const errorData = response ? await response.json() : {};
                    await showAlert(errorData.message || '문의사항 상세 정보를 불러오는 데 실패했습니다.');
                    return;
                }
                const inquiry = await response.json();

                detailInquiryId.textContent = inquiry._id;
                detailInquiryTitle.textContent = inquiry.title;
                detailInquiryAuthor.textContent = inquiry.username || '-';
                detailInquiryEmail.textContent = inquiry.email || '-';
                detailInquiryStatus.textContent = inquiry.status === 'pending' ? '대기 중' : (inquiry.status === 'replied' ? '답변 완료' : '종료됨');
                detailInquiryCreatedAt.textContent = inquiry.created_at ? new Date(inquiry.created_at).toLocaleString() : '-';
                detailInquiryContent.innerHTML = inquiry.content;

                replyContentInput.value = inquiry.reply_content || '';
                repliedBySpan.textContent = inquiry.replied_by_nickname || inquiry.replied_by_username || '없음';
                repliedAtSpan.textContent = inquiry.replied_at ? new Date(inquiry.replied_at).toLocaleString() : '없음';

                // 상태 변경 드롭다운 초기화
                changeStatusSelect.value = inquiry.status;

                // 버튼 이벤트 리스너 재할당
                submitReplyButton.onclick = () => submitReply(inquiryId);
                deleteInquiryButton.onclick = () => deleteInquiry(inquiryId);
                
                inquiryDetailModal.classList.add('visible');
            }
            catch (error) {
                console.error('문의사항 상세 정보 로드 중 오류 발생:', error);
                await showAlert('문의사항 상세 정보를 불러오는 중 네트워크 오류가 발생했습니다.');
            }
        }

        // 문의사항 상세 모달 닫기
        closeModalButton.addEventListener('click', () => {
            inquiryDetailModal.classList.remove('visible');
            currentViewingInquiryId = null;
        });
        closeDetailModalButton.addEventListener('click', () => {
            inquiryDetailModal.classList.remove('visible');
            currentViewingInquiryId = null;
        });

        // 답변 제출
        async function submitReply(inquiryId) {
            const replyContent = replyContentInput.value.trim();
            if (!replyContent) {
                await showAlert('답변 내용을 입력해주세요.');
                return;
            }

            const confirmed = await showConfirm('답변을 제출하시겠습니까?');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/admin/inquiries/${inquiryId}/reply`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reply_content: replyContent })
                });
                const result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '답변이 성공적으로 제출되었습니다.');
                    inquiryDetailModal.classList.remove('visible');
                    fetchAllInquiries(); // 목록 새로고침
                } else {
                    await showAlert(result.message || '답변 제출에 실패했습니다.');
                }
            } catch (error) {
                console.error('답변 제출 중 오류 발생:', error);
                await showAlert('답변 제출 중 네트워크 오류가 발생했습니다.');
            }
        }

        // 상태 변경
        changeStatusSelect.addEventListener('change', async (e) => {
            const newStatus = e.target.value;
            if (!newStatus || !currentViewingInquiryId) return;

            const confirmed = await showConfirm(`문의사항 상태를 '${newStatus}'(으)로 변경하시겠습니까?`);
            if (!confirmed) {
                e.target.value = allInquiries.find(i => i._id === currentViewingInquiryId)?.status || ''; // 변경 취소
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/admin/inquiries/${currentViewingInquiryId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '상태가 성공적으로 변경되었습니다.');
                    inquiryDetailModal.classList.remove('visible');
                    fetchAllInquiries(); // 목록 새로고침
                } else {
                    await showAlert(result.message || '상태 변경에 실패했습니다.');
                    e.target.value = allInquiries.find(i => i._id === currentViewingInquiryId)?.status || ''; // 변경 취소
                }
            } catch (error) {
                console.error('상태 변경 중 오류 발생:', error);
                await showAlert('상태 변경 중 네트워크 오류가 발생했습니다.');
                e.target.value = allInquiries.find(i => i._id === currentViewingInquiryId)?.status || ''; // 변경 취소
            }
        });

        // 문의사항 삭제
        async function deleteInquiry(inquiryId) {
            const confirmed = await showConfirm('정말로 이 문의사항을 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetchWithAuth(`/api/admin/inquiries/${inquiryId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (response.ok) {
                    await showAlert(result.message || '문의사항이 성공적으로 삭제되었습니다.');
                    inquiryDetailModal.classList.remove('visible');
                    fetchAllInquiries(); // 목록 새로고침
                } else {
                    await showAlert(result.message || '문의사항 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('문의사항 삭제 중 오류 발생:', error);
                await showAlert('문의사항 삭제 중 네트워크 오류가 발생했습니다.');
            }
        }

        // 검색 및 필터링 기능
        searchInquiryButton.addEventListener('click', () => {
            const searchTerm = inquirySearchInput.value.toLowerCase().trim();
            const statusFilter = inquiryStatusFilter.value;

            const filteredInquiries = allInquiries.filter(inquiry => {
                const titleMatch = inquiry.title.toLowerCase().includes(searchTerm);
                const usernameMatch = (inquiry.username && inquiry.username.toLowerCase().includes(searchTerm));
                const emailMatch = (inquiry.email && inquiry.email.toLowerCase().includes(searchTerm));
                
                const statusMatch = statusFilter === '' || inquiry.status === statusFilter;

                return (titleMatch || usernameMatch || emailMatch) && statusMatch;
            });
            renderInquiryTable(filteredInquiries);
        });

        inquirySearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchInquiryButton.click();
            }
        });

        // 초기 로드 시 접근 권한 확인 후 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            const hasAccess = await checkAdminOrOperatorAccess();
            if (hasAccess) {
                fetchAllInquiries();
            }
        });
    </script>
{% endblock %}
