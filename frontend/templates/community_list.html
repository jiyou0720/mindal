<!--frontend/templates/community_list.html-->
{% extends "base.html" %}

{% block title %}게시판 - 영마인드링크{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/community_list.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="community-container">
        <div class="community-header">
            <div>
                <h1 class="community-title">게시판</h1>
                <p class="community-subtitle">다양한 사람들과 이야기하고 소통해보세요!</p>
            </div>
            {# 새 게시글 작성 버튼: '일반 사용자', '에디터', '운영자', '관리자'만 표시 #}
            {# user_roles는 base.html에서 localStorage에 저장되므로 여기서 직접 참조하지 않고 JS에서 로드 #}
            <a href="{{ url_for('community_create') }}" class="button primary create-post-button" id="createPostButton" style="display: none;">
                <i class="fas fa-plus"></i> 새 게시글 작성
            </a>
        </div>

        <div class="community-filter-sort">
            <!-- 필터 및 정렬 옵션 (필요시 추가) -->
            <select id="categoryFilter" class="filter-select">
                <option value="">모든 카테고리</option>
                <option value="photo">사진</option>
                <option value="music">음악</option>
                <option value="secret">비밀</option>
                <option value="daily">일상</option>
                <option value="emotion">감정</option>
            </select>
            <!-- <button class="button secondary">정렬</button> -->
        </div>

        <div class="post-cards-grid" id="postList">
            <!-- 게시글 목록이 여기에 동적으로 로드됩니다. -->
            <p id="loadingMessage" class="loading-message">게시글을 불러오는 중...</p>
            <p id="noPostsMessage" class="no-posts-message" style="display: none;">아직 작성된 게시글이 없습니다. 첫 게시글을 작성해보세요!</p>
        </div>

        <div class="pagination" id="pagination">
            <!-- 페이지네이션 버튼이 여기에 동적으로 로드됩니다. -->
        </div>
    </div>

    <script>
        const communityCreateUrl = "{{ url_for('community_create') }}";
        const communityDetailUrlBase = "/community/posts/"; // 게시글 상세 페이지 URL 베이스
        // const loginUrl = "{{ url_for('login') }}"; // base.html에서 전역으로 선언되므로 제거됨

        document.addEventListener('DOMContentLoaded', async function() {
            const postList = document.getElementById('postList');
            const loadingMessage = document.getElementById('loadingMessage');
            const noPostsMessage = document.getElementById('noPostsMessage');
            const paginationContainer = document.getElementById('pagination');
            const categoryFilter = document.getElementById('categoryFilter');
            const createPostButton = document.getElementById('createPostButton'); // 새 게시글 작성 버튼

            let currentPage = 1;
            const postsPerPage = 10; // 한 페이지당 게시글 수
            let currentUserId = null; // 현재 로그인된 사용자 ID
            let currentUserRoles = []; // 현재 로그인된 사용자 역할 리스트

            // 사용자 역할에 따라 '새 게시글 작성' 버튼 표시 여부 결정
            function updateCreatePostButtonVisibility() {
                const token = localStorage.getItem('jwt_token');
                const userRolesString = localStorage.getItem('user_roles');
                
                if (token && userRolesString) {
                    try {
                        const roles = JSON.parse(userRolesString);
                        const allowedRolesForCreate = ['일반 사용자', '에디터', '운영자', '관리자'];
                        const hasPermission = roles.some(role => allowedRolesForCreate.includes(role));
                        if (hasPermission) {
                            createPostButton.style.display = 'flex'; // flex로 설정하여 아이콘과 텍스트 정렬
                        } else {
                            createPostButton.style.display = 'none';
                        }
                    } catch (e) {
                        console.error("Error parsing user roles from localStorage:", e);
                        createPostButton.style.display = 'none';
                    }
                } else {
                    createPostButton.style.display = 'none';
                }
            }


            const fetchPosts = async (page = 1, category = '') => {
                loadingMessage.style.display = 'block';
                noPostsMessage.style.display = 'none';
                postList.innerHTML = ''; // 기존 목록 초기화

                try {
                    let url = `/api/community/posts?page=${page}&limit=${postsPerPage}`;
                    if (category) {
                        url += `&category=${category}`;
                    }

                    // fetchWithAuth 함수는 base.html에 전역으로 정의되어 있으므로 직접 사용
                    const response = await fetchWithAuth(url, { // <--- fetchWithAuth 사용 확인
                        method: 'GET'
                    });
                    const result = await response.json();

                    if (response.ok) {
                        const posts = result.posts;
                        currentUserId = result.current_user_id; // 백엔드에서 받은 사용자 ID 업데이트
                        currentUserRoles = result.current_user_roles; // 백엔드에서 받은 사용자 역할 업데이트

                        if (posts.length === 0) {
                            noPostsMessage.style.display = 'block';
                        } else {
                            posts.forEach(post => {
                                const postElement = document.createElement('div');
                                postElement.classList.add('post-card');
                                // 카드 클릭 시 상세 페이지로 이동하도록 data-post-id 속성 추가
                                postElement.dataset.postId = post.id; 
                                postElement.innerHTML = `
                                    <div class="post-item-header">
                                        <span class="post-category">#${post.category}</span>
                                        <h3 class="post-title">${post.title}</h3>
                                    </div>
                                    <p class="post-preview">${post.content_preview}</p>
                                    <div class="post-item-footer">
                                        <span class="post-author">
                                            <i class="fas fa-user-circle"></i> ${post.display_author_name}
                                        </span>
                                        <span class="post-meta-info">
                                            <i class="fas fa-eye"></i> ${post.views}
                                            <i class="fas fa-comment"></i> ${post.comment_count}
                                            <i class="fas fa-clock"></i> ${new Date(post.created_at).toLocaleDateString('ko-KR')}
                                        </span>
                                    </div>
                                `;
                                postList.appendChild(postElement);

                                // 게시글 카드 전체에 클릭 이벤트 리스너 추가
                                postElement.addEventListener('click', async () => { // async 추가
                                    // 로그인되어 있지 않으면 로그인 페이지로 리다이렉트
                                    if (!localStorage.getItem('jwt_token')) {
                                        await showAlert('게시글 상세보기를 위해 로그인이 필요합니다.'); // alert 대신 showAlert
                                        window.location.href = loginUrl; // base.html의 전역 loginUrl 사용
                                    } else {
                                        window.location.href = `${communityDetailUrlBase}${post.id}`;
                                    }
                                });
                            });
                        }
                        renderPagination(result.total_posts, page, postsPerPage);

                    } else {
                        // fetchWithAuth에서 401 처리를 하므로, 여기서는 다른 종류의 오류만 처리
                        await showAlert(result.message || '게시글 로드 중 오류 발생'); // alert 대신 showAlert
                    }
                } catch (error) {
                    console.error('게시글 로드 중 오류 발생:', error);
                    await showAlert('게시글을 불러오는 중 네트워크 오류가 발생했습니다.'); // alert 대신 showAlert
                } finally {
                    loadingMessage.style.display = 'none';
                }
            };

            const renderPagination = (totalPosts, currentPage, postsPerPage) => {
                paginationContainer.innerHTML = '';
                const totalPages = Math.ceil(totalPosts / postsPerPage);

                if (totalPages <= 1) {
                    return;
                }

                const createPageButton = (page, text, isActive = false) => {
                    const button = document.createElement('button');
                    button.textContent = text;
                    button.classList.add('page-button');
                    if (isActive) {
                        button.classList.add('active');
                    }
                    button.addEventListener('click', () => {
                        currentPage = page;
                        fetchPosts(currentPage, categoryFilter.value);
                    });
                    return button;
                };

                // 이전 페이지 버튼
                if (currentPage > 1) {
                    paginationContainer.appendChild(createPageButton(currentPage - 1, '이전'));
                }

                // 페이지 번호 버튼 
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);

                if (startPage > 1) {
                    paginationContainer.appendChild(createPageButton(1, '1'));
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        paginationContainer.appendChild(ellipsis);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    paginationContainer.appendChild(createPageButton(i, i, i === currentPage));
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        paginationContainer.appendChild(ellipsis);
                    }
                    paginationContainer.appendChild(createPageButton(totalPages, totalPages));
                }

                // 다음 페이지 버튼
                if (currentPage < totalPages) {
                    paginationContainer.appendChild(createPageButton(currentPage + 1, '다음'));
                }
            };

            // 초기 로드
            fetchPosts(currentPage);
            updateCreatePostButtonVisibility(); // 페이지 로드 시 버튼 가시성 업데이트

            // 카테고리 필터 변경 이벤트
            categoryFilter.addEventListener('change', () => {
                currentPage = 1; // 필터 변경 시 첫 페이지로 리셋
                fetchPosts(currentPage, categoryFilter.value);
            });
        });
    </script>
{% endblock %}
