{% extends "base.html" %}

{% block title %}홈 - Mind AI{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
    <div class="page-content-wrapper">
        <h1 class="page-title">안녕하세요, <span id="dashboardUserNickname">방문자</span>님!</h1>
        <p class="page-description">마인드 AI에서 당신의 감정 변화를 기록하고, AI와 대화하며, 다양한 정보를 얻어보세요.</p>

        {# NEW: 공지사항 섹션 #}
        <section class="dashboard-section notice-section">
            <h2 class="section-heading">공지사항</h2>
            <div id="publicNoticesList" class="public-notices-list">
                <p class="loading-message">공지사항을 불러오는 중...</p>
                {# 공지사항 목록이 여기에 동적으로 로드됩니다 #}
            </div>
            <p id="noPublicNoticesMessage" class="no-data-message" style="display: none;">등록된 공지사항이 없습니다.</p>
        </section>

        <section class="dashboard-section">
            <h2 class="section-heading">대시보드 개요</h2>
            <div class="kpi-cards-grid">
                <div class="kpi-card">
                    <i class="fas fa-comments kpi-icon"></i>
                    <div class="kpi-value" id="aiChatCount">0</div>
                    <div class="kpi-label">AI 채팅 기록</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-book-open kpi-icon"></i>
                    <div class="kpi-value" id="diaryEntryCount">0</div>
                    <div class="kpi-label">작성된 일기</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-users kpi-icon"></i>
                    <div class="kpi-value" id="communityPostCount">0</div>
                    <div class="kpi-label">총 사용자</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-heart kpi-icon"></i>
                    <div class="kpi-value" id="mostFrequentMood">분석 중</div>
                    <div class="kpi-label">나의 최근 감정</div>
                </div>
            </div>
            <p class="kpi-info-message">* 대시보드 정보는 로그인 시에만 표시됩니다.</p>
        </section>

        <section class="dashboard-section cta-section">
            <h2 class="section-heading">무엇을 시작해볼까요?</h2>
            <div class="cta-grid">
                <a href="{{ url_for('ai_chat_page') }}" class="cta-card">
                    <i class="fas fa-robot cta-icon"></i>
                    <h3 class="cta-title">AI와 대화하기</h3>
                    <p class="cta-description">AI와 자유롭게 대화하며 고민을 나누세요.</p>
                </a>
                <a href="{{ url_for('diary_page') }}" class="cta-card">
                    <i class="fas fa-book-medical cta-icon"></i>
                    <h3 class="cta-title">오늘 일기 작성</h3>
                    <p class="cta-description">오늘의 감정과 생각을 기록해보세요.</p>
                </a>
                <!-- <a href="{{ url_for('my_changes_page') }}" class="cta-card">
                    <i class="fas fa-chart-line cta-icon"></i>
                    <h3 class="cta-title">나의 변화 확인</h3>
                    <p class="cta-description">나의 심리 변화 추이를 시각적으로 확인합니다.</p>
                </a> --> 
                <!-- 아직 개발 미완 -->
                <a href="{{ url_for('community_list') }}" class="cta-card">
                    <i class="fas fa-users cta-icon"></i>
                    <h3 class="cta-title">커뮤니티 참여</h3>
                    <p class="cta-description">다른 사람들과 소통하고 경험을 공유해보세요.</p>
                </a>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('access_token');
            const userNickname = localStorage.getItem('nickname');

            if (userNickname) {
                document.getElementById('dashboardUserNickname').textContent = userNickname;
            }

            // 대시보드 통계 로드
            if (token) {
                try {
                    const response = await fetchWithAuth('/api/dashboard/stats');
                    if (response && response.ok) {
                        const stats = await response.json();
                        document.getElementById('aiChatCount').textContent = stats.ai_chat_count || 0;
                        document.getElementById('diaryEntryCount').textContent = stats.diary_entry_count || 0;
                        document.getElementById('communityPostCount').textContent = stats.community_post_count || 0;
                        document.getElementById('mostFrequentMood').textContent = stats.most_frequent_mood || '분석 중';
                    } else {
                        console.error('Dashboard stats loading failed:', response ? response.status : 'No response');
                    }
                } catch (error) {
                    console.error('Dashboard stats loading failed:', error);
                }
            }

            // NEW: 공지사항 로드
            const publicNoticesList = document.getElementById('publicNoticesList');
            const noPublicNoticesMessage = document.getElementById('noPublicNoticesMessage');

            try {
                const response = await fetch('/api/admin/notices/public'); // 토큰 없이 공개 공지사항 조회
                if (!response.ok) {
                    const errorData = await response.json();
                    publicNoticesList.innerHTML = `<p class="error-message">${errorData.message || '공지사항을 불러오는 데 실패했습니다.'}</p>`;
                    noPublicNoticesMessage.style.display = 'none';
                    return;
                }
                const data = await response.json();
                const notices = data.notices;

                publicNoticesList.innerHTML = ''; // 기존 로딩 메시지 제거

                if (notices.length === 0) {
                    noPublicNoticesMessage.style.display = 'block';
                } else {
                    notices.forEach(notice => {
                        const noticeItem = document.createElement('div');
                        noticeItem.classList.add('notice-item');
                        noticeItem.innerHTML = `
                            <h3 class="notice-title">${notice.title}</h3>
                            <p class="notice-meta">작성자: ${notice.author_nickname || '알 수 없음'} | 작성일: ${new Date(notice.created_at).toLocaleDateString()}</p>
                            <p class="notice-content">${notice.content}</p> {# NEW: 내용 전체 표시 #}
                            {# <a href="/admin/notice_management" class="read-more-notice">더보기</a> #} {# NEW: 더보기 링크 제거 #}
                        `;
                        publicNoticesList.appendChild(noticeItem);
                    });
                }
            } catch (error) {
                console.error('Public notices loading failed:', error);
                publicNoticesList.innerHTML = '<p class="error-message">공지사항을 불러오는 중 오류가 발생했습니다.</p>';
                noPublicNoticesMessage.style.display = 'none';
            }
        });
    </script>
{% endblock %}

